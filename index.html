<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ST Mobile & Designing â€” POS v19</title>
<meta name="theme-color" content="#6c63ff">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="ST Mobile POS">
<link rel="manifest" href="data:application/json;charset=utf-8,%7B%22name%22%3A%22ST%20Mobile%20POS%22%2C%22short_name%22%3A%22ST%20POS%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%230a0a1a%22%2C%22theme_color%22%3A%22%236c63ff%22%7D">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.8.4/dist/quagga.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/sql-wasm.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root{--primary:#6c63ff;--secondary:#f50057;--bg:#0a0a1a;--card:#12122a;--card2:#1a1a35;--border:#2a2a4a;--text:#e0e0ff;--muted:#7070a0;--success:#00e676;--warning:#ffab00;--danger:#ff1744;--info:#00b0ff;}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Segoe UI',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;}
#bgc{position:fixed;top:0;left:0;width:100%;height:100%;z-index:0;pointer-events:none;opacity:0.25;}
.app{display:flex;min-height:100vh;position:relative;z-index:1;}
/* Sidebar */
.sidebar{width:220px;background:var(--card);border-right:1px solid var(--border);display:flex;flex-direction:column;position:fixed;height:100vh;z-index:100;box-shadow:4px 0 20px rgba(108,99,255,0.1);}
.slogo{padding:18px 16px;border-bottom:1px solid var(--border);background:linear-gradient(135deg,rgba(108,99,255,0.2),rgba(245,0,87,0.1));}
.slogo h1{font-size:14px;color:var(--primary);font-weight:800;}
.slogo p{font-size:10px;color:var(--muted);margin-top:2px;}
.nav-sec{padding:8px 0;flex:1;overflow-y:auto;}
.nlabel{font-size:10px;color:var(--muted);padding:8px 14px 3px;text-transform:uppercase;letter-spacing:1px;}
.nitem{display:flex;align-items:center;gap:10px;padding:10px 14px;cursor:pointer;transition:0.2s;font-size:13px;color:var(--muted);border-left:3px solid transparent;}
.nitem:hover{background:rgba(108,99,255,0.1);color:var(--text);}
.nitem.active{background:rgba(108,99,255,0.15);color:var(--primary);border-left-color:var(--primary);}
.nitem .ic{font-size:17px;width:20px;text-align:center;}
.nbadge{margin-left:auto;background:var(--secondary);color:#fff;font-size:10px;padding:2px 6px;border-radius:10px;}
.sfooter{padding:10px 14px;border-top:1px solid var(--border);font-size:10px;color:var(--muted);}
/* Main */
.main{margin-left:220px;flex:1;display:flex;flex-direction:column;min-height:100vh;}
.topbar{padding:12px 20px;background:rgba(18,18,42,0.95);backdrop-filter:blur(10px);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;}
.topbar h2{font-size:17px;font-weight:700;}
.tright{display:flex;align-items:center;gap:10px;}
.clock{font-size:12px;color:var(--muted);background:var(--card2);padding:5px 12px;border-radius:20px;}
.content{padding:20px;flex:1;}
/* Stats */
.sgrid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px;}
.scard{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px;position:relative;overflow:hidden;cursor:pointer;transition:0.3s;}
.scard:hover{transform:translateY(-3px);box-shadow:0 8px 30px rgba(108,99,255,0.2);}
.scard::before{content:'';position:absolute;top:-15px;right:-15px;width:70px;height:70px;border-radius:50%;opacity:0.15;}
.scard.s1::before{background:var(--primary)}.scard.s2::before{background:var(--success)}.scard.s3::before{background:var(--warning)}.scard.s4::before{background:var(--info)}
.sval{font-size:24px;font-weight:800;margin:8px 0 4px;}
.slabel{font-size:11px;color:var(--muted);}
/* Table */
.tcard{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden;margin-bottom:18px;}
.thead2{padding:14px 18px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);}
.thead2 h3{font-size:14px;font-weight:700;}
table{width:100%;border-collapse:collapse;}
th{padding:10px 14px;font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;text-align:left;background:var(--card2);}
td{padding:10px 14px;font-size:13px;border-top:1px solid var(--border);vertical-align:middle;}
tr:hover td{background:rgba(108,99,255,0.04);}
.badge{display:inline-block;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:600;}
.bs{background:rgba(0,230,118,0.15);color:var(--success);}
.bw{background:rgba(255,171,0,0.15);color:var(--warning);}
.bd{background:rgba(255,23,68,0.15);color:var(--danger);}
.bi{background:rgba(0,176,255,0.15);color:var(--info);}
.bp{background:rgba(108,99,255,0.15);color:var(--primary);}
/* Buttons */
.btn{padding:7px 14px;border-radius:7px;border:none;cursor:pointer;font-size:13px;font-weight:600;transition:0.2s;display:inline-flex;align-items:center;gap:5px;}
.btn:hover{opacity:0.85;transform:translateY(-1px);}
.bp2{background:var(--primary);color:#fff;}
.bs2{background:rgba(0,230,118,0.15);color:var(--success);border:1px solid rgba(0,230,118,0.3);}
.bd2{background:rgba(255,23,68,0.15);color:var(--danger);border:1px solid rgba(255,23,68,0.3);}
.bo{background:transparent;border:1px solid var(--border);color:var(--text);}
.bo:hover{border-color:var(--primary);color:var(--primary);}
.bsm{padding:4px 9px;font-size:11px;}
/* Forms */
.fg{display:flex;flex-direction:column;gap:5px;margin-bottom:10px;}
.fgrid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.full{grid-column:1/-1;}
label{font-size:12px;color:var(--muted);}
input,select,textarea{background:var(--card2);border:1px solid var(--border);color:var(--text);padding:9px 11px;border-radius:7px;font-size:13px;transition:0.2s;font-family:inherit;width:100%;}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(108,99,255,0.12);}
select option{background:var(--card2);}
/* Modal */
.moverlay{position:fixed;inset:0;background:rgba(0,0,0,0.75);backdrop-filter:blur(4px);z-index:9000;display:none;align-items:center;justify-content:center;padding:16px 16px 16px 236px;}
.moverlay.open{display:flex;animation:fadeIn 0.2s;}
.modal{background:var(--card);border:1px solid var(--border);border-radius:18px;width:540px;max-width:100%;max-height:90vh;overflow-y:auto;animation:slideUp 0.25s;}
.mhdr{padding:18px 22px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:var(--card);z-index:10;}
.mhdr h3{font-size:15px;font-weight:700;}
.mbody{padding:22px;}
.mftr{padding:14px 22px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px;flex-wrap:wrap;}
.xbtn{background:none;border:none;color:var(--muted);font-size:22px;cursor:pointer;line-height:1;padding:0 4px;}
.xbtn:hover{color:var(--danger);}
/* Pages */
.page{display:none;}
.page.active{display:block;animation:fadeIn 0.3s;}
/* Invoice */
.inv-preview{background:#fff;color:#111;padding:28px;border-radius:10px;font-family:'Segoe UI',sans-serif;font-size:13px;line-height:1.8;}
.inv-preview h2{color:#6c63ff;text-align:center;margin-bottom:3px;font-size:19px;}
.inv-line{border-top:1px dashed #ccc;margin:9px 0;}
.inv-row{display:flex;justify-content:space-between;}
/* POS */
.pos-wrap{display:grid;grid-template-columns:1fr 350px;gap:18px;}
.pgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}
.pcard{background:var(--card2);border:1px solid var(--border);border-radius:11px;padding:12px;cursor:pointer;transition:0.2s;text-align:center;}
.pcard:hover{border-color:var(--primary);transform:scale(1.03);}
.picon{font-size:26px;margin-bottom:6px;}
.pname{font-size:12px;font-weight:600;}
.pprice{font-size:13px;color:var(--primary);font-weight:700;margin-top:3px;}
.pstock{font-size:10px;color:var(--muted);}
.cpanel{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;position:sticky;top:72px;display:flex;flex-direction:column;max-height:calc(100vh - 100px);}
.citems{flex:1;overflow-y:auto;margin:8px 0;}
.citem{display:flex;align-items:center;gap:7px;padding:7px 0;border-bottom:1px solid var(--border);}
.cname{flex:1;font-size:12px;}
.cqty{display:flex;align-items:center;gap:5px;}
.qbtn{width:22px;height:22px;border-radius:5px;border:1px solid var(--border);background:var(--card2);color:var(--text);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;}
.cprice{font-size:12px;font-weight:600;color:var(--primary);min-width:65px;text-align:right;}
.ctotal{border-top:1px solid var(--border);padding-top:10px;}
.trow{display:flex;justify-content:space-between;font-size:13px;margin-bottom:5px;align-items:center;}
.trow.grand{font-size:17px;font-weight:800;color:var(--primary);}
.paybtn{padding:7px;border-radius:7px;border:1px solid var(--border);background:var(--card2);color:var(--muted);cursor:pointer;font-size:12px;font-weight:600;transition:0.2s;text-align:center;}
.paybtn:hover{border-color:var(--primary);color:var(--primary);}
.paybtn.ap{background:rgba(108,99,255,0.2);border-color:var(--primary);color:var(--primary);}
.ptab{border-color:var(--border);color:var(--muted);}
.ptab.at{border-color:var(--primary);color:var(--primary);background:rgba(108,99,255,0.1);}
/* Search */
.sbar{display:flex;align-items:center;gap:8px;background:var(--card2);border:1px solid var(--border);border-radius:9px;padding:7px 12px;margin-bottom:14px;}
.sbar input{background:none;border:none;color:var(--text);font-size:13px;flex:1;padding:0;}
.sbar input:focus{outline:none;box-shadow:none;}
/* Settings */
.ssec{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px;margin-bottom:14px;}
.ssec h3{font-size:14px;font-weight:700;margin-bottom:14px;color:var(--primary);}
.cswatch{width:30px;height:30px;border-radius:7px;cursor:pointer;border:2px solid transparent;transition:0.2s;display:inline-block;margin:3px;}
.cswatch.ac{border-color:#fff;transform:scale(1.15);}
/* Toast */
.toast{position:fixed;bottom:20px;right:20px;background:var(--card);border:1px solid var(--border);border-left:3px solid var(--success);border-radius:10px;padding:12px 16px;font-size:13px;z-index:9999;animation:slideUp 0.3s;box-shadow:0 8px 30px rgba(0,0,0,0.3);display:none;max-width:300px;}
/* Keyboard shortcut badge */
.kbd{display:inline-block;background:var(--card2);border:1px solid var(--border);border-radius:5px;padding:2px 7px;font-size:11px;font-family:monospace;color:var(--primary);font-weight:700;}
/* Misc */
.g2{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.estitle{font-size:15px;font-weight:700;margin-bottom:14px;}
.empty{text-align:center;padding:30px;color:var(--muted);font-size:13px;}
.empty .ei{font-size:36px;margin-bottom:8px;}
.pbar{height:5px;background:var(--card2);border-radius:3px;overflow:hidden;margin-top:3px;}
.pfill{height:100%;border-radius:3px;transition:width 0.5s;}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.08)}}
/* PIN Lock */
#pin-screen{position:fixed;inset:0;background:var(--bg);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:18px;}
.pin-dot{width:14px;height:14px;border-radius:50%;background:var(--border);transition:0.2s;}
.pin-dot.filled{background:var(--primary);}
.pin-pad{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:8px;}
.pin-key{width:72px;height:72px;border-radius:50%;border:2px solid var(--border);background:var(--card);color:var(--text);font-size:20px;font-weight:700;cursor:pointer;transition:0.15s;display:flex;align-items:center;justify-content:center;}
.pin-key:hover{border-color:var(--primary);background:rgba(108,99,255,0.15);}
.pin-key:active{transform:scale(0.92);}
/* Notification bell */
.notif-wrap{position:relative;display:inline-flex;}
.notif-badge{position:absolute;top:-4px;right:-4px;background:var(--danger);color:#fff;font-size:9px;width:16px;height:16px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;}
/* WhatsApp btn */
.bwa{background:#25D366;color:#fff;border:none;}
.bwa:hover{background:#1da851;}
/* Due date alert */
.overdue{background:rgba(255,23,68,0.08);}
.overdue td{color:var(--danger)!important;}
/* Light mode */
body.light{--bg:#f0f2f8;--card:#ffffff;--card2:#f5f5ff;--border:#d0d0e8;--text:#111133;--muted:#6060a0;}
body.light .sidebar{box-shadow:4px 0 20px rgba(0,0,0,0.08);}
body.light .topbar{background:rgba(255,255,255,0.95);}
body.light input,body.light select,body.light textarea{color:#111133;}
body.light .inv-preview{border:1px solid #e0e0ee;}
/* Thermal 58mm receipt */
.thermal-receipt{font-family:'Courier New',monospace;font-size:11px;width:200px;padding:8px;background:#fff;color:#000;line-height:1.5;}
.thermal-receipt h2{font-size:13px;text-align:center;margin-bottom:2px;}
.thermal-receipt .tline{border-top:1px dashed #000;margin:4px 0;}
.thermal-receipt .trow{display:flex;justify-content:space-between;}
/* Barcode scan overlay */
.scan-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:9500;display:none;align-items:center;justify-content:center;flex-direction:column;gap:12px;}
.scan-overlay.open{display:flex;}
.scan-box{width:260px;height:200px;border:2px solid var(--primary);border-radius:10px;position:relative;overflow:hidden;background:#000;}
.scan-box video{width:100%;height:100%;object-fit:cover;}
.scan-line{position:absolute;top:0;left:0;right:0;height:2px;background:var(--primary);animation:scanAnim 2s linear infinite;}
@keyframes scanAnim{0%{top:0}50%{top:calc(100% - 2px)}100%{top:0}}
/* Mobile responsive */
.mob-toggle{display:none;background:none;border:none;color:var(--text);font-size:22px;cursor:pointer;padding:4px 8px;}
.sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:99;}
@media(max-width:768px){
  .mob-toggle{display:block;}
  .sidebar{transform:translateX(-100%);transition:transform 0.3s;}
  .sidebar.open{transform:translateX(0);}
  .sidebar-overlay.open{display:block;}
  .main{margin-left:0;}
  .moverlay{padding:16px;}
  .pos-wrap{grid-template-columns:1fr;}
  .sgrid{grid-template-columns:1fr 1fr;}
  .g2{grid-template-columns:1fr;}
  .fgrid{grid-template-columns:1fr;}
  .modal{width:100%!important;max-width:100%;}
}

/* ========== V19 ENHANCED ANIMATIONS & 3D EFFECTS ========== */

/* Particle background upgrade */
#bgc { opacity: 0.35; }

/* Page transitions */
.page.active {
  animation: pageSlideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
}
@keyframes pageSlideIn {
  from { opacity: 0; transform: translateY(18px) scale(0.98); }
  to   { opacity: 1; transform: translateY(0)    scale(1); }
}

/* Stat cards â€” 3D lift + glow */
.scard {
  transition: transform 0.35s cubic-bezier(0.34,1.56,0.64,1), box-shadow 0.35s ease;
  transform-style: preserve-3d;
  will-change: transform;
}
.scard:hover {
  transform: translateY(-8px) rotateX(6deg) rotateY(-3deg) scale(1.03);
  box-shadow: 0 20px 50px rgba(108,99,255,0.35), 0 0 0 1px rgba(108,99,255,0.2);
}
.scard.s1:hover { box-shadow: 0 20px 50px rgba(108,99,255,0.4); }
.scard.s2:hover { box-shadow: 0 20px 50px rgba(0,230,118,0.35); }
.scard.s3:hover { box-shadow: 0 20px 50px rgba(255,171,0,0.35); }
.scard.s4:hover { box-shadow: 0 20px 50px rgba(0,176,255,0.35); }

/* Counter animation for sval */
.sval { transition: transform 0.3s; }
.sval.counting { animation: countPulse 0.15s ease; }
@keyframes countPulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.12)} }

/* Sidebar glow */
.sidebar {
  box-shadow: 4px 0 40px rgba(108,99,255,0.18), inset -1px 0 0 rgba(108,99,255,0.15);
  background: linear-gradient(180deg, #0f0f28 0%, #12122a 100%);
}
.nitem.active {
  background: linear-gradient(90deg, rgba(108,99,255,0.22), rgba(108,99,255,0.06));
  box-shadow: inset 0 0 20px rgba(108,99,255,0.08);
  animation: sidebarGlow 2s ease-in-out infinite alternate;
}
@keyframes sidebarGlow {
  from { border-left-color: var(--primary); }
  to   { border-left-color: #a89bff; box-shadow: inset 0 0 28px rgba(108,99,255,0.14), -2px 0 15px rgba(108,99,255,0.3); }
}
.nitem {
  transition: all 0.22s cubic-bezier(0.34,1.56,0.64,1);
}
.nitem:hover {
  transform: translateX(4px);
  background: rgba(108,99,255,0.13);
  color: var(--text);
}

/* Button animations */
.btn {
  transition: all 0.22s cubic-bezier(0.34,1.56,0.64,1);
  position: relative;
  overflow: hidden;
}
.btn::after {
  content: '';
  position: absolute;
  inset: 0;
  background: rgba(255,255,255,0);
  transition: background 0.2s;
}
.btn:hover::after { background: rgba(255,255,255,0.07); }
.btn:active { transform: scale(0.95) !important; }
.bp2 { box-shadow: 0 4px 15px rgba(108,99,255,0.35); }
.bp2:hover { box-shadow: 0 8px 25px rgba(108,99,255,0.5); }

/* Modal animations */
.moverlay { transition: opacity 0.25s; }
.moverlay.open { animation: overlayFadeIn 0.25s ease; }
@keyframes overlayFadeIn { from{opacity:0} to{opacity:1} }
.modal {
  animation: modal3DIn 0.3s cubic-bezier(0.16,1,0.3,1);
  box-shadow: 0 30px 80px rgba(0,0,0,0.5), 0 0 0 1px rgba(108,99,255,0.15);
}
@keyframes modal3DIn {
  from { opacity:0; transform: scale(0.88) translateY(30px) rotateX(8deg); }
  to   { opacity:1; transform: scale(1)    translateY(0)    rotateX(0deg); }
}

/* Table row hover */
tr { transition: background 0.15s; }
tr:hover td { background: rgba(108,99,255,0.07) !important; }

/* Card hover */
.tcard {
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.tcard:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(108,99,255,0.12);
}

/* Product card in POS */
.pcard {
  transition: all 0.25s cubic-bezier(0.34,1.56,0.64,1);
}
.pcard:hover {
  transform: translateY(-6px) scale(1.05);
  box-shadow: 0 12px 35px rgba(108,99,255,0.3);
  border-color: var(--primary);
}

/* Toast enhanced */
.toast {
  animation: toastIn 0.35s cubic-bezier(0.16,1,0.3,1);
  backdrop-filter: blur(10px);
}
@keyframes toastIn {
  from { opacity:0; transform: translateX(60px) scale(0.9); }
  to   { opacity:1; transform: translateX(0)    scale(1); }
}

/* Dashboard chart containers â€” 3D card perspective */
.chart-3d-wrap {
  perspective: 1000px;
  padding: 4px;
}
.chart-3d-inner {
  transform-style: preserve-3d;
  transition: transform 0.4s ease;
  border-radius: 10px;
  overflow: hidden;
}
.chart-3d-wrap:hover .chart-3d-inner {
  transform: rotateX(3deg) rotateY(-2deg);
}

/* Glowing divider */
.glow-divider {
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--primary), var(--secondary), var(--primary), transparent);
  margin: 16px 0;
  animation: dividerFlow 3s linear infinite;
  background-size: 200% 100%;
}
@keyframes dividerFlow {
  from { background-position: 0% 0%; }
  to   { background-position: 200% 0%; }
}

/* Dashboard charts grid */
.dash-charts-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin-bottom: 16px;
}
.dash-chart-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 14px;
  overflow: hidden;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.dash-chart-card:hover {
  transform: translateY(-3px) rotateX(2deg);
  box-shadow: 0 12px 35px rgba(108,99,255,0.2);
}
.dash-chart-card.full { grid-column: 1 / -1; }
.dash-chart-title {
  padding: 12px 16px;
  font-size: 13px;
  font-weight: 700;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 8px;
}
.dash-chart-body { padding: 14px; position: relative; }

/* Sparkline numbers animated */
@keyframes numFlip {
  from { opacity:0; transform: translateY(-8px); }
  to   { opacity:1; transform: translateY(0); }
}
.sval-anim { animation: numFlip 0.4s cubic-bezier(0.16,1,0.3,1); }

/* Topbar glow */
.topbar {
  background: rgba(12,12,32,0.97) !important;
  box-shadow: 0 2px 20px rgba(108,99,255,0.1);
  border-bottom: 1px solid rgba(108,99,255,0.15) !important;
}

@media(max-width:768px){
  .dash-charts-grid { grid-template-columns: 1fr; }
}

</style>
</head>
<body>
<canvas id="bgc"></canvas>
<!-- PIN LOCK SCREEN -->
<div id="pin-screen" style="display:none">
  <div style="font-size:36px;margin-bottom:4px">ğŸ”</div>
  <div style="font-size:18px;font-weight:800;color:var(--primary)">ST Mobile POS</div>
  <div style="font-size:13px;color:var(--muted);margin-bottom:8px" id="pin-sub">PIN enter à¶šà¶»à¶±à·Šà¶±</div>
  <div style="display:flex;gap:12px;margin-bottom:8px">
    <div class="pin-dot" id="pd0"></div><div class="pin-dot" id="pd1"></div>
    <div class="pin-dot" id="pd2"></div><div class="pin-dot" id="pd3"></div>
  </div>
  <div id="pin-err" style="font-size:12px;color:var(--danger);height:16px;margin-bottom:4px"></div>
  <div class="pin-pad">
    <button class="pin-key" onclick="pinKey('1')">1</button>
    <button class="pin-key" onclick="pinKey('2')">2</button>
    <button class="pin-key" onclick="pinKey('3')">3</button>
    <button class="pin-key" onclick="pinKey('4')">4</button>
    <button class="pin-key" onclick="pinKey('5')">5</button>
    <button class="pin-key" onclick="pinKey('6')">6</button>
    <button class="pin-key" onclick="pinKey('7')">7</button>
    <button class="pin-key" onclick="pinKey('8')">8</button>
    <button class="pin-key" onclick="pinKey('9')">9</button>
    <button class="pin-key" onclick="pinKey('clr')" style="font-size:13px">CLR</button>
    <button class="pin-key" onclick="pinKey('0')">0</button>
    <button class="pin-key" onclick="pinKey('del')" style="font-size:18px">âŒ«</button>
  </div>
  <div id="pin-hint" style="margin-top:16px;font-size:11px;color:var(--muted)"></div>
</div>

<!-- NOTIFICATION PANEL -->
<div class="moverlay" id="m-notif">
  <div class="modal" style="width:480px">
    <div class="mhdr"><h3>ğŸ”” Notifications</h3><button class="xbtn" onclick="closeM('m-notif')">Ã—</button></div>
    <div class="mbody" id="notif-body" style="padding:14px"></div>
  </div>
</div>

<div class="sidebar-overlay" id="sb-overlay" onclick="toggleSidebar()"></div>
<div class="app">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="slogo"><h1>ğŸ“± ST Mobile</h1><p>&amp; Designing POS</p></div>
    <div class="nav-sec">
      <div class="nlabel">Main</div>
      <div class="nitem active" data-page="dashboard"><span class="ic">ğŸ </span><span>Dashboard</span></div>
      <div class="nitem" data-page="pos"><span class="ic">ğŸ›’</span><span>New Sale</span></div>
      <div class="nlabel">Management</div>
      <div class="nitem" data-page="inventory"><span class="ic">ğŸ“¦</span><span>Inventory</span></div>
      <div class="nitem" data-page="repairs"><span class="ic">ğŸ”§</span><span>Repairs</span><span class="nbadge" id="rbadge">0</span></div>
      <div class="nitem" data-page="orders"><span class="ic">ğŸŒ</span><span>Online Orders</span><span class="nbadge" id="obadge">0</span></div>
      <div class="nitem" data-page="customers"><span class="ic">ğŸ‘¥</span><span>Customers</span></div>
      <div class="nitem" data-page="invoices"><span class="ic">ğŸ§¾</span><span>Invoices</span></div>
      <div class="nlabel">Finance</div>
      <div class="nitem" data-page="analytics"><span class="ic">ğŸ“Š</span><span>Analytics</span></div>
      <div class="nitem" data-page="credits"><span class="ic">ğŸ’³</span><span>Credit Sales</span><span class="nbadge" id="crbadge">0</span></div>
      <div class="nlabel">Stock</div>
      <div class="nitem" data-page="suppliers"><span class="ic">ğŸ­</span><span>Suppliers</span></div>
      <div class="nitem" data-page="stocklog"><span class="ic">ğŸ“‹</span><span>Stock History</span></div>
      <div class="nlabel">Admin</div>
      <div class="nitem" data-page="settings"><span class="ic">âš™ï¸</span><span>Settings</span></div>
    </div>
    <div class="sfooter">
      <div style="margin-bottom:6px;font-size:10px;color:var(--muted)">v19 ğŸ¨ â€” ST Mobile POS</div>
      <div id="db-status-bar" style="font-size:10px;color:var(--success);margin-bottom:6px">ğŸ—„ï¸ SQLite Initializing...</div>
      <button class="btn bs2 bsm" style="width:100%;margin-bottom:5px;font-size:11px" onclick="exportSQLiteFile()">ğŸ“¥ Download .db</button>
      <button class="btn bp2 bsm" style="width:100%;margin-bottom:5px;font-size:11px" onclick="exportDB()">ğŸ“¤ JSON Backup</button>
    </div>
  </div>

  <!-- Main -->
  <div class="main">
    <div class="topbar">
      <div style="display:flex;align-items:center;gap:10px">
        <button class="mob-toggle" onclick="toggleSidebar()">â˜°</button>
        <h2 id="ptitle">Dashboard</h2>
      </div>
      <div class="tright">
        <div class="clock" id="clk"></div>
        <button class="btn bo bsm" onclick="toggleDark()" id="dark-btn" title="Dark/Light Mode [Alt+D]">ğŸŒ™</button>
        <div class="notif-wrap">
          <button class="btn bo bsm" onclick="showNotifs()" title="Notifications [Alt+N]">ğŸ””</button>
          <div class="notif-badge" id="notif-cnt" style="display:none">0</div>
        </div>
        <button class="btn bp2 bsm" onclick="goPage('pos')" title="New Sale [F2]">â• New Sale</button>
      </div>
    </div>
    <div class="content">

      <!-- DASHBOARD -->
      <div id="pg-dashboard" class="page active">
        <!-- Period Toggle -->
        <div style="display:flex;gap:6px;margin-bottom:12px;align-items:center;flex-wrap:wrap">
          <span style="font-size:12px;color:var(--muted);margin-right:4px">ğŸ“… Period:</span>
          <button class="btn bp2 bsm dash-period-btn" id="period-today" onclick="setDashPeriod('today',this)">Today</button>
          <button class="btn bo bsm dash-period-btn" id="period-monthly" onclick="setDashPeriod('monthly',this)">This Month</button>
          <button class="btn bo bsm dash-period-btn" id="period-yearly" onclick="setDashPeriod('yearly',this)">This Year</button>
          <button class="btn bo bsm dash-period-btn" id="period-all" onclick="setDashPeriod('all',this)">All Time</button>
          <span id="dash-period-label" style="font-size:11px;color:var(--primary);margin-left:4px"></span>
        </div>

        <!-- Stat Cards Row 1 -->
        <div class="sgrid">
          <div class="scard s1" onclick="goPage('invoices')" id="sc-rev">
            <div style="font-size:26px">ğŸ’°</div>
            <div class="sval" id="d-rev">Rs. 0</div>
            <div class="slabel">Total Revenue</div>
            <div id="d-rev-sub" style="font-size:9px;color:var(--muted);margin-top:2px"></div>
          </div>
          <div class="scard s2" onclick="goPage('invoices')" id="sc-sales">
            <div style="font-size:26px">ğŸ§¾</div>
            <div class="sval" id="d-sales">0</div>
            <div class="slabel">Total Sales</div>
          </div>
          <div class="scard s3" onclick="goPage('repairs')" id="sc-rep">
            <div style="font-size:26px">ğŸ”§</div>
            <div class="sval" id="d-rep">0</div>
            <div class="slabel">Active Repairs</div>
          </div>
          <div class="scard s4" onclick="goPage('orders')" id="sc-ord">
            <div style="font-size:26px">ğŸŒ</div>
            <div class="sval" id="d-ord">0</div>
            <div class="slabel">Online Orders</div>
          </div>
        </div>

        <!-- Stat Cards Row 2 - Repair Cost + Accessories -->
        <div class="sgrid" style="margin-top:10px">
          <div class="scard s3" onclick="goPage('repairs')" id="sc-repcost">
            <div style="font-size:26px">ğŸ”©</div>
            <div class="sval" id="d-repcost">Rs. 0</div>
            <div class="slabel">Repair Revenue</div>
            <div id="d-repcost-sub" style="font-size:9px;color:var(--muted);margin-top:2px"></div>
          </div>
          <div class="scard s4" onclick="goPage('inventory')" id="sc-acc">
            <div style="font-size:26px">ğŸ§</div>
            <div class="sval" id="d-acc">Rs. 0</div>
            <div class="slabel">Accessories Sales</div>
            <div id="d-acc-sub" style="font-size:9px;color:var(--muted);margin-top:2px"></div>
          </div>
          <div class="scard s1" onclick="goPage('credits')" id="sc-crbal">
            <div style="font-size:26px">ğŸ’³</div>
            <div class="sval" id="d-crbal">Rs. 0</div>
            <div class="slabel">Credit Outstanding</div>
          </div>
          <div class="scard s2" onclick="goPage('analytics')" id="sc-profit">
            <div style="font-size:26px">ğŸ“ˆ</div>
            <div class="sval" id="d-profit">Rs. 0</div>
            <div class="slabel">Est. Profit</div>
          </div>
        </div>

        <div class="glow-divider"></div>

        <!-- Monthly/Yearly Breakdown Table -->
        <div class="tcard" style="margin-bottom:16px">
          <div class="thead2">
            <h3>ğŸ“… Period Summary</h3>
            <div style="display:flex;gap:6px">
              <button class="btn bo bsm" id="breakdown-monthly-btn" onclick="setBreakdown('monthly',this)" style="border-color:var(--primary);color:var(--primary)">Monthly</button>
              <button class="btn bo bsm" id="breakdown-yearly-btn" onclick="setBreakdown('yearly',this)">Yearly</button>
            </div>
          </div>
          <div style="padding:14px;overflow-x:auto">
            <table id="breakdown-tbl" style="min-width:500px">
              <thead><tr><th id="breakdown-col1">Month</th><th>Sales Revenue</th><th>Repair Revenue</th><th>Order Revenue</th><th>Total</th></tr></thead>
              <tbody id="breakdown-tbody"></tbody>
            </table>
          </div>
        </div>
        <div class="dash-charts-grid">
          <div class="dash-chart-card">
            <div class="dash-chart-title">ğŸ“ˆ Revenue Trend (This Year)</div>
            <div class="dash-chart-body chart-3d-wrap">
              <div class="chart-3d-inner"><canvas id="d-chart-revenue" height="180"></canvas></div>
            </div>
          </div>
          <div class="dash-chart-card">
            <div class="dash-chart-title">ğŸ© Sales by Category</div>
            <div class="dash-chart-body chart-3d-wrap" style="display:flex;align-items:center;justify-content:center">
              <div class="chart-3d-inner" style="width:100%;max-width:260px"><canvas id="d-chart-donut" height="200"></canvas></div>
            </div>
          </div>
        </div>

        <!-- Charts Row 2: Monthly Bar + Stock Radar -->
        <div class="dash-charts-grid">
          <div class="dash-chart-card">
            <div class="dash-chart-title">ğŸ“Š Monthly Comparison</div>
            <div class="dash-chart-body chart-3d-wrap">
              <div class="chart-3d-inner"><canvas id="d-chart-monthly" height="180"></canvas></div>
            </div>
          </div>
          <div class="dash-chart-card">
            <div class="dash-chart-title">ğŸ•¸ï¸ Stock Levels Radar</div>
            <div class="dash-chart-body chart-3d-wrap" style="display:flex;align-items:center;justify-content:center">
              <div class="chart-3d-inner" style="width:100%;max-width:260px"><canvas id="d-chart-radar" height="200"></canvas></div>
            </div>
          </div>
        </div>

        <div class="glow-divider"></div>

        <!-- Tables Row -->
        <div class="g2">
          <div class="tcard">
            <div class="thead2"><h3>ğŸ”§ Recent Repairs</h3><button class="btn bo bsm" onclick="goPage('repairs')">View All</button></div>
            <table><thead><tr><th>Customer</th><th>Device</th><th>Status</th></tr></thead><tbody id="d-rep-tbl"></tbody></table>
          </div>
          <div class="tcard">
            <div class="thead2"><h3>ğŸŒ Recent Orders</h3><button class="btn bo bsm" onclick="goPage('orders')">View All</button></div>
            <table><thead><tr><th>Order ID</th><th>Customer</th><th>Status</th></tr></thead><tbody id="d-ord-tbl"></tbody></table>
          </div>
        </div>
        <div class="tcard"><div class="thead2"><h3>âš ï¸ Low Stock</h3></div><div id="d-lowstock"><div class="empty"><div class="ei">âœ…</div>All stock OK</div></div></div>
      </div>

      <!-- POS -->
      <div id="pg-pos" class="page">
        <div class="pos-wrap">
          <div>
            <div style="display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap">
              <div class="sbar" style="flex:1;margin:0;min-width:150px"><span>ğŸ”</span><input id="pos-q" placeholder="Search products..." oninput="renderPos()"></div>
              <button class="btn bo bsm" onclick="openBarcodeScanner()" title="Barcode Scan">ğŸ“·</button>
              <select id="pos-cat" onchange="renderPos()" style="width:140px">
                <option value="">All</option><option>Phone</option><option>Accessories</option><option>Repair Part</option><option>Design Service</option><option>Other</option>
              </select>
            </div>
            <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px">
              <button class="btn bo bsm ptab at" onclick="setPosTab('',this)">All</button>
              <button class="btn bo bsm ptab" onclick="setPosTab('Phone',this)">ğŸ“± Phones</button>
              <button class="btn bo bsm ptab" onclick="setPosTab('Accessories',this)">ğŸ§ Access.</button>
              <button class="btn bo bsm ptab" onclick="setPosTab('Repair Part',this)">ğŸ”© Parts</button>
              <button class="btn bo bsm ptab" onclick="setPosTab('Design Service',this)">ğŸ¨ Design</button>
            </div>
            <div class="pgrid" id="pos-prods"></div>
          </div>
          <div class="cpanel">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <h3 style="font-size:14px">ğŸ›’ Cart <span id="cart-cnt" style="background:var(--primary);color:#fff;font-size:10px;padding:2px 7px;border-radius:10px">0</span></h3>
              <button class="btn bd2 bsm" onclick="clearCart()">ğŸ—‘ï¸</button>
            </div>
            <div class="fg" style="position:relative">
              <label>ğŸ‘¤ Customer</label>
              <input id="cart-cust-input" placeholder="Walk-in (type to search...)" autocomplete="off"
                oninput="filterCustDrop()" onfocus="filterCustDrop()" onblur="setTimeout(function(){hideCustDrop()},180)"
                style="padding-right:28px">
              <span style="position:absolute;right:8px;top:28px;color:var(--muted);font-size:12px;pointer-events:none">â–¾</span>
              <div id="cart-cust-drop" style="display:none;position:fixed;background:var(--card);border:1px solid var(--border);border-radius:9px;z-index:9999;min-width:220px;max-height:180px;overflow-y:auto;box-shadow:0 8px 30px rgba(0,0,0,0.3);font-size:13px"></div>
              <input type="hidden" id="cart-cust">
            </div>
            <div style="background:var(--card2);border-radius:9px;padding:9px;margin-bottom:8px">
              <div style="font-size:11px;color:var(--muted);margin-bottom:5px">â• Custom Item</div>
              <div style="display:flex;gap:5px">
                <input id="ci-name" placeholder="Name" style="flex:2;padding:6px 8px;font-size:12px">
                <input id="ci-price" type="number" placeholder="Price" style="flex:1;padding:6px 8px;font-size:12px" min="0">
                <button class="btn bp2 bsm" onclick="addCustom()" style="padding:6px 10px">+</button>
              </div>
            </div>
            <div class="citems" id="cart-list"><div class="empty" style="padding:16px"><div class="ei">ğŸ›’</div>Empty cart</div></div>
            <div class="ctotal">
              <div class="trow"><span style="color:var(--muted)">Subtotal</span><span id="c-sub">Rs. 0.00</span></div>
              <div class="trow"><span style="color:var(--muted)">Discount</span><span style="display:flex;align-items:center;gap:4px"><input id="c-disc" type="number" value="0" min="0" style="width:65px;padding:3px 6px;font-size:12px" oninput="calcTotal()"><small style="color:var(--muted)">Rs</small></span></div>
              <div class="trow"><span style="color:var(--muted)">Tax</span><span style="display:flex;align-items:center;gap:4px"><input id="c-tax" type="number" value="0" min="0" max="100" style="width:65px;padding:3px 6px;font-size:12px" oninput="calcTotal()"><small style="color:var(--muted)">%</small></span></div>
              <div class="trow grand"><span>TOTAL</span><span id="c-total">Rs. 0.00</span></div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin:8px 0">
                <button class="paybtn ap" onclick="selPay('Cash',this)">ğŸ’µ Cash</button>
                <button class="paybtn" onclick="selPay('Card',this)">ğŸ’³ Card</button>
                <button class="paybtn" onclick="selPay('Bank Transfer',this)">ğŸ¦ Bank</button>
                <button class="paybtn" onclick="selPay('Online',this)">ğŸ“± Online</button>
              </div>
              <div style="display:flex;gap:6px;margin-bottom:8px;align-items:center">
                <div style="flex:1"><label style="font-size:11px;color:var(--muted)">Given</label><input id="c-given" type="number" placeholder="0.00" min="0" style="font-size:13px;padding:6px 8px" oninput="calcChange()"></div>
                <div style="flex:1;text-align:center;background:var(--card2);border-radius:7px;padding:7px">
                  <div style="font-size:10px;color:var(--muted)">Change</div>
                  <div id="c-change" style="font-size:15px;font-weight:800;color:var(--success)">Rs. 0.00</div>
                </div>
              </div>
              <button class="btn bp2" style="width:100%;padding:11px;font-size:14px" onclick="completeSale()">âœ… Complete Sale</button>
            </div>
          </div>
        </div>
      </div>

      <!-- INVENTORY -->
      <div id="pg-inventory" class="page">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
          <div class="estitle">ğŸ“¦ Inventory</div>
          <button class="btn bp2" onclick="openM('m-prod')">â• Add Product</button>
          <button class="btn bo bsm" onclick="openScannerForInventory()" title="Scan barcode to find/add product">ğŸ“· Scan Barcode</button>
        </div>
        <div class="sbar"><span>ğŸ”</span><input id="inv-q" placeholder="Search..." oninput="renderInv()"></div>
        <div class="tcard"><table><thead><tr><th>Name</th><th>Category</th><th>Barcode</th><th>Price</th><th>Stock</th><th>Actions</th></tr></thead><tbody id="inv-tbl"></tbody></table></div>
      </div>

      <!-- REPAIRS -->
      <div id="pg-repairs" class="page">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
          <div class="estitle">ğŸ”§ Repairs</div>
          <button class="btn bp2" onclick="openM('m-rep')">â• New Repair</button>
        </div>
        <div style="display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap">
          <button class="btn bo bsm" onclick="setRepF('')">All</button>
          <button class="btn bo bsm" onclick="setRepF('Pending')">â³ Pending</button>
          <button class="btn bo bsm" onclick="setRepF('In Progress')">ğŸ”„ In Progress</button>
          <button class="btn bo bsm" onclick="setRepF('Done')">âœ… Done</button>
          <button class="btn bo bsm" onclick="setRepF('Delivered')">ğŸ“¦ Delivered</button>
        </div>
        <div class="sbar"><span>ğŸ”</span><input id="rep-q" placeholder="Customer name / device search..." oninput="renderRep()"></div>
        <div class="tcard"><table><thead><tr><th>ID</th><th>Customer</th><th>Device</th><th>Issue</th><th>Cost</th><th>Status</th><th>Date</th><th>Actions</th></tr></thead><tbody id="rep-tbl"></tbody></table></div>
      </div>

      <!-- ORDERS -->
      <div id="pg-orders" class="page">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
          <div class="estitle">ğŸŒ Online Orders</div>
          <button class="btn bp2" onclick="openOrdModal()">â• New Order</button>
        </div>
        <div style="display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap">
          <button class="btn bp2 bsm ord-filter-btn" data-f="" onclick="setOrdF('')">All</button>
          <button class="btn bo bsm ord-filter-btn" data-f="status:Received" onclick="setOrdF('status:Received')">ğŸ“¥ Received</button>
          <button class="btn bo bsm ord-filter-btn" data-f="status:Processing" onclick="setOrdF('status:Processing')">âš™ï¸ Processing</button>
          <button class="btn bo bsm ord-filter-btn" data-f="status:Ready" onclick="setOrdF('status:Ready')">âœ… Ready</button>
          <button class="btn bo bsm ord-filter-btn" data-f="status:Delivered" onclick="setOrdF('status:Delivered')">ğŸ“¦ Delivered</button>
          <span style="color:var(--border);margin:0 2px">|</span>
          <button class="btn bo bsm ord-filter-btn" data-f="cat:wedding" onclick="setOrdF('cat:wedding')">ğŸ’’ Wedding</button>
          <button class="btn bo bsm ord-filter-btn" data-f="cat:wedding:Western" onclick="setOrdF('cat:wedding:Western')">ğŸ¤µ Western</button>
          <button class="btn bo bsm ord-filter-btn" data-f="cat:wedding:Kandyan" onclick="setOrdF('cat:wedding:Kandyan')">ğŸ‘˜ Kandyan</button>
          <button class="btn bo bsm ord-filter-btn" data-f="cat:ai" onclick="setOrdF('cat:ai')">ğŸ¤– AI Models</button>
          <button class="btn bo bsm ord-filter-btn" data-f="cat:design" onclick="setOrdF('cat:design')">ğŸ¨ Design</button>
          <button class="btn bo bsm ord-filter-btn" data-f="cat:other" onclick="setOrdF('cat:other')">ğŸ“¦ Other</button>
        </div>
        <div class="sbar"><span>ğŸ”</span><input id="ord-q" placeholder="Customer name / phone search..." oninput="renderOrd()"></div>
        <div class="tcard"><table><thead><tr><th>ID</th><th>Customer</th><th>Service</th><th>Amount</th><th>Status</th><th>Date</th><th>Actions</th></tr></thead><tbody id="ord-tbl"></tbody></table></div>
      </div>

      <!-- CUSTOMERS -->
      <div id="pg-customers" class="page">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
          <div class="estitle">ğŸ‘¥ Customers</div>
          <button class="btn bp2" onclick="openM('m-cust')">â• Add Customer</button>
        </div>
        <div class="sbar"><span>ğŸ”</span><input id="cust-q" placeholder="Search..." oninput="renderCust()"></div>
        <div class="tcard"><table><thead><tr><th>Name</th><th>Phone</th><th>Email</th><th>Sales</th><th>Repairs</th><th>Orders</th><th>Actions</th></tr></thead><tbody id="cust-tbl"></tbody></table></div>
      </div>

      <!-- INVOICES -->
      <div id="pg-invoices" class="page">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
          <div class="estitle">ğŸ§¾ Invoices</div>
          <div style="font-size:12px;color:var(--muted)" id="inv-count"></div>
        </div>
        <div class="sbar"><span>ğŸ”</span><input id="inv2-q" placeholder="Customer name / invoice no search..." oninput="renderInv2()"></div>
        <div class="tcard"><table><thead><tr><th>Invoice #</th><th>Customer</th><th>Items</th><th>Total</th><th>Payment</th><th>Date</th><th>Actions</th></tr></thead><tbody id="inv2-tbl"></tbody></table></div>
      </div>

      <!-- ANALYTICS -->
      <div id="pg-analytics" class="page">
        <div class="estitle">ğŸ“Š Sales Analytics</div>
        <div class="sgrid" style="margin-bottom:18px">
          <div class="scard s1"><div style="font-size:22px">ğŸ’°</div><div class="sval" id="an-rev">Rs. 0</div><div class="slabel">Total Revenue</div></div>
          <div class="scard s2"><div style="font-size:22px">ğŸ“ˆ</div><div class="sval" id="an-profit">Rs. 0</div><div class="slabel">Est. Profit</div></div>
          <div class="scard s3"><div style="font-size:22px">ğŸ§¾</div><div class="sval" id="an-sales">0</div><div class="slabel">Total Invoices</div></div>
          <div class="scard s4"><div style="font-size:22px">ğŸ‘¤</div><div class="sval" id="an-avg">Rs. 0</div><div class="slabel">Avg Sale Value</div></div>
        </div>
        <div class="g2" style="margin-bottom:18px">
          <div class="tcard">
            <div class="thead2"><h3>ğŸ“… Monthly Revenue</h3>
              <select id="an-year" onchange="renderAnalytics()" style="font-size:12px;padding:4px 8px;width:auto"></select>
            </div>
            <div style="padding:14px"><canvas id="an-chart" height="200" style="width:100%;display:block"></canvas></div>
          </div>
          <div class="tcard">
            <div class="thead2"><h3>ğŸ† Best Sellers (Top 5)</h3></div>
            <div id="an-bestsellers" style="padding:14px"></div>
          </div>
        </div>
        <div class="g2">
          <div class="tcard">
            <div class="thead2"><h3>ğŸ’³ Payment Methods</h3></div>
            <div id="an-payments" style="padding:14px"></div>
          </div>
          <div class="tcard">
            <div class="thead2"><h3>ğŸ“¦ Category Revenue</h3></div>
            <div id="an-categories" style="padding:14px"></div>
          </div>
        </div>
      </div>

      <!-- CREDIT SALES -->
      <div id="pg-credits" class="page">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
          <div class="estitle">ğŸ’³ Credit Sales</div>
          <button class="btn bp2" onclick="openCreditModal()">â• New Credit Sale</button>
        </div>
        <div style="display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap">
          <button class="btn bp2 bsm cr-fb" onclick="setCrF('',this)">All</button>
          <button class="btn bo bsm cr-fb" onclick="setCrF('Active',this)">â³ Active</button>
          <button class="btn bo bsm cr-fb" onclick="setCrF('Paid',this)">âœ… Fully Paid</button>
          <button class="btn bo bsm cr-fb" onclick="setCrF('Overdue',this)">ğŸ”´ Overdue</button>
        </div>
        <div class="sbar"><span>ğŸ”</span><input id="cr-q" placeholder="Customer name / phone..." oninput="renderCredits()"></div>
        <div class="tcard"><table><thead><tr><th>ID</th><th>Customer</th><th>Item</th><th>Total</th><th>Paid</th><th>Balance</th><th>Next Due</th><th>Status</th><th>Actions</th></tr></thead><tbody id="cr-tbl"></tbody></table></div>
      </div>

      <!-- SUPPLIERS -->
      <div id="pg-suppliers" class="page">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
          <div class="estitle">ğŸ­ Suppliers</div>
          <button class="btn bp2" onclick="openM('m-supplier')">â• Add Supplier</button>
        </div>
        <div class="sbar"><span>ğŸ”</span><input id="sup-q" placeholder="Supplier name / phone..." oninput="renderSuppliers()"></div>
        <div class="tcard"><table><thead><tr><th>Name</th><th>Phone</th><th>Category</th><th>Notes</th><th>Actions</th></tr></thead><tbody id="sup-tbl"></tbody></table></div>
        <div style="margin-top:18px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
            <div class="estitle" style="font-size:14px">ğŸ“¦ Purchase Orders</div>
            <button class="btn bp2 bsm" onclick="openM('m-purchase')">â• New Purchase</button>
          </div>
          <div class="tcard"><table><thead><tr><th>ID</th><th>Supplier</th><th>Product</th><th>Qty</th><th>Cost</th><th>Date</th><th>Status</th></tr></thead><tbody id="po-tbl"></tbody></table></div>
        </div>
      </div>

      <!-- STOCK HISTORY -->
      <div id="pg-stocklog" class="page">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
          <div class="estitle">ğŸ“‹ Stock Movement History</div>
          <select id="sl-prod-filter" onchange="renderStockLog()" style="font-size:12px;padding:5px 10px;width:200px">
            <option value="">All Products</option>
          </select>
        </div>
        <div class="tcard"><table><thead><tr><th>Date/Time</th><th>Product</th><th>Type</th><th>Change</th><th>Stock After</th><th>Reference</th></tr></thead><tbody id="sl-tbl"></tbody></table></div>
      </div>

      <!-- SETTINGS -->
      <div id="pg-settings" class="page">
        <div class="ssec"><h3>ğŸª Shop Info</h3>
          <div class="fgrid">
            <div class="fg"><label>Shop Name</label><input id="s-name" value="ST Mobile &amp; Designing"></div>
            <div class="fg"><label>Phone</label><input id="s-phone" placeholder="+94 XX XXX XXXX"></div>
            <div class="fg"><label>Email</label><input id="s-email" placeholder="shop@email.com"></div>
            <div class="fg"><label>Address</label><input id="s-addr" placeholder="Address"></div>
            <div class="fg"><label>WhatsApp</label><input id="s-wa" placeholder="+94 XX XXX XXXX"></div>
            <div class="fg"><label>Facebook</label><input id="s-fb" placeholder="facebook.com/page"></div>
          </div>
        </div>
        <div class="ssec"><h3>ğŸ” PIN Lock</h3>
          <div style="font-size:12px;color:var(--muted);margin-bottom:10px">4-digit PIN set à¶šà·…à·à¶¸ app open à¶šà¶»à¶¯à·Šà¶¯à·“ PIN à¶•à¶±à·š à·€à·™à¶±à·€à·. PIN disable à¶šà¶»à¶±à·Šà¶± blank leave à¶šà¶»à¶±à·Šà¶±.</div>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <input id="s-pin" type="password" maxlength="4" placeholder="New PIN (4 digits)" style="width:160px" oninput="this.value=this.value.replace(/[^0-9]/g,'')">
            <input id="s-pin2" type="password" maxlength="4" placeholder="Confirm PIN" style="width:160px" oninput="this.value=this.value.replace(/[^0-9]/g,'')">
            <button class="btn bp2 bsm" onclick="savePIN()">ğŸ’¾ Set PIN</button>
            <button class="btn bd2 bsm" onclick="clearPIN()">ğŸ—‘ï¸ Remove PIN</button>
          </div>
          <div id="pin-status" style="font-size:12px;margin-top:8px;color:var(--muted)"></div>
        </div>
        <div class="ssec"><h3>ğŸ¨ Theme Color</h3>
          <div>
            <span class="cswatch ac" style="background:#6c63ff" onclick="setClr('#6c63ff',this)"></span>
            <span class="cswatch" style="background:#00b894" onclick="setClr('#00b894',this)"></span>
            <span class="cswatch" style="background:#e17055" onclick="setClr('#e17055',this)"></span>
            <span class="cswatch" style="background:#0984e3" onclick="setClr('#0984e3',this)"></span>
            <span class="cswatch" style="background:#fd79a8" onclick="setClr('#fd79a8',this)"></span>
            <span class="cswatch" style="background:#fdcb6e" onclick="setClr('#fdcb6e',this)"></span>
          </div>
        </div>
        <div class="ssec"><h3>ğŸ¦ Bank Details (Order Bill)</h3>
          <div style="font-size:12px;color:var(--muted);margin-bottom:10px">Order bill Payment section à·„à·’ show à·€à·™à¶± bank details:</div>
          <div class="fgrid">
            <div class="fg"><label>Bank Name</label><input id="s-bank" placeholder="e.g. BOC Bank"></div>
            <div class="fg"><label>Account Number</label><input id="s-accno" placeholder="e.g. 92949122"></div>
            <div class="fg"><label>Account Name</label><input id="s-accname" placeholder="e.g. D T Rajapaksha"></div>
            <div class="fg"><label>Branch / Location</label><input id="s-branch" placeholder="e.g. Norochchole"></div>
          </div>
        </div>
        <div class="ssec"><h3>ğŸ§¾ Invoice</h3>
          <div class="fgrid">
            <div class="fg"><label>Prefix</label><input id="s-prefix" value="INV" maxlength="5"></div>
            <div class="fg"><label>Footer Note</label><input id="s-note" value="Thank you for choosing ST Mobile!"></div>
          </div>
        </div>
        <div class="ssec"><h3>âŒ¨ï¸ Keyboard Shortcuts</h3>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:12px;color:var(--text)">
            <div><span class="kbd">F2</span> &nbsp;New Sale (POS)</div>
            <div><span class="kbd">F3</span> &nbsp;New Online Order</div>
            <div><span class="kbd">F4</span> &nbsp;New Repair</div>
            <div><span class="kbd">F5</span> &nbsp;Dashboard</div>
            <div><span class="kbd">Alt+D</span> &nbsp;Dark/Light Mode</div>
            <div><span class="kbd">Alt+N</span> &nbsp;Notifications</div>
            <div><span class="kbd">Alt+B</span> &nbsp;Backup Export</div>
            <div><span class="kbd">Esc</span> &nbsp;Close Modal</div>
          </div>
        </div>
        <div class="ssec"><h3>ğŸ—‘ï¸ Data</h3>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn bd2" onclick="clrData('invoices')">Clear Invoices</button>
            <button class="btn bd2" onclick="clrData('repairs')">Clear Repairs</button>
            <button class="btn bd2" onclick="clrData('orders')">Clear Orders</button>
            <button class="btn bd2" onclick="clrData('all')">âš ï¸ Reset All</button>
          </div>
        </div>
        <div class="ssec"><h3>ğŸ’¾ Data Backup</h3>
          <div style="font-size:12px;color:var(--muted);margin-bottom:10px">Browser clear à·€à·“à¶¸à·™à¶±à·Š data à¶±à·à¶­à·’à·€à·š. Regular backup à¶œà¶±à·Šà¶±!</div>

          <div style="background:rgba(0,230,118,0.08);border:1px solid rgba(0,230,118,0.25);border-radius:10px;padding:12px;margin-bottom:10px">
            <div style="font-size:12px;font-weight:700;color:var(--success);margin-bottom:8px">ğŸ—„ï¸ SQLite Database Backup (.db)</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
              <button class="btn bs2" onclick="exportSQLiteFile()" style="font-size:13px">ğŸ“¥ Download .db File</button>
              <label class="btn bo" style="font-size:13px;cursor:pointer;display:inline-flex;align-items:center;gap:6px">
                ğŸ“¤ Restore .db File<input type="file" accept=".db" style="display:none" onchange="importSQLiteFile(this)">
              </label>
            </div>
            <div style="font-size:11px;color:var(--muted);margin-top:6px">SQLite .db file â€” DB Browser for SQLite software à·€à¶½à·’à¶±à·Š open à¶šà¶»à¶±à·Šà¶±à¶­à·Š à¶´à·”à·…à·”à·€à¶±à·Š!</div>
          </div>

          <div style="background:rgba(108,99,255,0.08);border:1px solid rgba(108,99,255,0.25);border-radius:10px;padding:12px;margin-bottom:10px">
            <div style="font-size:12px;font-weight:700;color:var(--primary);margin-bottom:8px">ğŸ“‹ JSON Backup (Legacy)</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
              <button class="btn bp2" onclick="exportDB()" style="font-size:13px">ğŸ“¤ Export JSON</button>
              <label class="btn bo" style="font-size:13px;cursor:pointer;display:inline-flex;align-items:center;gap:6px">
                ğŸ“¥ Import JSON<input type="file" accept=".json" style="display:none" onchange="importDB(this)">
              </label>
            </div>
          </div>

          <div style="background:rgba(255,171,0,0.1);border:1px solid rgba(255,171,0,0.3);border-radius:8px;padding:10px;font-size:12px;color:var(--warning)">
            âš ï¸ Import à¶šà¶»à¶¯à·Šà¶¯à·“ à¶¯à·à¶±à¶§ à¶­à·’à¶¶à·™à¶± <b>à·ƒà·’à¶ºà¶½à·” data replace</b> à·€à·™à¶±à·€à·. Export backup à¶‘à¶šà¶šà·Š à¶œà¶±à·Šà¶±à¶šà·œà¶§ à¶†à¶»à¶šà·Šà·‚à·’à¶­à¶ºà·’.
          </div>
        </div>
        <button class="btn bp2" onclick="saveSettings()">ğŸ’¾ Save Settings</button>
      </div>

    </div>
  </div>
</div>

<!-- MODALS -->
<!-- Product -->
<div class="moverlay" id="m-prod">
  <div class="modal">
    <div class="mhdr"><h3>ğŸ“¦ Product</h3><button class="xbtn" onclick="closeM('m-prod')">Ã—</button></div>
    <div class="mbody">
      <div class="fgrid">
        <div class="fg full"><label>Name *</label><input id="p-name" placeholder="Product name"></div>
        <div class="fg full" style="display:flex;gap:8px;align-items:flex-end"><div style="flex:1"><label>ğŸ“· Barcode</label><input id="p-barcode" placeholder="Scan or type barcode..."></div><button type="button" class="btn bp2 bsm" onclick="openScannerForInventory()" style="margin-bottom:0;white-space:nowrap;padding:9px 12px">ğŸ“· Scan</button></div>
        <div class="fg"><label>Category</label><select id="p-cat"><option>Phone</option><option>Accessories</option><option>Repair Part</option><option>Design Service</option><option>Other</option></select></div>
        <div class="fg"><label>Sell Price (Rs.)</label><input id="p-price" type="number" min="0"></div>
        <div class="fg"><label>Cost Price (Rs.)</label><input id="p-cost" type="number" min="0"></div>
        <div class="fg"><label>Stock</label><input id="p-stock" type="number" value="1" min="0"></div>
        <div class="fg"><label>Min Stock Alert</label><input id="p-min" type="number" value="2" min="0"></div>
        <div class="fg full"><label>Description</label><textarea id="p-desc" rows="2"></textarea></div>
      </div>
      <input type="hidden" id="p-id">
    </div>
    <div class="mftr"><button class="btn bo" onclick="closeM('m-prod')">Cancel</button><button class="btn bp2" onclick="saveProd()">ğŸ’¾ Save</button></div>
  </div>
</div>

<!-- Repair -->
<div class="moverlay" id="m-rep">
  <div class="modal">
    <div class="mhdr"><h3>ğŸ”§ Repair Order</h3><button class="xbtn" onclick="closeM('m-rep')">Ã—</button></div>
    <div class="mbody">
      <div class="fgrid">
        <div class="fg"><label>Customer *</label><input id="r-cust" placeholder="Name"></div>
        <div class="fg"><label>Phone</label><input id="r-phone" placeholder="07X XXX XXXX"></div>
        <div class="fg"><label>Device *</label><input id="r-dev" placeholder="e.g. iPhone 13"></div>
        <div class="fg"><label>IMEI / Serial</label><input id="r-imei"></div>
        <div class="fg full"><label>Issue *</label><textarea id="r-issue" rows="2"></textarea></div>
        <div class="fg"><label>Cost (Rs.)</label><input id="r-cost" type="number" min="0"></div>
        <div class="fg"><label>Status</label><select id="r-status"><option>Pending</option><option>In Progress</option><option>Done</option><option>Delivered</option></select></div>
        <div class="fg"><label>â° Due Date</label><input id="r-due" type="date"></div>
        <div class="fg"><label>Advance Paid (Rs.)</label><input id="r-adv" type="number" min="0" placeholder="0.00"></div>
        <div class="fg full"><label>Notes</label><textarea id="r-notes" rows="2"></textarea></div>
      </div>
      <input type="hidden" id="r-id">
    </div>
    <div class="mftr"><button class="btn bo" onclick="closeM('m-rep')">Cancel</button><button class="btn bp2" onclick="saveRep()">ğŸ’¾ Save</button></div>
  </div>
</div>

<!-- Order -->
<div class="moverlay" id="m-ord">
  <div class="modal" style="width:620px">
    <div class="mhdr"><h3>ğŸŒ Online Order</h3><button class="xbtn" onclick="closeM('m-ord')">Ã—</button></div>
    <div class="mbody">
      <div class="fgrid" style="margin-bottom:10px">
        <div class="fg"><label>Customer *</label><input id="o-cust" placeholder="Name"></div>
        <div class="fg"><label>Phone *</label><input id="o-phone" placeholder="07X XXX XXXX"></div>
        <div class="fg"><label>Platform</label><select id="o-plat"><option>Facebook</option><option>WhatsApp</option><option>Instagram</option><option>Walk-in</option><option>Other</option></select></div>
        <div class="fg"><label>Status</label><select id="o-stat"><option>Received</option><option>Processing</option><option>Ready</option><option>Delivered</option></select></div>
      </div>
      <div style="background:var(--card2);border-radius:10px;padding:12px;margin-bottom:10px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div style="font-size:13px;font-weight:700;color:var(--primary)">ğŸ“‹ Order Items</div>
          <button class="btn bp2 bsm" onclick="addOrdItem()" type="button">â• Item Add</button>
        </div>
        <div id="o-items-list"></div>
      </div>
      <div style="background:var(--card2);border-radius:8px;padding:12px;margin-bottom:10px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <span style="font-size:13px;color:var(--muted)">Items Subtotal:</span>
          <span id="o-subtotal-display" style="font-size:14px;font-weight:700">Rs. 0.00</span>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <span style="font-size:13px;color:var(--muted)">ğŸšš Delivery Charge:</span>
          <input id="o-delivery" type="number" min="0" value="0" placeholder="0.00" style="width:110px;padding:5px 8px;font-size:13px;text-align:right" oninput="calcOrdTotal()">
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;border-top:1px solid var(--border);padding-top:8px">
          <span style="font-size:14px;font-weight:700">Total:</span>
          <span id="o-total-display" style="font-size:18px;font-weight:800;color:var(--primary)">Rs. 0.00</span>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div class="fg"><label>â° Delivery Date</label><input id="o-due" type="date"></div>
        <div class="fg"><label>ğŸ’µ Advance Paid (Rs.)</label><input id="o-adv" type="number" min="0" placeholder="0.00"></div>
      </div>
      <div class="fg"><label>Notes</label><textarea id="o-notes" rows="2"></textarea></div>
      <input type="hidden" id="o-id">
    </div>
    <div class="mftr"><button class="btn bo" onclick="closeM('m-ord')">Cancel</button><button class="btn bp2" onclick="saveOrd()">ğŸ’¾ Save Order</button></div>
  </div>
</div>
<!-- Customer History Modal -->
<div class="moverlay" id="m-cust-hist">
  <div class="modal" style="width:580px">
    <div class="mhdr"><h3 id="cust-hist-title">ğŸ“‹ Customer History</h3><button class="xbtn" onclick="closeM('m-cust-hist')">Ã—</button></div>
    <div class="mbody" id="cust-hist-body" style="padding:14px"></div>
  </div>
</div>

<!-- Customer -->
<div class="moverlay" id="m-cust">
  <div class="modal">
    <div class="mhdr"><h3>ğŸ‘¤ Customer</h3><button class="xbtn" onclick="closeM('m-cust')">Ã—</button></div>
    <div class="mbody">
      <div class="fgrid">
        <div class="fg"><label>Name *</label><input id="cu-name" placeholder="Full name"></div>
        <div class="fg"><label>Phone *</label><input id="cu-phone" placeholder="07X XXX XXXX"></div>
        <div class="fg"><label>Email</label><input id="cu-email"></div>
        <div class="fg"><label>Address</label><input id="cu-addr"></div>
        <div class="fg full"><label>Notes</label><textarea id="cu-notes" rows="2"></textarea></div>
      </div>
      <input type="hidden" id="cu-id">
    </div>
    <div class="mftr"><button class="btn bo" onclick="closeM('m-cust')">Cancel</button><button class="btn bp2" onclick="saveCust()">ğŸ’¾ Save</button></div>
  </div>
</div>

<!-- Invoice Modal -->
<div class="moverlay" id="m-inv">
  <div class="modal" style="width:500px">
    <div class="mhdr"><h3>ğŸ§¾ Invoice</h3><button class="xbtn" onclick="closeM('m-inv')">Ã—</button></div>
    <div class="mbody"><div class="inv-preview" id="inv-content"></div></div>
    <div class="mftr">
      <button class="btn bo" onclick="closeM('m-inv')">âœ• Close</button>
      <button class="btn bo" onclick="doPrint('inv-content')">ğŸ–¨ï¸ Print</button>
      <button class="btn bo bsm" onclick="showThermalReceipt(currentInvId)" title="58mm Thermal Receipt">ğŸ§¾ Thermal</button>
      <button class="btn bs2" onclick="doPNG('inv-content','invoice')">ğŸ–¼ï¸ PNG</button>
      <button class="btn bp2" onclick="doPDF('inv-content','Invoice')">ğŸ“„ PDF</button>
    </div>
  </div>
</div>

<!-- Repair Bill Modal -->
<div class="moverlay" id="m-rbill">
  <div class="modal" style="width:500px">
    <div class="mhdr"><h3>ğŸ§¾ Repair Bill</h3><button class="xbtn" onclick="closeM('m-rbill')">Ã—</button></div>
    <div class="mbody"><div class="inv-preview" id="rbill-content"></div></div>
    <div class="mftr">
      <button class="btn bo" onclick="closeM('m-rbill')">âœ• Close</button>
      <button class="btn bo" onclick="doPrint('rbill-content')">ğŸ–¨ï¸ Print</button>
      <button class="btn bs2" onclick="doPNG('rbill-content','repair-bill')">ğŸ–¼ï¸ PNG</button>
      <button class="btn bp2" onclick="doPDF('rbill-content','Repair-Bill')">ğŸ“„ PDF</button>
      <button class="btn bwa bsm" onclick="waShareRepBill()" title="WhatsApp Share">ğŸ’¬ WhatsApp</button>
    </div>
  </div>
</div>

<!-- Order Bill Modal -->
<div class="moverlay" id="m-obill">
  <div class="modal" style="width:500px">
    <div class="mhdr"><h3>ğŸ§¾ Order Bill</h3><button class="xbtn" onclick="closeM('m-obill')">Ã—</button></div>
    <div class="mbody"><div class="inv-preview" id="obill-content"></div></div>
    <div class="mftr">
      <button class="btn bo" onclick="closeM('m-obill')">âœ• Close</button>
      <button class="btn bo" onclick="doPrint('obill-content')">ğŸ–¨ï¸ Print</button>
      <button class="btn bs2" onclick="doPNG('obill-content','order-bill')">ğŸ–¼ï¸ PNG</button>
      <button class="btn bp2" onclick="doPDF('obill-content','Order-Bill')">ğŸ“„ PDF</button>
      <button class="btn bwa bsm" onclick="waShareBill()" title="WhatsApp Share">ğŸ’¬ WhatsApp</button>
    </div>
  </div>
</div>

<!-- Order Payment Modal -->
<div class="moverlay" id="m-pay">
  <div class="modal">
    <div class="mhdr"><h3>ğŸ’³ Receive Payment</h3><button class="xbtn" onclick="closeM('m-pay')">Ã—</button></div>
    <div class="mbody">
      <div style="background:var(--card2);border-radius:10px;padding:12px;margin-bottom:14px">
        <div style="font-size:11px;color:var(--muted);margin-bottom:6px">ORDER SUMMARY</div>
        <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:3px">
          <span id="py-id" style="color:var(--primary);font-weight:700"></span><span id="py-stat"></span>
        </div>
        <div style="font-size:13px;margin-bottom:2px"><b>Customer:</b> <span id="py-cust"></span> â€” <span id="py-phone" style="color:var(--muted)"></span></div>
        <div style="font-size:13px"><b>Service:</b> <span id="py-svc"></span></div>
        <div style="display:flex;justify-content:space-between;margin-top:8px;padding-top:8px;border-top:1px solid var(--border)">
          <span style="font-size:14px;font-weight:700">Total</span>
          <span id="py-total" style="font-size:20px;font-weight:800;color:var(--primary)"></span>
        </div>
      </div>
      <div class="fgrid">
        <div class="fg"><label>Amount Received (Rs.) *</label><input id="py-amt" type="number" min="0" placeholder="0.00" oninput="calcPay()"></div>
        <div class="fg"><label>Date</label><input id="py-date" type="date"></div>
        <div class="fg full"><label>Payment Method</label>
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-top:4px">
            <button class="paybtn ap" onclick="selOPay('Cash',this)">ğŸ’µ Cash</button>
            <button class="paybtn" onclick="selOPay('Card',this)">ğŸ’³ Card</button>
            <button class="paybtn" onclick="selOPay('Bank Transfer',this)">ğŸ¦ Bank</button>
            <button class="paybtn" onclick="selOPay('Online',this)">ğŸ“± Online</button>
          </div>
        </div>
      </div>
      <div style="background:var(--card2);border-radius:10px;padding:12px;margin-top:10px">
        <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:5px"><span style="color:var(--muted)">Order Total</span><span id="pc-tot"></span></div>
        <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:5px"><span style="color:var(--muted)">Previously Paid</span><span id="pc-prev" style="color:var(--success)"></span></div>
        <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:5px"><span style="color:var(--muted)">This Payment</span><span id="pc-this" style="color:var(--info)"></span></div>
        <div style="display:flex;justify-content:space-between;font-size:15px;font-weight:800;border-top:1px solid var(--border);padding-top:8px"><span>Balance</span><span id="pc-bal" style="color:var(--warning)"></span></div>
      </div>
      <div class="fg" style="margin-top:10px"><label>Note</label><input id="py-note" placeholder="e.g. Advance, Full payment..."></div>
      <input type="hidden" id="py-ord-id">
    </div>
    <div class="mftr">
      <button class="btn bo" onclick="closeM('m-pay')">Cancel</button>
      <button class="btn bp2" onclick="savePayment(false)">ğŸ’¾ Save</button>
      <button class="btn bs2" onclick="savePayment(true)">ğŸ’¾ Save &amp; Bill</button>
    </div>
  </div>
</div>

<!-- Credit Sale Modal -->
<div class="moverlay" id="m-credit">
  <div class="modal" style="width:560px">
    <div class="mhdr"><h3>ğŸ’³ New Credit Sale</h3><button class="xbtn" onclick="closeM('m-credit')">Ã—</button></div>
    <div class="mbody">
      <div class="fgrid">
        <div class="fg"><label>Customer Name *</label><input id="cr-cust" placeholder="Name"></div>
        <div class="fg"><label>Phone *</label><input id="cr-phone" placeholder="07X XXX XXXX"></div>
        <div class="fg"><label>NIC / ID</label><input id="cr-nic" placeholder="NIC number"></div>
        <div class="fg"><label>Item / Product *</label><input id="cr-item" placeholder="e.g. iPhone 14 Pro"></div>
        <div class="fg"><label>Total Price (Rs.) *</label><input id="cr-total" type="number" min="0" placeholder="0.00" oninput="calcCreditInstall()"></div>
        <div class="fg"><label>Down Payment (Rs.)</label><input id="cr-down" type="number" min="0" placeholder="0.00" value="0" oninput="calcCreditInstall()"></div>
        <div class="fg"><label>Installments Count</label><input id="cr-inst" type="number" min="1" max="36" value="3" oninput="calcCreditInstall()"></div>
        <div class="fg"><label>Frequency</label><select id="cr-freq"><option value="monthly">Monthly</option><option value="weekly">Weekly</option></select></div>
        <div class="fg"><label>First Due Date</label><input id="cr-due" type="date"></div>
        <div class="fg full"><div style="background:var(--card2);border-radius:9px;padding:10px">
          <div style="font-size:11px;color:var(--muted);margin-bottom:5px">CALCULATION</div>
          <div id="cr-calc" style="font-size:13px;line-height:1.8;color:var(--text)">â€”</div>
        </div></div>
        <div class="fg full"><label>Notes</label><textarea id="cr-notes" rows="2"></textarea></div>
      </div>
      <input type="hidden" id="cr-id">
    </div>
    <div class="mftr"><button class="btn bo" onclick="closeM('m-credit')">Cancel</button><button class="btn bp2" onclick="saveCredit()">ğŸ’¾ Save Credit Sale</button></div>
  </div>
</div>

<!-- Credit Payment Modal -->
<div class="moverlay" id="m-crpay">
  <div class="modal">
    <div class="mhdr"><h3>ğŸ’µ Record Installment Payment</h3><button class="xbtn" onclick="closeM('m-crpay')">Ã—</button></div>
    <div class="mbody">
      <div id="crpay-summary" style="background:var(--card2);border-radius:9px;padding:12px;margin-bottom:12px;font-size:13px"></div>
      <div class="fgrid">
        <div class="fg"><label>Amount Paid (Rs.) *</label><input id="crpay-amt" type="number" min="0" placeholder="0.00"></div>
        <div class="fg"><label>Date</label><input id="crpay-date" type="date"></div>
        <div class="fg"><label>Method</label><select id="crpay-method"><option>Cash</option><option>Bank Transfer</option><option>Online</option></select></div>
        <div class="fg"><label>Note</label><input id="crpay-note" placeholder="e.g. Installment 2/6"></div>
      </div>
      <input type="hidden" id="crpay-id">
    </div>
    <div class="mftr"><button class="btn bo" onclick="closeM('m-crpay')">Cancel</button><button class="btn bp2" onclick="saveCrPayment()">ğŸ’¾ Save Payment</button></div>
  </div>
</div>

<!-- Supplier Modal -->
<div class="moverlay" id="m-supplier">
  <div class="modal">
    <div class="mhdr"><h3>ğŸ­ Supplier</h3><button class="xbtn" onclick="closeM('m-supplier')">Ã—</button></div>
    <div class="mbody">
      <div class="fgrid">
        <div class="fg"><label>Name *</label><input id="sup-name" placeholder="Supplier name"></div>
        <div class="fg"><label>Phone *</label><input id="sup-phone" placeholder="07X XXX XXXX"></div>
        <div class="fg"><label>Email</label><input id="sup-email" placeholder="supplier@email.com"></div>
        <div class="fg"><label>Category</label><select id="sup-cat"><option>Phone</option><option>Accessories</option><option>Repair Part</option><option>Mixed</option><option>Other</option></select></div>
        <div class="fg full"><label>Address</label><input id="sup-addr" placeholder="Address"></div>
        <div class="fg full"><label>Notes</label><textarea id="sup-notes" rows="2"></textarea></div>
      </div>
      <input type="hidden" id="sup-id">
    </div>
    <div class="mftr"><button class="btn bo" onclick="closeM('m-supplier')">Cancel</button><button class="btn bp2" onclick="saveSupplier()">ğŸ’¾ Save</button></div>
  </div>
</div>

<!-- Purchase Order Modal -->
<div class="moverlay" id="m-purchase">
  <div class="modal">
    <div class="mhdr"><h3>ğŸ“¦ Purchase Order</h3><button class="xbtn" onclick="closeM('m-purchase')">Ã—</button></div>
    <div class="mbody">
      <div class="fgrid">
        <div class="fg"><label>Supplier *</label><select id="po-sup"><option value="">Select Supplier</option></select></div>
        <div class="fg"><label>Product *</label><select id="po-prod"><option value="">Select Product</option></select></div>
        <div class="fg"><label>Quantity *</label><input id="po-qty" type="number" min="1" value="1"></div>
        <div class="fg"><label>Cost Per Unit (Rs.)</label><input id="po-cost" type="number" min="0" placeholder="0.00"></div>
        <div class="fg"><label>Date</label><input id="po-date" type="date"></div>
        <div class="fg"><label>Status</label><select id="po-stat"><option>Ordered</option><option>Received</option><option>Cancelled</option></select></div>
        <div class="fg full"><label>Notes</label><textarea id="po-notes" rows="2"></textarea></div>
      </div>
    </div>
    <div class="mftr"><button class="btn bo" onclick="closeM('m-purchase')">Cancel</button><button class="btn bp2" onclick="savePurchase()">ğŸ’¾ Save Order</button></div>
  </div>
</div>

<!-- Barcode Scanner Overlay -->
<div class="scan-overlay" id="scan-overlay">
  <div style="color:#fff;font-size:16px;font-weight:700;letter-spacing:0.5px">ğŸ“· Barcode Scanner</div>
  <div id="scan-mode-label" style="color:var(--primary);font-size:12px;background:rgba(108,99,255,0.25);padding:4px 16px;border-radius:20px"></div>
  <div class="scan-box" id="scan-box-wrap">
    <video id="scan-video" playsinline muted autoplay style="width:100%;height:100%;object-fit:cover;border-radius:8px"></video>
    <canvas id="scan-canvas" style="display:none"></canvas>
    <div class="scan-line"></div>
    <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:200px;height:80px;border:2px solid rgba(108,99,255,0.8);border-radius:6px;pointer-events:none;box-shadow:0 0 0 9999px rgba(0,0,0,0.35)"></div>
  </div>
  <div id="scan-no-cam" style="display:none;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:12px;padding:16px 24px;text-align:center;max-width:300px">
    <div style="font-size:26px;margin-bottom:8px">ğŸ“µ</div>
    <div style="color:#fff;font-size:13px;font-weight:600;margin-bottom:6px">Camera access à¶±à·‘</div>
    <div style="color:rgba(255,255,255,0.5);font-size:11px;line-height:1.8">
      file:// protocol à·„à·’à¶¯à·“ camera block à·€à·š.<br>
      <span style="color:rgba(255,210,80,0.9);font-weight:600">Physical barcode scanner</span> connect à¶šà¶»<br>
      scan à¶šà·…à·à¶¸ auto-detect à·€à·š ğŸ‘‡<br>
      <span style="color:rgba(255,255,255,0.35)">à·„à· manually type à¶šà¶»à¶±à·Šà¶±</span>
    </div>
  </div>
  <div id="scan-result" style="font-size:13px;min-height:20px;color:var(--success);text-align:center;max-width:320px;font-weight:600"></div>
  <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:center">
    <input id="scan-manual" placeholder="Barcode type / scan à¶šà¶»à¶±à·Šà¶±..."
      style="background:rgba(255,255,255,0.1);border:1.5px solid rgba(108,99,255,0.6);color:#fff;padding:10px 14px;border-radius:10px;font-size:14px;width:220px;outline:none"
      onkeydown="if(event.key==='Enter')doManualScan()"
      oninput="onScanInput(this)">
    <button class="btn bp2" onclick="doManualScan()" style="padding:10px 14px">ğŸ”</button>
    <button class="btn bd2" onclick="closeBarcodeScanner()" style="padding:10px 14px">âœ•</button>
  </div>
  <div style="font-size:11px;color:rgba(255,255,255,0.35);text-align:center">USB/Bluetooth scanner â†’ auto detect &nbsp;|&nbsp; Manual â†’ Enter</div>
</div>

<!-- Thermal Receipt Modal -->
<div class="moverlay" id="m-thermal">
  <div class="modal" style="width:320px">
    <div class="mhdr"><h3>ğŸ–¨ï¸ Thermal Receipt (58mm)</h3><button class="xbtn" onclick="closeM('m-thermal')">Ã—</button></div>
    <div class="mbody" style="display:flex;justify-content:center">
      <div id="thermal-content" class="thermal-receipt"></div>
    </div>
    <div class="mftr">
      <button class="btn bo" onclick="closeM('m-thermal')">âœ• Close</button>
      <button class="btn bp2" onclick="doPrint('thermal-content')">ğŸ–¨ï¸ Print</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// =========== DATA ===========
var db = { products:[], repairs:[], orders:[], customers:[], invoices:[], credits:[], suppliers:[], purchases:[], stockLog:[],
  settings:{ shopName:'ST Mobile & Designing', phone:'', email:'', address:'', whatsapp:'', fb:'', prefix:'INV', note:'Thank you for choosing ST Mobile!', theme:'#6c63ff' }
};
var cart = [];
var selPayment = 'Cash';
var selOPayment = 'Cash';
var repF = '';
var ordF = '';

var SVC_OPTS = {
  wedding: { label:'Wedding Style', opts:['Western','Kandyan','Both'] },
  ai:      { label:'AI Model Type', opts:['Portrait','Full Body','Fashion','Couple','Family','Other'] },
  design:  { label:'Design Type',   opts:['Logo','Banner','Flyer','Business Card','Social Media Post','Album Cover','Other'] },
  other:   { label:'Service Type',  opts:['Mobile Repair','Accessories','Other'] }
};
var FRAME_SIZES = ['4R (4Ã—6 inch)','5R (5Ã—7 inch)','6R (6Ã—8 inch)','8R (8Ã—10 inch)','10R (10Ã—12 inch)','A4 (8.3Ã—11.7 inch)','A3 (11.7Ã—16.5 inch)','12Ã—18 inch','16Ã—20 inch','20Ã—24 inch','Custom Size'];
var CAT_ICONS  = { wedding:'ğŸ’’', ai:'ğŸ¤–', design:'ğŸ¨', other:'ğŸ“¦', '':'' };
var CAT_LABELS = { wedding:'Wedding Photos', ai:'AI Models', design:'Graphic Design', other:'Other', '':'' };

// =========== MULTI-ITEM ORDER SYSTEM ===========
var ordItems = []; // [{cat, sub, frameSize, desc, amount}]

function itemRowHTML(idx, item){
  var cat = item.cat||'';
  var catOpts = ['wedding','ai','design','other'].map(function(c){
    return '<option value="'+c+'"'+(cat===c?' selected':'')+'>'+CAT_ICONS[c]+' '+CAT_LABELS[c]+'</option>';
  }).join('');
  var subOpts = (SVC_OPTS[cat]||{opts:[]}).opts.map(function(o){
    return '<option'+(item.sub===o?' selected':'')+'>'+o+'</option>';
  }).join('');
  var frameOpts = FRAME_SIZES.map(function(f){
    return '<option'+(item.frameSize===f?' selected':'')+'>'+f+'</option>';
  }).join('');
  var showSub = cat && SVC_OPTS[cat] ? 'block':'none';
  var showFrame = cat==='wedding' ? 'block':'none';
  var showCustom = item.frameSize==='Custom Size' ? 'block':'none';

  return '<div class="ord-item-row" id="orow-'+idx+'" style="background:var(--card);border:1px solid var(--border);border-radius:9px;padding:10px;margin-bottom:8px">'+
    '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">'+
      '<span style="font-size:12px;font-weight:700;color:var(--primary)">Item '+(idx+1)+'</span>'+
      '<button class="btn bd2 bsm" onclick="removeOrdItem('+idx+')" type="button">ğŸ—‘ï¸</button>'+
    '</div>'+
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">'+
      '<div class="fg" style="margin:0"><label style="font-size:11px">Category</label>'+
        '<select onchange="onItemCatChange('+idx+',this)" style="font-size:12px;padding:6px 8px">'+
          '<option value="">-- Select --</option>'+catOpts+
        '</select>'+
      '</div>'+
      '<div class="fg" id="orow-sub-'+idx+'" style="margin:0;display:'+showSub+'"><label style="font-size:11px">Sub Type</label>'+
        '<select onchange="onItemSubChange('+idx+',this)" style="font-size:12px;padding:6px 8px">'+subOpts+'</select>'+
      '</div>'+
      '<div class="fg" id="orow-frame-'+idx+'" style="margin:0;display:'+showFrame+';grid-column:1/-1"><label style="font-size:11px">ğŸ–¼ï¸ Frame Size</label>'+
        '<select onchange="onItemFrameChange('+idx+',this)" style="font-size:12px;padding:6px 8px">'+
          '<option value="">-- Select --</option>'+frameOpts+
        '</select>'+
        '<input id="orow-fcustom-'+idx+'" placeholder="Custom size..." style="margin-top:5px;font-size:12px;padding:6px 8px;display:'+showCustom+'" value="'+(item.frameCustom||'')+'" oninput="onItemFrameCustom('+idx+',this)">'+
      '</div>'+
      '<div class="fg" style="margin:0;grid-column:1/-1"><label style="font-size:11px">Description</label>'+
        '<input value="'+(item.desc||'')+'" placeholder="Service detail..." style="font-size:12px;padding:6px 8px" oninput="onItemDesc('+idx+',this)">'+
      '</div>'+
      '<div class="fg" style="margin:0"><label style="font-size:11px">Amount (Rs.)</label>'+
        '<input type="number" min="0" value="'+(item.amount||'')+'" placeholder="0.00" style="font-size:12px;padding:6px 8px" oninput="onItemAmt('+idx+',this)">'+
      '</div>'+
    '</div>'+
  '</div>';
}

function renderOrdItems(){
  var el=document.getElementById('o-items-list'); if(!el) return;
  if(ordItems.length===0){
    el.innerHTML='<div style="text-align:center;color:var(--muted);font-size:12px;padding:12px">â• Item Add à¶šà¶»à¶±à·Šà¶±</div>';
  } else {
    el.innerHTML=ordItems.map(function(item,i){ return itemRowHTML(i,item); }).join('');
  }
  calcOrdTotal();
}

function calcOrdTotal(){
  var sub=ordItems.reduce(function(s,i){ return s+(parseFloat(i.amount)||0); },0);
  var delivery=parseFloat(document.getElementById('o-delivery')?document.getElementById('o-delivery').value:0)||0;
  var total=sub+delivery;
  var subEl=document.getElementById('o-subtotal-display');
  if(subEl) subEl.textContent='Rs. '+sub.toFixed(2);
  var el=document.getElementById('o-total-display');
  if(el) el.textContent='Rs. '+total.toFixed(2);
}

function addOrdItem(){
  ordItems.push({cat:'',sub:'',frameSize:'',frameCustom:'',desc:'',amount:''});
  renderOrdItems();
}
function removeOrdItem(idx){
  ordItems.splice(idx,1);
  renderOrdItems();
}
function onItemCatChange(idx,sel){
  ordItems[idx].cat=sel.value;
  ordItems[idx].sub='';
  ordItems[idx].frameSize='';
  ordItems[idx].frameCustom='';
  renderOrdItems();
}
function onItemSubChange(idx,sel){
  ordItems[idx].sub=sel.value;
  autoFillItemDesc(idx);
}
function onItemFrameChange(idx,sel){
  ordItems[idx].frameSize=sel.value;
  var cEl=document.getElementById('orow-fcustom-'+idx);
  if(cEl) cEl.style.display=sel.value==='Custom Size'?'block':'none';
  autoFillItemDesc(idx);
}
function onItemFrameCustom(idx,inp){
  ordItems[idx].frameCustom=inp.value;
  autoFillItemDesc(idx);
}
function onItemDesc(idx,inp){ ordItems[idx].desc=inp.value; }
function onItemAmt(idx,inp){ ordItems[idx].amount=inp.value; calcOrdTotal(); }

function autoFillItemDesc(idx){
  var item=ordItems[idx];
  var base=(CAT_LABELS[item.cat]||'')+' â€” '+(item.sub||'');
  if(item.cat==='wedding'){
    var frame=item.frameSize==='Custom Size'?(item.frameCustom||'Custom Size'):item.frameSize;
    base+= frame ? ' | Frame: '+frame : '';
  }
  ordItems[idx].desc=base;
  // update desc input if visible
  var rows=document.querySelectorAll('#orow-'+idx+' input');
  rows.forEach(function(inp){
    if(inp.placeholder==='Service detail...') inp.value=base;
  });
}

function openOrdModal(){
  ordItems=[{cat:'',sub:'',frameSize:'',frameCustom:'',desc:'',amount:''}];
  document.getElementById('o-id').value='';
  document.getElementById('o-cust').value='';
  document.getElementById('o-phone').value='';
  document.getElementById('o-plat').value='Facebook';
  document.getElementById('o-stat').value='Received';
  document.getElementById('o-notes').value='';
  var dEl=document.getElementById('o-delivery'); if(dEl) dEl.value=0;
  var duEl=document.getElementById('o-due'); if(duEl) duEl.value='';
  var advEl=document.getElementById('o-adv'); if(advEl) advEl.value='';
  renderOrdItems();
  openM('m-ord');
}

// =========== SQLITE + INDEXEDDB STORAGE ===========
var sqlDB = null;
var SQL = null;
var IDB_NAME = 'st-pos-idb';
var IDB_STORE = 'sqlitedb';
var IDB_KEY = 'main';

// Open IndexedDB
function openIDB() {
  return new Promise(function(resolve, reject) {
    var req = indexedDB.open(IDB_NAME, 1);
    req.onupgradeneeded = function(e) {
      e.target.result.createObjectStore(IDB_STORE);
    };
    req.onsuccess = function(e) { resolve(e.target.result); };
    req.onerror = function(e) { reject(e); };
  });
}

// Save SQLite binary to IndexedDB
function persistSQLite() {
  if (!sqlDB) return;
  try {
    var data = sqlDB.export();
    openIDB().then(function(idb) {
      var tx = idb.transaction(IDB_STORE, 'readwrite');
      tx.objectStore(IDB_STORE).put(data, IDB_KEY);
    }).catch(function(e) { console.warn('IDB persist error:', e); });
  } catch(e) { console.warn('SQLite export error:', e); }
}

// Load SQLite binary from IndexedDB
function loadFromIDB() {
  return new Promise(function(resolve) {
    openIDB().then(function(idb) {
      var tx = idb.transaction(IDB_STORE, 'readonly');
      var req = tx.objectStore(IDB_STORE).get(IDB_KEY);
      req.onsuccess = function(e) { resolve(e.target.result || null); };
      req.onerror = function() { resolve(null); };
    }).catch(function() { resolve(null); });
  });
}

// Create all tables
function createTables() {
  sqlDB.run("CREATE TABLE IF NOT EXISTS settings (key TEXT PRIMARY KEY, value TEXT);");
  sqlDB.run("CREATE TABLE IF NOT EXISTS products (id INTEGER PRIMARY KEY, name TEXT, category TEXT, price REAL, cost REAL, stock INTEGER, minStock INTEGER, description TEXT);");
  sqlDB.run("CREATE TABLE IF NOT EXISTS repairs (id INTEGER PRIMARY KEY, customer TEXT, phone TEXT, device TEXT, issue TEXT, cost REAL, advance REAL, status TEXT, date TEXT, dueDate TEXT, notes TEXT, techNotes TEXT);");
  sqlDB.run("CREATE TABLE IF NOT EXISTS orders (id INTEGER PRIMARY KEY, customer TEXT, phone TEXT, platform TEXT, service TEXT, amount REAL, delivery REAL, advance REAL, status TEXT, paymentStatus TEXT, date TEXT, dueDate TEXT, notes TEXT, items TEXT, payments TEXT);");
  sqlDB.run("CREATE TABLE IF NOT EXISTS customers (id INTEGER PRIMARY KEY, name TEXT, phone TEXT, email TEXT, address TEXT, notes TEXT, joined TEXT);");
  sqlDB.run("CREATE TABLE IF NOT EXISTS invoices (id INTEGER PRIMARY KEY, invNo TEXT, customer TEXT, items TEXT, subtotal REAL, discount REAL, tax REAL, total REAL, payment TEXT, date TEXT, note TEXT);");
  sqlDB.run("CREATE TABLE IF NOT EXISTS credits (id INTEGER PRIMARY KEY, customer TEXT, phone TEXT, nic TEXT, item TEXT, total REAL, down REAL, balance REAL, perInst REAL, instCount INTEGER, freq TEXT, schedule TEXT, payments TEXT, status TEXT, date TEXT, notes TEXT);");
  sqlDB.run("CREATE TABLE IF NOT EXISTS suppliers (id INTEGER PRIMARY KEY, name TEXT, phone TEXT, email TEXT, category TEXT, address TEXT, notes TEXT);");
  sqlDB.run("CREATE TABLE IF NOT EXISTS purchases (id INTEGER PRIMARY KEY, supId INTEGER, supName TEXT, prodId INTEGER, prodName TEXT, qty INTEGER, cost REAL, date TEXT, status TEXT, notes TEXT);");
  sqlDB.run("CREATE TABLE IF NOT EXISTS stock_log (id INTEGER PRIMARY KEY, prodId INTEGER, prodName TEXT, type TEXT, change INTEGER, stockAfter INTEGER, ref TEXT, date TEXT);");
  sqlDB.run("CREATE TABLE IF NOT EXISTS pin_store (id INTEGER PRIMARY KEY, pin TEXT);");
}

// Read all tables into db object
function sqlToDb() {
  try {
    // settings
    var sRows = sqlDB.exec("SELECT key, value FROM settings;");
    if (sRows.length) {
      sRows[0].values.forEach(function(r) {
        try { db.settings[r[0]] = JSON.parse(r[1]); } catch(e) { db.settings[r[0]] = r[1]; }
      });
    }
    // products
    var pRows = sqlDB.exec("SELECT * FROM products;");
    if (pRows.length) {
      db.products = pRows[0].values.map(function(r) {
        return { id:r[0], name:r[1], category:r[2], price:r[3], cost:r[4], stock:r[5], minStock:r[6], desc:r[7] };
      });
    }
    // repairs
    var repRows = sqlDB.exec("SELECT * FROM repairs;");
    if (repRows.length) {
      db.repairs = repRows[0].values.map(function(r) {
        return { id:r[0], customer:r[1], phone:r[2], device:r[3], issue:r[4], cost:r[5], advance:r[6], status:r[7], date:r[8], dueDate:r[9], notes:r[10], techNotes:r[11] };
      });
    }
    // orders
    var ordRows = sqlDB.exec("SELECT * FROM orders;");
    if (ordRows.length) {
      db.orders = ordRows[0].values.map(function(r) {
        return { id:r[0], customer:r[1], phone:r[2], platform:r[3], service:r[4], amount:r[5], delivery:r[6], advance:r[7], status:r[8], paymentStatus:r[9], date:r[10], dueDate:r[11], notes:r[12],
          items: safeJSON(r[13],[]), payments: safeJSON(r[14],[]) };
      });
    }
    // customers
    var cRows = sqlDB.exec("SELECT * FROM customers;");
    if (cRows.length) {
      db.customers = cRows[0].values.map(function(r) {
        return { id:r[0], name:r[1], phone:r[2], email:r[3], address:r[4], notes:r[5], joined:r[6] };
      });
    }
    // invoices
    var invRows = sqlDB.exec("SELECT * FROM invoices;");
    if (invRows.length) {
      db.invoices = invRows[0].values.map(function(r) {
        return { id:r[0], invNo:r[1], customer:r[2], items:safeJSON(r[3],[]), subtotal:r[4], discount:r[5], tax:r[6], total:r[7], payment:r[8], date:r[9], note:r[10] };
      });
    }
    // credits
    var crRows = sqlDB.exec("SELECT * FROM credits;");
    if (crRows.length) {
      db.credits = crRows[0].values.map(function(r) {
        return { id:r[0], customer:r[1], phone:r[2], nic:r[3], item:r[4], total:r[5], down:r[6], balance:r[7], perInst:r[8], instCount:r[9], freq:r[10], schedule:safeJSON(r[11],[]), payments:safeJSON(r[12],[]), status:r[13], date:r[14], notes:r[15] };
      });
    }
    // suppliers
    var supRows = sqlDB.exec("SELECT * FROM suppliers;");
    if (supRows.length) {
      db.suppliers = supRows[0].values.map(function(r) {
        return { id:r[0], name:r[1], phone:r[2], email:r[3], category:r[4], address:r[5], notes:r[6] };
      });
    }
    // purchases
    var poRows = sqlDB.exec("SELECT * FROM purchases;");
    if (poRows.length) {
      db.purchases = poRows[0].values.map(function(r) {
        return { id:r[0], supId:r[1], supName:r[2], prodId:r[3], prodName:r[4], qty:r[5], cost:r[6], date:r[7], status:r[8], notes:r[9] };
      });
    }
    // stock_log
    var slRows = sqlDB.exec("SELECT * FROM stock_log;");
    if (slRows.length) {
      db.stockLog = slRows[0].values.map(function(r) {
        return { id:r[0], prodId:r[1], prodName:r[2], type:r[3], change:r[4], stockAfter:r[5], ref:r[6], date:r[7] };
      });
    }
  } catch(e) { console.warn('sqlToDb error:', e); }
}

// Write db object into SQLite
function dbToSql() {
  if (!sqlDB) return;
  try {
    // settings
    Object.keys(db.settings).forEach(function(k) {
      sqlDB.run("INSERT OR REPLACE INTO settings(key,value) VALUES(?,?);", [k, JSON.stringify(db.settings[k])]);
    });
    // products
    sqlDB.run("DELETE FROM products;");
    db.products.forEach(function(p) {
      sqlDB.run("INSERT INTO products VALUES(?,?,?,?,?,?,?,?);",
        [p.id, p.name, p.category, p.price, p.cost||0, p.stock, p.minStock||2, p.desc||'']);
    });
    // repairs
    sqlDB.run("DELETE FROM repairs;");
    db.repairs.forEach(function(r) {
      sqlDB.run("INSERT INTO repairs VALUES(?,?,?,?,?,?,?,?,?,?,?,?);",
        [r.id, r.customer, r.phone||'', r.device, r.issue||'', r.cost||0, r.advance||0, r.status, r.date||'', r.dueDate||'', r.notes||'', r.techNotes||'']);
    });
    // orders
    sqlDB.run("DELETE FROM orders;");
    db.orders.forEach(function(o) {
      sqlDB.run("INSERT INTO orders VALUES(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?);",
        [o.id, o.customer, o.phone||'', o.platform||'', o.service||'', o.amount||0, o.delivery||0, o.advance||0, o.status||'', o.paymentStatus||'Unpaid', o.date||'', o.dueDate||'', o.notes||'',
         JSON.stringify(o.items||[]), JSON.stringify(o.payments||[])]);
    });
    // customers
    sqlDB.run("DELETE FROM customers;");
    db.customers.forEach(function(c) {
      sqlDB.run("INSERT INTO customers VALUES(?,?,?,?,?,?,?);",
        [c.id, c.name, c.phone||'', c.email||'', c.address||'', c.notes||'', c.joined||'']);
    });
    // invoices
    sqlDB.run("DELETE FROM invoices;");
    db.invoices.forEach(function(i) {
      sqlDB.run("INSERT INTO invoices VALUES(?,?,?,?,?,?,?,?,?,?,?);",
        [i.id, i.invNo||'', i.customer||'', JSON.stringify(i.items||[]), i.subtotal||0, i.discount||0, i.tax||0, i.total||0, i.payment||'', i.date||'', i.note||'']);
    });
    // credits
    sqlDB.run("DELETE FROM credits;");
    (db.credits||[]).forEach(function(c) {
      sqlDB.run("INSERT INTO credits VALUES(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?);",
        [c.id, c.customer, c.phone||'', c.nic||'', c.item||'', c.total||0, c.down||0, c.balance||0, c.perInst||0, c.instCount||1, c.freq||'monthly',
         JSON.stringify(c.schedule||[]), JSON.stringify(c.payments||[]), c.status||'Active', c.date||'', c.notes||'']);
    });
    // suppliers
    sqlDB.run("DELETE FROM suppliers;");
    (db.suppliers||[]).forEach(function(s) {
      sqlDB.run("INSERT INTO suppliers VALUES(?,?,?,?,?,?,?);",
        [s.id, s.name, s.phone||'', s.email||'', s.category||'', s.address||'', s.notes||'']);
    });
    // purchases
    sqlDB.run("DELETE FROM purchases;");
    (db.purchases||[]).forEach(function(p) {
      sqlDB.run("INSERT INTO purchases VALUES(?,?,?,?,?,?,?,?,?,?);",
        [p.id, p.supId||0, p.supName||'', p.prodId||0, p.prodName||'', p.qty||0, p.cost||0, p.date||'', p.status||'', p.notes||'']);
    });
    // stock_log
    sqlDB.run("DELETE FROM stock_log;");
    (db.stockLog||[]).forEach(function(l) {
      sqlDB.run("INSERT INTO stock_log VALUES(?,?,?,?,?,?,?,?);",
        [l.id||Date.now(), l.prodId||0, l.prodName||'', l.type||'', l.change||0, l.stockAfter||0, l.ref||'', l.date||'']);
    });
  } catch(e) { console.warn('dbToSql error:', e); }
}

function safeJSON(str, def) { try { return str ? JSON.parse(str) : def; } catch(e) { return def; } }

// saveDB = write to SQLite + persist to IndexedDB
function saveDB() {
  if (!sqlDB) { fallbackSave(); return; }
  try {
    dbToSql();
    persistSQLite();
  } catch(e) { console.warn('saveDB error:', e); fallbackSave(); }
}

// PIN functions via SQLite
function getSQLPin() {
  if (!sqlDB) return localStorage.getItem(PIN_KEY);
  try {
    var r = sqlDB.exec("SELECT pin FROM pin_store WHERE id=1;");
    return (r.length && r[0].values.length) ? r[0].values[0][0] : null;
  } catch(e) { return null; }
}
function setSQLPin(pin) {
  if (!sqlDB) { localStorage.setItem(PIN_KEY, pin); return; }
  try { sqlDB.run("INSERT OR REPLACE INTO pin_store(id,pin) VALUES(1,?);", [pin]); persistSQLite(); } catch(e) {}
}
function clearSQLPin() {
  if (!sqlDB) { localStorage.removeItem(PIN_KEY); return; }
  try { sqlDB.run("DELETE FROM pin_store WHERE id=1;"); persistSQLite(); } catch(e) {}
}

// Fallback to localStorage if SQLite not ready
function fallbackSave() {
  try { localStorage.setItem('st-pos-v2-fallback', JSON.stringify(db)); } catch(e) {}
}

// Export SQLite .db file
function exportSQLiteFile() {
  if (!sqlDB) { toast('âŒ Database ready à¶±à·‘','var(--danger)'); return; }
  try {
    var data = sqlDB.export();
    var blob = new Blob([data], { type: 'application/octet-stream' });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    var stamp = new Date().toISOString().slice(0,10);
    a.href = url; a.download = 'ST-POS-'+stamp+'.db';
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    setTimeout(function(){ URL.revokeObjectURL(url); }, 3000);
    toast('âœ… SQLite .db file downloaded!');
  } catch(e) { toast('âŒ Export error: '+e.message,'var(--danger)'); }
}

// Import SQLite .db file
function importSQLiteFile(input) {
  var file = input.files[0]; if (!file) return;
  if (!confirm('âš ï¸ à¶¯à·à¶±à¶§ à¶‡à¶­à·’ data replace à·€à·™à¶±à·€à·! Continue?')) { input.value=''; return; }
  var reader = new FileReader();
  reader.onload = function(e) {
    try {
      var arr = new Uint8Array(e.target.result);
      sqlDB = new SQL.Database(arr);
      sqlToDb();
      persistSQLite();
      renderAll();
      toast('âœ… SQLite DB imported! ğŸ‰');
    } catch(ex) { toast('âŒ Import error: '+ex.message,'var(--danger)'); }
    input.value = '';
  };
  reader.readAsArrayBuffer(file);
}

// Initialize SQLite and load data
async function loadDB() {
  try {
    // Load sql.js wasm
    SQL = await initSqlJs({ locateFile: function(f) {
      return 'https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/' + f;
    }});

    // Try to load existing DB from IndexedDB
    var stored = await loadFromIDB();
    if (stored) {
      sqlDB = new SQL.Database(stored);
    } else {
      sqlDB = new SQL.Database();
    }
    createTables();

    // Migrate from localStorage if exists
    var lsData = localStorage.getItem('st-pos-v2');
    if (lsData && stored === null) {
      try {
        var parsed = JSON.parse(lsData);
        if (parsed) {
          db = Object.assign({}, db, parsed);
          dbToSql();
          persistSQLite();
          localStorage.removeItem('st-pos-v2');
          toast('âœ… LocalStorage data â†’ SQLite migrate à·ƒà·à¶»à·Šà¶®à¶šà¶ºà·’! ğŸ‰');
        }
      } catch(me) { console.warn('Migration error:', me); }
    } else {
      // Load from SQLite into db
      sqlToDb();
    }

    // Also migrate PIN from localStorage
    var lsPin = localStorage.getItem(PIN_KEY);
    if (lsPin) {
      setSQLPin(lsPin);
      localStorage.removeItem(PIN_KEY);
    }

    // Show DB info in console
    console.log('âœ… SQLite DB loaded. Products:', db.products.length, '| Orders:', db.orders.length, '| Repairs:', db.repairs.length);
  } catch(e) {
    console.warn('SQLite init failed, falling back to localStorage:', e);
    // Fallback: load from localStorage
    try {
      var raw = localStorage.getItem('st-pos-v2') || localStorage.getItem('st-pos-v2-fallback');
      if (raw) { var d = JSON.parse(raw); if(d) db = Object.assign({}, db, d); }
    } catch(fe) {}
  }
}

// =========== INIT ===========
async function init() {
  // Show loading indicator
  document.body.insertAdjacentHTML('beforeend', '<div id="db-loading" style="position:fixed;inset:0;background:var(--bg);z-index:99999;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px"><div style="font-size:40px">ğŸ—„ï¸</div><div style="font-size:16px;font-weight:700;color:var(--primary)">SQLite Database Loading...</div><div style="font-size:12px;color:var(--muted)" id="db-load-msg">Initializing...</div></div>');
  var loadMsg = document.getElementById('db-load-msg');
  if(loadMsg) loadMsg.textContent = 'Loading sql.js engine...';

  await loadDB();

  if(loadMsg) loadMsg.textContent = 'Rendering UI...';
  ordItems=[];
  initThemeMode();
  initPIN();
  setInterval(function() {
    var el = document.getElementById('clk');
    if (el) el.textContent = new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  }, 1000);
  // Notification badge refresh every 60s
  setInterval(updateNotifBadge, 60000);
  document.querySelectorAll('.nitem').forEach(function(n) {
    n.addEventListener('click', function() { goPage(n.getAttribute('data-page')); });
  });
  initBG();
  renderAll();
  applyTheme(db.settings.theme || '#6c63ff');
  updateNotifBadge();

  // Remove loading screen
  var ld = document.getElementById('db-loading');
  if(ld) ld.remove();

  // Show SQLite status
  var dbStatusBar = document.getElementById('db-status-bar');
  if(dbStatusBar) dbStatusBar.textContent = sqlDB ? 'ğŸ—„ï¸ SQLite Active âœ…' : 'âš ï¸ LocalStorage Mode';
  if(dbStatusBar && !sqlDB) dbStatusBar.style.color = 'var(--warning)';
}

function renderAll() {
  renderInv(); renderRep(); renderOrd(); renderCust(); renderInv2(); updateDash(); updateBadges(); refreshCustSel(); updateNotifBadge(); renderCredits(); renderSuppliers(); renderPurchases(); renderStockLog(); updateCrBadge();
}

// =========== MOBILE SIDEBAR ===========
function toggleSidebar(){
  var sb=document.querySelector('.sidebar');
  var ov=document.getElementById('sb-overlay');
  if(sb) sb.classList.toggle('open');
  if(ov) ov.classList.toggle('open');
}
function closeSidebar(){
  var sb=document.querySelector('.sidebar');
  var ov=document.getElementById('sb-overlay');
  if(sb) sb.classList.remove('open');
  if(ov) ov.classList.remove('open');
}

// =========== NAVIGATION ===========
var pageTitles = { dashboard:'Dashboard', pos:'New Sale', inventory:'Inventory', repairs:'Repairs', orders:'Online Orders', customers:'Customers', invoices:'Invoices', analytics:'Analytics', credits:'Credit Sales', suppliers:'Suppliers', stocklog:'Stock History', settings:'Settings' };
function goPage(id) {
  closeSidebar();
  document.querySelectorAll('.page').forEach(function(p) { p.classList.remove('active'); });
  document.querySelectorAll('.nitem').forEach(function(n) { n.classList.remove('active'); });
  var pg = document.getElementById('pg-' + id);
  if (pg) pg.classList.add('active');
  var ni = document.querySelector('.nitem[data-page="' + id + '"]');
  if (ni) ni.classList.add('active');
  var t = document.getElementById('ptitle');
  if (t) t.textContent = pageTitles[id] || id;
  if (id === 'pos') renderPos();
  if (id === 'dashboard') { updateDash(); }
  if (id === 'settings') loadSettingsFrm();
  if (id === 'analytics') renderAnalytics();
  if (id === 'stocklog') { refreshStockLogFilter(); renderStockLog(); }
  if (id === 'suppliers') { refreshPurchaseSupSel(); refreshPurchaseProdSel(); }
}

// =========== TOAST ===========
function toast(msg, clr) {
  clr = clr || 'var(--success)';
  var el = document.getElementById('toast');
  if (!el) return;
  el.textContent = msg;
  el.style.borderLeftColor = clr;
  el.style.display = 'block';
  setTimeout(function() { el.style.display = 'none'; }, 3000);
}

// =========== MODALS ===========
function openM(id) { var el = document.getElementById(id); if (el) el.classList.add('open'); }
function closeM(id) {
  var el = document.getElementById(id);
  if (!el) return;
  el.classList.remove('open');
  if(id==='m-ord'){ ordItems=[]; var il=document.getElementById('o-items-list'); if(il) il.innerHTML=''; }
  else {
    el.querySelectorAll('input:not([type=hidden]),textarea').forEach(function(f) { f.value = ''; });
    el.querySelectorAll('select').forEach(function(s) { s.selectedIndex = 0; });
  }
}

// =========== DASHBOARD ===========
function sbadge(s) {
  var m = { 'Pending':'bw','In Progress':'bi','Done':'bs','Delivered':'bp','Received':'bi','Processing':'bw','Ready':'bs' };
  return '<span class="badge ' + (m[s]||'bp') + '">' + s + '</span>';
}
// Animated counter
var _counterTimers = {};
function animateCounter(elId, targetVal, prefix, suffix, decimals) {
  if (_counterTimers[elId]) clearInterval(_counterTimers[elId]);
  var el = document.getElementById(elId);
  if (!el) return;
  decimals = decimals || 0;
  var start = 0;
  var duration = 800;
  var startTime = null;
  function easeOut(t) { return 1 - Math.pow(1-t, 3); }
  function step(ts) {
    if (!startTime) startTime = ts;
    var progress = Math.min((ts - startTime) / duration, 1);
    var val = start + easeOut(progress) * (targetVal - start);
    el.textContent = (prefix||'') + val.toFixed(decimals) + (suffix||'');
    if (progress < 1) requestAnimationFrame(step);
    else { el.textContent = (prefix||'') + targetVal.toFixed(decimals) + (suffix||''); el.classList.add('sval-anim'); setTimeout(function(){ el.classList.remove('sval-anim'); }, 400); }
  }
  requestAnimationFrame(step);
}

// Dashboard Chart instances
var _dCharts = {};
function destroyChart(id) { if (_dCharts[id]) { _dCharts[id].destroy(); delete _dCharts[id]; } }

function getChartColors() {
  var primary = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#6c63ff';
  return {
    primary: primary,
    colors: ['#6c63ff','#f50057','#00e676','#ffab00','#00b0ff','#ff6d00','#e040fb','#1de9b6']
  };
}

function renderDashCharts() {
  var clrs = getChartColors();
  var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  var currentYear = new Date().getFullYear();
  var prevYear = currentYear - 1;

  // Monthly revenue data (current + prev year)
  function getMonthlyRev(year) {
    return months.map(function(_, mi) {
      return db.invoices.filter(function(inv) {
        var d = new Date(inv.date.split('/').reverse().join('-'));
        return d.getFullYear() === year && d.getMonth() === mi;
      }).reduce(function(s, i) { return s + (i.total||0); }, 0);
    });
  }
  var curMonthly = getMonthlyRev(currentYear);
  var prevMonthly = getMonthlyRev(prevYear);

  // ---- 1. Revenue Line/Area Chart ----
  destroyChart('revenue');
  var revCtx = document.getElementById('d-chart-revenue');
  if (revCtx) {
    _dCharts['revenue'] = new Chart(revCtx.getContext('2d'), {
      type: 'line',
      data: {
        labels: months,
        datasets: [
          {
            label: currentYear + ' Revenue',
            data: curMonthly,
            borderColor: clrs.primary,
            backgroundColor: clrs.primary + '22',
            fill: true,
            tension: 0.45,
            pointBackgroundColor: clrs.primary,
            pointRadius: 4,
            pointHoverRadius: 7,
            borderWidth: 2.5
          },
          {
            label: prevYear + ' Revenue',
            data: prevMonthly,
            borderColor: '#f5005755',
            backgroundColor: '#f5005711',
            fill: true,
            tension: 0.45,
            pointBackgroundColor: '#f50057',
            pointRadius: 3,
            pointHoverRadius: 5,
            borderWidth: 1.5,
            borderDash: [5,4]
          }
        ]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        animation: { duration: 1000, easing: 'easeOutQuart' },
        plugins: {
          legend: { labels: { color: '#e0e0ff', font: { size: 11 } } },
          tooltip: { backgroundColor: '#12122a', borderColor: clrs.primary, borderWidth: 1, titleColor: '#e0e0ff', bodyColor: '#a0a0c0',
            callbacks: { label: function(c) { return ' Rs. ' + c.raw.toFixed(0); } }
          }
        },
        scales: {
          x: { ticks: { color: '#7070a0', font: { size: 10 } }, grid: { color: '#2a2a4a' } },
          y: { ticks: { color: '#7070a0', font: { size: 10 }, callback: function(v) { return v>=1000?'Rs.'+(v/1000).toFixed(0)+'k':'Rs.'+v; } }, grid: { color: '#2a2a4a' } }
        }
      }
    });
  }

  // ---- 2. Donut Chart - Sales by Category ----
  var catMap = {};
  db.invoices.forEach(function(inv) {
    inv.items.forEach(function(it) {
      var p = db.products.find(function(x){ return x.id === it.id; });
      var cat = p ? p.category : 'Other';
      catMap[cat] = (catMap[cat]||0) + (it.price * it.qty);
    });
  });
  var catKeys = Object.keys(catMap);
  destroyChart('donut');
  var donutCtx = document.getElementById('d-chart-donut');
  if (donutCtx) {
    _dCharts['donut'] = new Chart(donutCtx.getContext('2d'), {
      type: 'doughnut',
      data: {
        labels: catKeys.length ? catKeys : ['No Data'],
        datasets: [{
          data: catKeys.length ? catKeys.map(function(k){ return catMap[k]; }) : [1],
          backgroundColor: catKeys.length ? clrs.colors.slice(0, catKeys.length) : ['#2a2a4a'],
          borderColor: '#12122a',
          borderWidth: 3,
          hoverOffset: 14
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        cutout: '65%',
        animation: { animateRotate: true, duration: 1000, easing: 'easeOutBack' },
        plugins: {
          legend: { position: 'bottom', labels: { color: '#e0e0ff', font: { size: 10 }, padding: 10, boxWidth: 12 } },
          tooltip: { backgroundColor: '#12122a', borderColor: clrs.primary, borderWidth: 1, titleColor: '#e0e0ff', bodyColor: '#a0a0c0',
            callbacks: { label: function(c) { return ' Rs. ' + c.raw.toFixed(0); } }
          }
        }
      }
    });
  }

  // ---- 3. Monthly Comparison Bar Chart ----
  destroyChart('monthly');
  var barCtx = document.getElementById('d-chart-monthly');
  if (barCtx) {
    _dCharts['monthly'] = new Chart(barCtx.getContext('2d'), {
      type: 'bar',
      data: {
        labels: months,
        datasets: [
          {
            label: currentYear,
            data: curMonthly,
            backgroundColor: clrs.colors.map(function(c, i) {
              return clrs.primary + (i % 2 === 0 ? 'cc' : 'aa');
            }),
            borderRadius: 7,
            borderSkipped: false
          },
          {
            label: prevYear,
            data: prevMonthly,
            backgroundColor: '#f50057' + '55',
            borderRadius: 7,
            borderSkipped: false
          }
        ]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        animation: { duration: 900, easing: 'easeOutBounce' },
        plugins: {
          legend: { labels: { color: '#e0e0ff', font: { size: 11 } } },
          tooltip: { backgroundColor: '#12122a', borderColor: clrs.primary, borderWidth: 1, titleColor: '#e0e0ff', bodyColor: '#a0a0c0',
            callbacks: { label: function(c) { return ' Rs. ' + c.raw.toFixed(0); } }
          }
        },
        scales: {
          x: { ticks: { color: '#7070a0', font: { size: 10 } }, grid: { display: false } },
          y: { ticks: { color: '#7070a0', font: { size: 10 }, callback: function(v) { return v>=1000?'Rs.'+(v/1000).toFixed(0)+'k':'Rs.'+v; } }, grid: { color: '#2a2a4a' } }
        }
      }
    });
  }

  // ---- 4. Radar Chart - Stock Levels ----
  var topProds = db.products.slice().sort(function(a,b){ return b.stock - a.stock; }).slice(0, 7);
  destroyChart('radar');
  var radCtx = document.getElementById('d-chart-radar');
  if (radCtx) {
    _dCharts['radar'] = new Chart(radCtx.getContext('2d'), {
      type: 'radar',
      data: {
        labels: topProds.length ? topProds.map(function(p){ return p.name.length > 12 ? p.name.slice(0,10)+'..' : p.name; }) : ['No Products'],
        datasets: [
          {
            label: 'Current Stock',
            data: topProds.length ? topProds.map(function(p){ return p.stock; }) : [0],
            backgroundColor: clrs.primary + '33',
            borderColor: clrs.primary,
            pointBackgroundColor: clrs.primary,
            pointRadius: 5,
            borderWidth: 2
          },
          {
            label: 'Min Stock',
            data: topProds.length ? topProds.map(function(p){ return p.minStock||2; }) : [0],
            backgroundColor: '#ff174433',
            borderColor: '#ff1744',
            pointBackgroundColor: '#ff1744',
            pointRadius: 3,
            borderWidth: 1.5,
            borderDash: [4,3]
          }
        ]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        animation: { duration: 1000, easing: 'easeOutQuart' },
        plugins: {
          legend: { position: 'bottom', labels: { color: '#e0e0ff', font: { size: 10 }, boxWidth: 10 } },
          tooltip: { backgroundColor: '#12122a', borderColor: clrs.primary, borderWidth: 1, titleColor: '#e0e0ff', bodyColor: '#a0a0c0' }
        },
        scales: {
          r: {
            ticks: { color: '#7070a0', backdropColor: 'transparent', font: { size: 9 } },
            grid: { color: '#2a2a4a' },
            pointLabels: { color: '#e0e0ff', font: { size: 9 } },
            angleLines: { color: '#2a2a4a' }
          }
        }
      }
    });
  }
}

// =========== DASHBOARD PERIOD FILTER ===========
var dashPeriod = 'all';
function setDashPeriod(p, el) {
  dashPeriod = p;
  document.querySelectorAll('.dash-period-btn').forEach(function(b){ b.className='btn bo bsm dash-period-btn'; });
  if(el){ el.className='btn bp2 bsm dash-period-btn'; }
  updateDash();
}
function periodFilter(dateStr) {
  if(dashPeriod==='all') return true;
  var d;
  if(dateStr && dateStr.includes('/')) { var pts=dateStr.split('/'); d=new Date(pts[2],pts[1]-1,pts[0]); }
  else { d = new Date(dateStr); }
  if(isNaN(d)) return true;
  var now = new Date();
  if(dashPeriod==='today') { return d.toDateString()===now.toDateString(); }
  if(dashPeriod==='monthly') { return d.getFullYear()===now.getFullYear()&&d.getMonth()===now.getMonth(); }
  if(dashPeriod==='yearly') { return d.getFullYear()===now.getFullYear(); }
  return true;
}
function updateDash() {
  var lbl=document.getElementById('dash-period-label');
  var now=new Date();
  var lbls={today:'('+now.toLocaleDateString('en-GB')+')',monthly:'('+now.toLocaleString('en-GB',{month:'long',year:'numeric'})+')',yearly:'('+now.getFullYear()+')',all:'(All Time)'};
  if(lbl) lbl.textContent=lbls[dashPeriod]||'';

  var filtInv=db.invoices.filter(function(i){ return periodFilter(i.date); });
  var filtOrd=db.orders.filter(function(o){ return periodFilter(o.date); });
  var filtRep=db.repairs.filter(function(r){ return periodFilter(r.date); });

  var invRev = filtInv.reduce(function(s,i){ return s+(i.total||0); },0);
  var ordRev = filtOrd.reduce(function(s,o){
    var paid=(o.payments||[]).reduce(function(ps,p){ return ps+p.amount; },0);
    return s+paid;
  },0);
  var rev = invRev + ordRev;

  // Repair Revenue (from repair cost, paid repairs)
  var repRev = filtRep.reduce(function(s,r){ return s+(r.cost||0); },0);
  var repDone = filtRep.filter(function(r){ return r.status==='Done'||r.status==='Delivered'; }).length;
  var repPending = filtRep.filter(function(r){ return r.status==='Pending'||r.status==='In Progress'; }).length;

  // Accessories sales from invoices
  var accRev = filtInv.reduce(function(s,inv){
    return s+(inv.items||[]).reduce(function(si,it){
      var prod=db.products.find(function(p){ return p.id===it.id; });
      if(prod && prod.category==='Accessories') return si+(it.price*it.qty);
      // fallback: check name match for custom items
      return si;
    },0);
  },0);
  var accSales = filtInv.reduce(function(s,inv){
    return s+(inv.items||[]).filter(function(it){
      var prod=db.products.find(function(p){ return p.id===it.id; });
      return prod && prod.category==='Accessories';
    }).length;
  },0);

  // Estimated profit
  var profit = filtInv.reduce(function(s,inv){
    return s+(inv.items||[]).reduce(function(si,it){
      var prod=db.products.find(function(p){ return p.id===it.id; });
      var cost=prod?prod.cost:0;
      return si+(it.price-cost)*it.qty;
    },0);
  },0);

  // Credit outstanding
  var crBal = (db.credits||[]).filter(function(c){ return c.status==='Active'||c.status==='Overdue'; }).reduce(function(s,c){ return s+(c.balance||0); },0);

  // Animated counters
  animateCounter('d-rev', rev, 'Rs. ', '', 0);
  animateCounter('d-sales', filtInv.length, '', '', 0);
  animateCounter('d-repcost', repRev, 'Rs. ', '', 0);
  animateCounter('d-acc', accRev, 'Rs. ', '', 0);
  animateCounter('d-crbal', crBal, 'Rs. ', '', 0);
  animateCounter('d-profit', profit, 'Rs. ', '', 0);

  var ar = db.repairs.filter(function(r){ return r.status !== 'Delivered'; }).length;
  animateCounter('d-rep', ar, '', '', 0);

  var ao = db.orders.filter(function(o){ return o.status !== 'Delivered'; }).length;
  animateCounter('d-ord', ao, '', '', 0);

  var el;
  el = document.getElementById('d-rev-sub'); if(el) el.textContent = 'Sales: Rs.'+invRev.toFixed(0)+' | Orders: Rs.'+ordRev.toFixed(0);
  el = document.getElementById('d-repcost-sub'); if(el) el.textContent = 'Done: '+repDone+' | Pending: '+repPending;
  el = document.getElementById('d-acc-sub'); if(el) el.textContent = accSales+' item(s) sold';

  var rt = document.getElementById('d-rep-tbl');
  if (rt) rt.innerHTML = db.repairs.length ? db.repairs.slice(-5).reverse().map(function(r){ return '<tr><td>'+r.customer+'</td><td>'+r.device+'</td><td>'+sbadge(r.status)+'</td></tr>'; }).join('') : '<tr><td colspan="3" class="empty">No repairs</td></tr>';
  var ot = document.getElementById('d-ord-tbl');
  if (ot) ot.innerHTML = db.orders.length ? db.orders.slice(-5).reverse().map(function(o){ return '<tr><td><b>#'+String(o.id).slice(-5)+'</b></td><td>'+o.customer+'</td><td>'+sbadge(o.status)+'</td></tr>'; }).join('') : '<tr><td colspan="3" class="empty">No orders</td></tr>';
  var ls = db.products.filter(function(p){ return p.stock <= p.minStock; });
  var lel = document.getElementById('d-lowstock');
  if (lel) lel.innerHTML = ls.length ? '<table><thead><tr><th>Product</th><th>Category</th><th>Stock</th><th>Min</th><th>Status</th></tr></thead><tbody>' + ls.map(function(p){
    var isOut=p.stock===0;
    return '<tr style="'+(isOut?'background:rgba(255,23,68,0.06)':'')+'"><td><b>'+p.name+'</b></td><td>'+p.category+'</td><td style="color:'+(isOut?'var(--danger)':'var(--warning)')+';font-weight:700">'+p.stock+'</td><td style="color:var(--muted)">'+p.minStock+'</td><td><span class="badge '+(isOut?'bd':'bw')+'">'+(isOut?'ğŸš« Out of Stock':'âš ï¸ Low')+'</span></td></tr>';
  }).join('') + '</tbody></table>' : '<div class="empty"><div class="ei">âœ…</div>All stock OK</div>';

  // Render charts (debounced)
  if (typeof Chart !== 'undefined') {
    clearTimeout(window._dashChartTimer);
    window._dashChartTimer = setTimeout(renderDashCharts, 120);
  }
  renderBreakdown();
}

// =========== BREAKDOWN TABLE ===========
var breakdownMode = 'monthly';
function setBreakdown(mode, el) {
  breakdownMode = mode;
  var mb=document.getElementById('breakdown-monthly-btn');
  var yb=document.getElementById('breakdown-yearly-btn');
  if(mb){mb.style.color='';mb.style.borderColor='';}
  if(yb){yb.style.color='';yb.style.borderColor='';}
  if(el){ el.style.color='var(--primary)'; el.style.borderColor='var(--primary)'; }
  renderBreakdown();
}
function renderBreakdown() {
  var col1 = document.getElementById('breakdown-col1');
  var tbody = document.getElementById('breakdown-tbody');
  if(!tbody) return;
  var rows = [];
  if(breakdownMode==='monthly') {
    if(col1) col1.textContent='Month';
    var months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    var now=new Date();
    for(var mi=11;mi>=0;mi--) {
      var yr2=now.getFullYear(), mo=mi;
      if(mi > now.getMonth()) { yr2=now.getFullYear()-1; }
      var label=months[mo]+' '+yr2;
      var inv2=db.invoices.filter(function(i){ var d=i.date&&i.date.split('/'); if(!d||d.length<3) return false; return parseInt(d[2])===yr2&&parseInt(d[1])-1===mo; });
      var rep2=db.repairs.filter(function(r){ var d=r.date&&r.date.split('/'); if(!d||d.length<3) return false; return parseInt(d[2])===yr2&&parseInt(d[1])-1===mo; });
      var ord2=db.orders.filter(function(o){ var d=o.date&&o.date.split('/'); if(!d||d.length<3) return false; return parseInt(d[2])===yr2&&parseInt(d[1])-1===mo; });
      var sr=inv2.reduce(function(s,i){ return s+(i.total||0); },0);
      var rr=rep2.reduce(function(s,r){ return s+(r.cost||0); },0);
      var or2b=ord2.reduce(function(s,o){ var p=(o.payments||[]).reduce(function(ps,py){ return ps+py.amount; },0); return s+p; },0);
      rows.push({label:label,sr:sr,rr:rr,or2:or2b,tot:sr+rr+or2b});
    }
  } else {
    if(col1) col1.textContent='Year';
    var yrs={};
    db.invoices.forEach(function(i){ var d=i.date&&i.date.split('/'); if(d&&d[2]) yrs[d[2]]=1; });
    db.repairs.forEach(function(r){ var d=r.date&&r.date.split('/'); if(d&&d[2]) yrs[d[2]]=1; });
    db.orders.forEach(function(o){ var d=o.date&&o.date.split('/'); if(d&&d[2]) yrs[d[2]]=1; });
    var yrList=Object.keys(yrs).sort().reverse();
    if(!yrList.length) yrList=[new Date().getFullYear().toString()];
    yrList.forEach(function(yr) {
      var y=parseInt(yr);
      var invY=db.invoices.filter(function(i){ var d=i.date&&i.date.split('/'); return d&&parseInt(d[2])===y; });
      var repY=db.repairs.filter(function(r){ var d=r.date&&r.date.split('/'); return d&&parseInt(d[2])===y; });
      var ordY=db.orders.filter(function(o){ var d=o.date&&o.date.split('/'); return d&&parseInt(d[2])===y; });
      var sr=invY.reduce(function(s,i){ return s+(i.total||0); },0);
      var rr=repY.reduce(function(s,r){ return s+(r.cost||0); },0);
      var or2c=ordY.reduce(function(s,o){ var p=(o.payments||[]).reduce(function(ps,py){ return ps+py.amount; },0); return s+p; },0);
      rows.push({label:yr,sr:sr,rr:rr,or2:or2c,tot:sr+rr+or2c});
    });
  }
  tbody.innerHTML=rows.length?rows.map(function(r){
    var rs=r.tot>0?'':'opacity:0.45';
    return '<tr style="'+rs+'"><td><b>'+r.label+'</b></td><td style="color:var(--success)">Rs. '+r.sr.toFixed(2)+'</td><td style="color:var(--warning)">Rs. '+r.rr.toFixed(2)+'</td><td style="color:var(--info)">Rs. '+r.or2.toFixed(2)+'</td><td><b>Rs. '+r.tot.toFixed(2)+'</b></td></tr>';
  }).join(''):'<tr><td colspan="5" class="empty">No data</td></tr>';
}

function updateBadges() {
  var rb = document.getElementById('rbadge'); if(rb) rb.textContent = db.repairs.filter(function(r){ return r.status==='Pending'||r.status==='In Progress'; }).length;
  var ob = document.getElementById('obadge'); if(ob) ob.textContent = db.orders.filter(function(o){ return o.status!=='Delivered'; }).length;
}

// =========== INVENTORY ===========
function renderInv() {
  var q = (document.getElementById('inv-q') ? document.getElementById('inv-q').value : '').toLowerCase();
  var rows = db.products.filter(function(p){ return p.name.toLowerCase().includes(q); });
  var tb = document.getElementById('inv-tbl');
  if (!tb) return;
  tb.innerHTML = rows.length ? rows.map(function(p){
    return '<tr><td><b>'+p.name+'</b>'+(p.desc?'<br><small style="color:var(--muted)">'+p.desc+'</small>':'')+'</td><td><span class="badge bp">'+p.category+'</span></td><td><small style="color:var(--muted);font-family:monospace">'+(p.barcode||'â€”')+'</small></td><td>Rs. '+p.price.toFixed(2)+'</td><td style="color:'+(p.stock<=p.minStock?'var(--danger)':'var(--success)')+'">'+p.stock+'<div class="pbar"><div class="pfill" style="width:'+Math.min(100,p.stock*10)+'%;background:'+(p.stock<=p.minStock?'var(--danger)':'var(--success)')+'"></div></div></td><td><button class="btn bo bsm" onclick="editProd('+p.id+')" style="margin-right:4px">âœï¸</button><button class="btn bd2 bsm" onclick="delProd('+p.id+')">ğŸ—‘ï¸</button></td></tr>';
  }).join('') : '<tr><td colspan="6" class="empty"><div class="ei">ğŸ“¦</div>No products</td></tr>';
}
function saveProd() {
  var id = document.getElementById('p-id').value;
  var nm = document.getElementById('p-name').value.trim();
  if (!nm) { toast('âŒ Name required','var(--danger)'); return; }
  var p = { id: id ? parseInt(id) : Date.now(), name: nm, barcode: document.getElementById('p-barcode').value.trim(), category: document.getElementById('p-cat').value, price: parseFloat(document.getElementById('p-price').value)||0, cost: parseFloat(document.getElementById('p-cost').value)||0, stock: parseInt(document.getElementById('p-stock').value)||0, minStock: parseInt(document.getElementById('p-min').value)||2, desc: document.getElementById('p-desc').value.trim() };
  if (id) { var i = db.products.findIndex(function(x){ return x.id===p.id; }); if(i>=0) db.products[i]=p; } else db.products.push(p);
  saveDB(); renderInv(); updateDash(); closeM('m-prod'); toast('âœ… Product saved!');
}
function editProd(id) {
  var p = db.products.find(function(x){ return x.id===id; }); if(!p) return;
  document.getElementById('p-id').value = p.id;
  document.getElementById('p-name').value = p.name;
  document.getElementById('p-cat').value = p.category;
  document.getElementById('p-price').value = p.price;
  document.getElementById('p-cost').value = p.cost;
  document.getElementById('p-stock').value = p.stock;
  document.getElementById('p-min').value = p.minStock;
  document.getElementById('p-desc').value = p.desc||'';
  document.getElementById('p-barcode').value = p.barcode||'';
  openM('m-prod');
}
function delProd(id) {
  if(!confirm('Delete?')) return;
  db.products = db.products.filter(function(p){ return p.id!==id; });
  saveDB(); renderInv(); toast('ğŸ—‘ï¸ Deleted','var(--danger)');
}

// =========== POS ===========
var ICONS = { Phone:'ğŸ“±', Accessories:'ğŸ§', 'Repair Part':'ğŸ”©', 'Design Service':'ğŸ¨', Other:'ğŸ“¦' };
function setPosTab(cat, el) {
  document.querySelectorAll('.ptab').forEach(function(b){ b.classList.remove('at'); });
  if(el) el.classList.add('at');
  var s = document.getElementById('pos-cat'); if(s) s.value = cat;
  renderPos();
}
function renderPos() {
  var q = (document.getElementById('pos-q') ? document.getElementById('pos-q').value : '').toLowerCase();
  var cat = document.getElementById('pos-cat') ? document.getElementById('pos-cat').value : '';
  var filtered = db.products.filter(function(p){ return p.name.toLowerCase().includes(q) && (!cat||p.category===cat) && p.stock>0; });
  var el = document.getElementById('pos-prods'); if(!el) return;
  el.innerHTML = filtered.length ? filtered.map(function(p){
    return '<div class="pcard" onclick="addToCart('+p.id+')"><div class="picon">'+(ICONS[p.category]||'ğŸ“¦')+'</div><div class="pname">'+p.name+'</div><div class="pprice">Rs. '+p.price.toFixed(2)+'</div><div class="pstock" style="color:'+(p.stock<=p.minStock?'var(--danger)':'var(--muted)')+'">Stock: '+p.stock+'</div></div>';
  }).join('') : '<div style="grid-column:1/-1;text-align:center;color:var(--muted);padding:30px"><div style="font-size:32px">ğŸ“¦</div><br>No products found</div>';
}
function addToCart(id) {
  var p = db.products.find(function(x){ return x.id===id; }); if(!p) return;
  var ex = cart.find(function(c){ return c.id===id; });
  if (ex) { if(ex.qty<p.stock) ex.qty++; else { toast('âš ï¸ Max stock','var(--warning)'); return; } }
  else cart.push({ id:id, name:p.name, price:p.price, qty:1 });
  renderCart();
}
function addCustom() {
  var nm = document.getElementById('ci-name').value.trim();
  var pr = parseFloat(document.getElementById('ci-price').value)||0;
  if(!nm){ toast('âŒ Name required','var(--danger)'); return; }
  cart.push({ id:'c'+Date.now(), name:nm, price:pr, qty:1, custom:true });
  document.getElementById('ci-name').value = '';
  document.getElementById('ci-price').value = '';
  renderCart(); toast('âœ… Added');
}
function renderCart() {
  var cnt = document.getElementById('cart-cnt');
  var total = cart.reduce(function(s,c){ return s+c.qty; },0);
  if(cnt) cnt.textContent = total;
  var el = document.getElementById('cart-list'); if(!el) return;
  if(!cart.length){ el.innerHTML = '<div class="empty" style="padding:16px"><div class="ei">ğŸ›’</div>Empty cart</div>'; calcTotal(); return; }
  el.innerHTML = cart.map(function(c,i){
    return '<div class="citem"><span class="cname">'+c.name+(c.custom?'<small style="color:var(--muted);font-size:9px"> [custom]</small>':'')+'</span><div class="cqty"><button class="qbtn" onclick="chgQty('+i+',-1)">âˆ’</button><span style="font-size:12px;min-width:18px;text-align:center">'+c.qty+'</span><button class="qbtn" onclick="chgQty('+i+',1)">+</button></div><span class="cprice">Rs. '+(c.price*c.qty).toFixed(2)+'</span><button style="background:none;border:none;color:var(--danger);cursor:pointer;font-size:18px;padding:0 2px" onclick="remCart('+i+')">Ã—</button></div>';
  }).join('');
  calcTotal();
}
function chgQty(i,d) {
  var p = cart[i].custom ? null : db.products.find(function(x){ return x.id===cart[i].id; });
  var mx = p ? p.stock : 999;
  cart[i].qty = Math.max(1, Math.min(mx, cart[i].qty+d));
  renderCart();
}
function remCart(i){ cart.splice(i,1); renderCart(); }
function clearCart(){ cart=[]; var d=document.getElementById('c-disc'); if(d) d.value=0; var t=document.getElementById('c-tax'); if(t) t.value=0; var g=document.getElementById('c-given'); if(g) g.value=''; clearCustSel(); renderCart(); }
function selPay(m,el){
  selPayment=m;
  document.querySelectorAll('.cpanel .paybtn').forEach(function(b){ b.classList.remove('ap'); });
  if(el) el.classList.add('ap');
}
function calcTotal(){
  var sub=cart.reduce(function(s,c){ return s+c.price*c.qty; },0);
  var disc=parseFloat(document.getElementById('c-disc')?document.getElementById('c-disc').value:0)||0;
  var tax=parseFloat(document.getElementById('c-tax')?document.getElementById('c-tax').value:0)||0;
  var after=Math.max(0,sub-disc);
  var ttl=after+after*tax/100;
  var es=document.getElementById('c-sub'); if(es) es.textContent='Rs. '+sub.toFixed(2);
  var et=document.getElementById('c-total'); if(et) et.textContent='Rs. '+ttl.toFixed(2);
  calcChange();
}
function calcChange(){
  var ttl=parseFloat((document.getElementById('c-total')||{textContent:'0'}).textContent.replace('Rs. ',''))||0;
  var giv=parseFloat(document.getElementById('c-given')?document.getElementById('c-given').value:0)||0;
  var ch=giv-ttl;
  var el=document.getElementById('c-change'); if(!el) return;
  el.textContent='Rs. '+Math.max(0,ch).toFixed(2);
  el.style.color=ch>=0?'var(--success)':'var(--danger)';
}
function completeSale(){
  if(!cart.length){ toast('âŒ Cart empty','var(--danger)'); return; }
  var sub=cart.reduce(function(s,c){ return s+c.price*c.qty; },0);
  var disc=parseFloat(document.getElementById('c-disc').value)||0;
  var taxP=parseFloat(document.getElementById('c-tax').value)||0;
  var after=Math.max(0,sub-disc);
  var tax=after*taxP/100;
  var ttl=after+tax;
  var custId=document.getElementById('cart-cust').value;
  var cust=db.customers.find(function(c){ return c.id==custId; });
  var prefix=db.settings.prefix||'INV';
  var inv={ id:Date.now(), invNo:prefix+'-'+String(db.invoices.length+1).padStart(4,'0'), customer:cust?cust.name:'Walk-in', customerId:custId, items:cart.map(function(c){ return Object.assign({},c); }), subtotal:sub, discount:disc, tax:tax, taxPct:taxP, total:ttl, payment:selPayment, date:new Date().toLocaleDateString('en-GB') };
  cart.forEach(function(c){ if(!c.custom){ var p=db.products.find(function(x){ return x.id===c.id; }); if(p){ p.stock-=c.qty; logStock(p.id, p.name, 'Sale', -c.qty, p.stock, inv.invNo); }}});
  db.invoices.push(inv);
  saveDB(); clearCart(); renderAll();
  showInv(inv.id);
  toast('âœ… Sale done! '+inv.invNo);
}
function refreshCustSel(){
  // custom dropdown - just rebuild on next open
  var inp=document.getElementById('cart-cust-input');
  var hid=document.getElementById('cart-cust');
  if(!inp||!hid) return;
  // if current hidden value no longer in db, reset
  if(hid.value && !db.customers.find(function(c){ return c.id==hid.value; })){
    hid.value=''; inp.value='';
  }
}
function filterCustDrop(){
  var inp=document.getElementById('cart-cust-input'); if(!inp) return;
  var drop=document.getElementById('cart-cust-drop'); if(!drop) return;
  var q=inp.value.toLowerCase();
  var custs=db.customers.filter(function(c){ return c.name.toLowerCase().includes(q)||c.phone.includes(q); });

  var html='';
  // Walk-in option
  html+='<div onmousedown="selectCust(\'\',\'\')" style="padding:9px 12px;cursor:pointer;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px" onmouseover="this.style.background=\'rgba(108,99,255,0.1)\'" onmouseout="this.style.background=\'\'">'
      +'<span style="font-size:15px">ğŸš¶</span><span style="color:var(--muted);font-size:13px">Walk-in Customer</span></div>';

  // Matched customers
  custs.forEach(function(c){
    html+='<div onmousedown="selectCust(\''+c.id+'\','+JSON.stringify(c.name)+')" style="padding:9px 12px;cursor:pointer;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px" onmouseover="this.style.background=\'rgba(108,99,255,0.1)\'" onmouseout="this.style.background=\'\'">'
        +'<span style="font-size:15px">ğŸ‘¤</span>'
        +'<span style="flex:1"><span style="font-weight:600">'+c.name+'</span> <span style="color:var(--muted);font-size:11px">'+c.phone+'</span></span>'
        +'</div>';
  });

  // Quick-add new customer button
  var qname=inp.value.trim();
  html+='<div onmousedown="quickAddCust()" style="padding:9px 12px;cursor:pointer;display:flex;align-items:center;gap:8px;background:rgba(108,99,255,0.06)" onmouseover="this.style.background=\'rgba(108,99,255,0.15)\'" onmouseout="this.style.background=\'rgba(108,99,255,0.06)\'">'
      +'<span style="font-size:15px">â•</span>'
      +'<span style="color:var(--primary);font-weight:600;font-size:13px">'+(qname?'Add "'+qname+'" as new customer':'New Customer Add à¶šà¶»à¶±à·Šà¶±')+'</span>'
      +'</div>';

  drop.innerHTML=html;
  var rect=inp.getBoundingClientRect();
  drop.style.top=(rect.bottom+4)+'px';
  drop.style.left=rect.left+'px';
  drop.style.width=Math.max(rect.width,240)+'px';
  drop.style.display='block';
}
function selectCust(id, name){
  document.getElementById('cart-cust').value=id;
  // Show name in input, empty for walk-in
  document.getElementById('cart-cust-input').value=name||'';
  document.getElementById('cart-cust-input').placeholder=name?'':'Walk-in (type to search...)';
  hideCustDrop();
}
function quickAddCust(){
  hideCustDrop();
  var q=document.getElementById('cart-cust-input').value.trim();
  // Pre-fill customer modal with typed name
  var nm=document.getElementById('cu-name'); if(nm) nm.value=q;
  var ph=document.getElementById('cu-phone'); if(ph) ph.value='';
  var em=document.getElementById('cu-email'); if(em) em.value='';
  var ad=document.getElementById('cu-addr'); if(ad) ad.value='';
  var nt=document.getElementById('cu-notes'); if(nt) nt.value='';
  var ci=document.getElementById('cu-id'); if(ci) ci.value='';
  // After save, auto-select â€” patch saveCust to call back
  window._custSaveCallback=function(newId, newName){
    document.getElementById('cart-cust').value=newId;
    document.getElementById('cart-cust-input').value=newName;
    window._custSaveCallback=null;
  };
  openM('m-cust');
}
function hideCustDrop(){
  var drop=document.getElementById('cart-cust-drop'); if(drop) drop.style.display='none';
}
function clearCustSel(){
  document.getElementById('cart-cust').value='';
  document.getElementById('cart-cust-input').value='';
}

// =========== REPAIRS ===========
function setRepF(s){ repF=s; renderRep(); }
function renderRep(){
  var q=(document.getElementById('rep-q')?document.getElementById('rep-q').value:'').toLowerCase();
  var rows=db.repairs.filter(function(r){
    var matchF=repF?r.status===repF:true;
    var matchQ=q?(r.customer.toLowerCase().includes(q)||r.device.toLowerCase().includes(q)||(r.phone&&r.phone.includes(q))):true;
    return matchF&&matchQ;
  });
  var tb=document.getElementById('rep-tbl'); if(!tb) return;
  tb.innerHTML=rows.length?rows.slice().reverse().map(function(r){
    var isOverdue=r.dueDate&&new Date(r.dueDate)<new Date()&&r.status!=='Delivered';
    var dueTxt=r.dueDate?'<br><small style="color:'+(isOverdue?'var(--danger)':'var(--warning)')+'">â° '+r.dueDate+(isOverdue?' âš ï¸':'')+'</small>':'';
    var advTxt=r.advance>0?'<br><small style="color:var(--success)">Adv: Rs.'+r.advance.toFixed(0)+'</small>':'';
    return '<tr class="'+(isOverdue?'overdue':'')+'"><td><b>#'+String(r.id).slice(-4)+'</b></td><td>'+r.customer+'<br><small style="color:var(--muted)">'+r.phone+'</small></td><td>'+r.device+'</td><td style="max-width:130px">'+r.issue+'</td><td>Rs. '+(r.cost||0).toFixed(2)+advTxt+'</td><td>'+sbadge(r.status)+dueTxt+'</td><td>'+r.date+'</td><td style="white-space:nowrap"><button class="btn bo bsm" onclick="editRep('+r.id+')" style="margin-right:3px">âœï¸</button><button class="btn bs2 bsm" onclick="cycleRep('+r.id+')" style="margin-right:3px">â†’</button><button class="btn bp2 bsm" onclick="showRepBill('+r.id+')" style="margin-right:3px">ğŸ§¾</button><button class="btn bwa bsm" onclick="waShareRepCustomer('+r.id+')" style="margin-right:3px">ğŸ’¬</button><button class="btn bd2 bsm" onclick="delRep('+r.id+')">ğŸ—‘ï¸</button></td></tr>';
  }).join(''):'<tr><td colspan="8" class="empty"><div class="ei">ğŸ”§</div>No repairs</td></tr>';
}
function saveRep(){
  var id=document.getElementById('r-id').value;
  var r={ id:id?parseInt(id):Date.now(), customer:document.getElementById('r-cust').value.trim(), phone:document.getElementById('r-phone').value.trim(), device:document.getElementById('r-dev').value.trim(), imei:document.getElementById('r-imei').value.trim(), issue:document.getElementById('r-issue').value.trim(), cost:parseFloat(document.getElementById('r-cost').value)||0, status:document.getElementById('r-status').value, notes:document.getElementById('r-notes').value.trim(), date:new Date().toLocaleDateString('en-GB'), dueDate:document.getElementById('r-due').value, advance:parseFloat(document.getElementById('r-adv').value)||0 };
  if(!r.customer||!r.device||!r.issue){ toast('âŒ Fill required fields','var(--danger)'); return; }
  if(id){ var i=db.repairs.findIndex(function(x){ return x.id===r.id; }); if(i>=0) db.repairs[i]=r; } else db.repairs.push(r);
  saveDB(); renderRep(); updateDash(); updateBadges(); closeM('m-rep'); toast('âœ… Repair saved!');
}
function editRep(id){
  var r=db.repairs.find(function(x){ return x.id===id; }); if(!r) return;
  document.getElementById('r-id').value=r.id;
  document.getElementById('r-cust').value=r.customer;
  document.getElementById('r-phone').value=r.phone||'';
  document.getElementById('r-dev').value=r.device;
  document.getElementById('r-imei').value=r.imei||'';
  document.getElementById('r-issue').value=r.issue;
  document.getElementById('r-cost').value=r.cost;
  document.getElementById('r-status').value=r.status;
  document.getElementById('r-notes').value=r.notes||'';
  document.getElementById('r-due').value=r.dueDate||'';
  document.getElementById('r-adv').value=r.advance||'';
  openM('m-rep');
}
function cycleRep(id){
  var r=db.repairs.find(function(x){ return x.id===id; }); if(!r) return;
  var ord=['Pending','In Progress','Done','Delivered'];
  r.status=ord[(ord.indexOf(r.status)+1)%ord.length];
  saveDB(); renderRep(); updateDash(); updateBadges(); toast('ğŸ”„ â†’ '+r.status);
}
function delRep(id){
  if(!confirm('Delete?')) return;
  db.repairs=db.repairs.filter(function(r){ return r.id!==id; });
  saveDB(); renderRep(); updateDash(); updateBadges(); toast('ğŸ—‘ï¸ Deleted','var(--danger)');
}
function showRepBill(id){
  var r=db.repairs.find(function(x){ return x.id===id; }); if(!r) return;
  var s=db.settings;
  var el=document.getElementById('rbill-content'); if(!el) return;
  el.innerHTML=
    '<h2>ST Mobile</h2>'+
    '<p style="text-align:center;color:#666;font-size:11px">'+[s.phone,s.email,s.address].filter(Boolean).join(' | ')+'</p>'+
    '<div class="inv-line"></div>'+
    '<div class="inv-row"><span><b>Repair ID:</b> REP-'+String(r.id).slice(-4)+'</span><span><b>Date:</b> '+r.date+'</span></div>'+
    '<div class="inv-row"><span><b>Customer:</b> '+r.customer+'</span><span><b>Phone:</b> '+(r.phone||'â€”')+'</span></div>'+
    '<div class="inv-line"></div>'+
    '<table style="width:100%;font-size:12px"><tr style="background:#f5f5ff"><th style="padding:5px;text-align:left">Details</th><th style="text-align:right;padding:5px">Info</th></tr>'+
    '<tr><td style="padding:5px"><b>Device</b></td><td style="text-align:right;padding:5px">'+r.device+'</td></tr>'+
    (r.imei?'<tr><td style="padding:5px">IMEI / Serial</td><td style="text-align:right;padding:5px">'+r.imei+'</td></tr>':'')+
    '<tr><td style="padding:5px">Issue</td><td style="text-align:right;padding:5px;max-width:160px">'+r.issue+'</td></tr>'+
    '<tr><td style="padding:5px">Status</td><td style="text-align:right;padding:5px">'+r.status+'</td></tr>'+
    (r.dueDate?'<tr><td style="padding:5px">â° Due Date</td><td style="text-align:right;padding:5px;color:#ff6d00">'+r.dueDate+'</td></tr>':'')+
    '</table>'+
    '<div class="inv-line"></div>'+
    '<div class="inv-row" style="font-size:13px"><span>Repair Cost</span><span>Rs. '+(r.cost||0).toFixed(2)+'</span></div>'+
    (r.advance>0?'<div class="inv-row" style="font-size:13px"><span>ğŸ’µ Advance Paid</span><span style="color:#00c853">- Rs. '+r.advance.toFixed(2)+'</span></div>':'')+
    '<div class="inv-row" style="font-size:15px;font-weight:800;color:#6c63ff"><span>BALANCE DUE</span><span>Rs. '+Math.max(0,(r.cost||0)-r.advance).toFixed(2)+'</span></div>'+
    '<div class="inv-line"></div>'+
    (r.notes?'<p style="font-size:11px;color:#666"><b>Notes:</b> '+r.notes+'</p>':'')+
    '<p style="text-align:center;color:#888;font-size:11px;margin-top:8px">'+s.note+'</p>'+
    (s.whatsapp?'<p style="text-align:center;color:#888;font-size:11px">ğŸ“± '+s.whatsapp+'</p>':'')+
    (s.fb?'<p style="text-align:center;color:#888;font-size:11px">ğŸŒ '+s.fb+'</p>':'');
  openM('m-rbill');
}

// =========== ORDERS ===========
function setOrdF(s){
  ordF=s;
  document.querySelectorAll('#pg-orders .ord-filter-btn').forEach(function(b){
    b.classList.remove('bp2'); b.classList.add('bo');
  });
  var active=document.querySelector('#pg-orders .ord-filter-btn[data-f="'+s+'"]');
  if(active){ active.classList.remove('bo'); active.classList.add('bp2'); }
  renderOrd();
}
function renderOrd(){
  var q=(document.getElementById('ord-q')?document.getElementById('ord-q').value:'').toLowerCase();
  var rows=db.orders.filter(function(o){
    var matchQ=q?(o.customer.toLowerCase().includes(q)||(o.phone&&o.phone.includes(q))):true;
    if(!matchQ) return false;
    if(!ordF) return true;
    if(ordF.startsWith('status:')){
      return o.status===ordF.slice(7);
    }
    if(ordF.startsWith('cat:')){
      var parts=ordF.slice(4).split(':');
      var cat=parts[0]; var sub=parts[1];
      if(!o.category) return o.service.toLowerCase().includes(cat);
      if(!sub) return o.category===cat;
      return o.category===cat && o.service.toLowerCase().includes(sub.toLowerCase());
    }
    return true;
  });
  var tb=document.getElementById('ord-tbl'); if(!tb) return;
  tb.innerHTML=rows.length?rows.slice().reverse().map(function(o){
    var ps=o.paymentStatus||'Unpaid';
    var pc=ps==='Paid'?'bs':ps==='Partial'?'bw':'bd';
    var svcDisplay=o.items&&o.items.length>1?'<b>'+o.items.length+' items</b><br>'+o.items.map(function(i){return '<small style="color:var(--muted)">â€¢ '+i.desc+'</small>';}).join('<br>'):o.service+(o.frameSize?'<br><small style="color:var(--muted)">ğŸ–¼ï¸ '+o.frameSize+'</small>':'');
    return '<tr><td><b>#'+String(o.id).slice(-5)+'</b></td><td>'+o.customer+'<br><small style="color:var(--muted)">'+o.phone+'</small></td><td>'+svcDisplay+'<br><small style="color:var(--muted)">'+o.platform+'</small></td><td><b>Rs. '+(o.amount||0).toFixed(2)+'</b>'+(o.delivery>0?'<br><small style="color:var(--muted)">ğŸšš Rs.'+o.delivery.toFixed(2)+'</small>':'')+(o.advance>0?'<br><small style="color:var(--success)">Adv: Rs.'+o.advance.toFixed(0)+'</small>':'')+'</td><td>'+sbadge(o.status)+'<br><span class="badge '+pc+'" style="margin-top:2px">'+(ps==='Paid'?'ğŸ’° Paid':ps==='Partial'?'âš ï¸ Partial':'âŒ Unpaid')+'</span></td><td>'+o.date+'</td><td style="white-space:nowrap"><button class="btn bo bsm" onclick="editOrd('+o.id+')" style="margin-right:3px">âœï¸</button><button class="btn bs2 bsm" onclick="cycleOrd('+o.id+')" style="margin-right:3px">â†’</button><button class="btn bp2 bsm" onclick="showOBill('+o.id+')" style="margin-right:3px">ğŸ§¾</button><button class="btn bsm" style="background:rgba(0,230,118,0.15);color:var(--success);border:1px solid rgba(0,230,118,0.3);margin-right:3px" onclick="openPay('+o.id+')">ğŸ’³</button><button class="btn bd2 bsm" onclick="delOrd('+o.id+')">ğŸ—‘ï¸</button></td></tr>';
  }).join(''):'<tr><td colspan="7" class="empty"><div class="ei">ğŸŒ</div>No orders</td></tr>';
}
function saveOrd(){
  var id=document.getElementById('o-id').value;
  var cust=document.getElementById('o-cust').value.trim();
  var phone=document.getElementById('o-phone').value.trim();
  if(!cust||!phone){ toast('âŒ Customer & Phone required','var(--danger)'); return; }
  if(ordItems.length===0){ toast('âŒ à¶…à¶©à·”à¶¸ à¶œà·à¶±à·š item 1à¶šà·Š add à¶šà¶»à¶±à·Šà¶±','var(--danger)'); return; }
  var hasDesc=ordItems.every(function(i){ return i.desc&&i.desc.trim(); });
  if(!hasDesc){ toast('âŒ à·ƒà·’à¶ºà¶½à·” items à·€à¶½ Description fill à¶šà¶»à¶±à·Šà¶±','var(--danger)'); return; }
  var sub=ordItems.reduce(function(s,i){ return s+(parseFloat(i.amount)||0); },0);
  var delivery=parseFloat(document.getElementById('o-delivery').value)||0;
  var total=sub+delivery;
  // build legacy service string for display
  var svcStr=ordItems.map(function(i,idx){ return (idx+1)+'. '+i.desc+(i.amount?' (Rs.'+parseFloat(i.amount).toFixed(2)+')':''); }).join(' | ');
  var o={
    id:id?parseInt(id):Date.now(),
    customer:cust, phone:phone,
    service:svcStr,
    items:JSON.parse(JSON.stringify(ordItems)),
    amount:total,
    platform:document.getElementById('o-plat').value,
    status:document.getElementById('o-stat').value,
    notes:document.getElementById('o-notes').value.trim(),
    date:new Date().toLocaleDateString('en-GB'),
    category:ordItems[0].cat||'',
    delivery:delivery,
    subtotal:sub,
    dueDate:document.getElementById('o-due')?document.getElementById('o-due').value:'',
    advance:parseFloat(document.getElementById('o-adv')?document.getElementById('o-adv').value:0)||0
  };
  if(id){ var i=db.orders.findIndex(function(x){ return x.id===o.id; }); if(i>=0){ o.payments=db.orders[i].payments||[]; o.paymentStatus=db.orders[i].paymentStatus||'Unpaid'; db.orders[i]=o; } }
  else db.orders.push(o);
  saveDB(); renderOrd(); updateDash(); updateBadges(); closeM('m-ord'); toast('âœ… Order saved!');
}
function editOrd(id){
  var o=db.orders.find(function(x){ return x.id===id; }); if(!o) return;
  document.getElementById('o-id').value=o.id;
  document.getElementById('o-cust').value=o.customer;
  document.getElementById('o-phone').value=o.phone;
  document.getElementById('o-plat').value=o.platform||'Facebook';
  document.getElementById('o-stat').value=o.status;
  document.getElementById('o-notes').value=o.notes||'';
  var dEl=document.getElementById('o-delivery');
  if(dEl) dEl.value=o.delivery||0;
  var duEl=document.getElementById('o-due'); if(duEl) duEl.value=o.dueDate||'';
  var advEl=document.getElementById('o-adv'); if(advEl) advEl.value=o.advance||'';
  // Restore items - support both old (no items) and new format
  if(o.items && o.items.length){
    ordItems=JSON.parse(JSON.stringify(o.items));
  } else {
    // Legacy single-item order
    ordItems=[{cat:o.category||'',sub:'',frameSize:o.frameSize||'',frameCustom:'',desc:o.service,amount:o.amount}];
  }
  renderOrdItems();
  openM('m-ord');
}
function cycleOrd(id){
  var o=db.orders.find(function(x){ return x.id===id; }); if(!o) return;
  var ord=['Received','Processing','Ready','Delivered'];
  o.status=ord[(ord.indexOf(o.status)+1)%ord.length];
  saveDB(); renderOrd(); updateDash(); updateBadges(); toast('ğŸ”„ â†’ '+o.status);
}
function delOrd(id){
  if(!confirm('Delete?')) return;
  db.orders=db.orders.filter(function(o){ return o.id!==id; });
  saveDB(); renderOrd(); updateDash(); updateBadges(); toast('ğŸ—‘ï¸ Deleted','var(--danger)');
}

// =========== CUSTOMERS ===========
function renderCust(){
  var q=(document.getElementById('cust-q')?document.getElementById('cust-q').value:'').toLowerCase();
  var rows=db.customers.filter(function(c){ return c.name.toLowerCase().includes(q)||c.phone.includes(q); });
  var tb=document.getElementById('cust-tbl'); if(!tb) return;
  tb.innerHTML=rows.length?rows.map(function(c){
    var s=db.invoices.filter(function(i){ return i.customerId==c.id; }).length;
    var r=db.repairs.filter(function(r){ return r.phone===c.phone; }).length;
    var ordCount=db.orders.filter(function(o){ return o.phone===c.phone||o.customer===c.name; }).length;
    return '<tr><td><b>'+c.name+'</b></td><td>'+c.phone+'</td><td>'+(c.email||'â€”')+'</td><td>'+s+'</td><td>'+r+'</td><td>'+ordCount+'</td><td style="white-space:nowrap"><button class="btn bp2 bsm" onclick="viewCustHistory('+c.id+')" style="margin-right:3px" title="History">ğŸ“‹</button><button class="btn bo bsm" onclick="editCust('+c.id+')" style="margin-right:4px">âœï¸</button><button class="btn bd2 bsm" onclick="delCust('+c.id+')">ğŸ—‘ï¸</button></td></tr>';
  }).join(''):'<tr><td colspan="7" class="empty"><div class="ei">ğŸ‘¥</div>No customers</td></tr>';
}
function saveCust(){
  var id=document.getElementById('cu-id').value;
  var c={ id:id?parseInt(id):Date.now(), name:document.getElementById('cu-name').value.trim(), phone:document.getElementById('cu-phone').value.trim(), email:document.getElementById('cu-email').value.trim(), address:document.getElementById('cu-addr').value.trim(), notes:document.getElementById('cu-notes').value.trim() };
  if(!c.name||!c.phone){ toast('âŒ Name & phone required','var(--danger)'); return; }
  if(id){ var i=db.customers.findIndex(function(x){ return x.id===c.id; }); if(i>=0) db.customers[i]=c; } else db.customers.push(c);
  saveDB(); renderCust(); refreshCustSel(); closeM('m-cust'); toast('âœ… Customer saved!');
  // Auto-select in POS cart if opened via quick-add
  if(!id && window._custSaveCallback) window._custSaveCallback(c.id, c.name);
}
function editCust(id){
  var c=db.customers.find(function(x){ return x.id===id; }); if(!c) return;
  document.getElementById('cu-id').value=c.id;
  document.getElementById('cu-name').value=c.name;
  document.getElementById('cu-phone').value=c.phone;
  document.getElementById('cu-email').value=c.email||'';
  document.getElementById('cu-addr').value=c.address||'';
  document.getElementById('cu-notes').value=c.notes||'';
  openM('m-cust');
}
function delCust(id){
  if(!confirm('Delete?')) return;
  db.customers=db.customers.filter(function(c){ return c.id!==id; });
  saveDB(); renderCust(); refreshCustSel(); toast('ğŸ—‘ï¸ Deleted','var(--danger)');
}
function viewCustHistory(id){
  var c=db.customers.find(function(x){ return x.id===id; }); if(!c) return;
  var title=document.getElementById('cust-hist-title');
  if(title) title.textContent='ğŸ“‹ '+c.name+' â€” History';
  var invs=db.invoices.filter(function(i){ return i.customerId==id; });
  var reps=db.repairs.filter(function(r){ return r.phone===c.phone||r.customer===c.name; });
  var ords=db.orders.filter(function(o){ return o.phone===c.phone||o.customer===c.name; });
  var totalSpent=invs.reduce(function(s,i){ return s+(i.total||0); },0)+reps.reduce(function(s,r){ return s+(r.cost||0); },0)+ords.reduce(function(s,o){ return s+(o.amount||0); },0);
  var body=document.getElementById('cust-hist-body'); if(!body) return;
  body.innerHTML=
    '<div style="background:var(--card2);border-radius:10px;padding:12px;margin-bottom:14px;display:flex;gap:14px;flex-wrap:wrap">' +
    '<div style="flex:1;text-align:center"><div style="font-size:22px">ğŸ§¾</div><div style="font-size:18px;font-weight:800;color:var(--primary)">'+invs.length+'</div><div style="font-size:11px;color:var(--muted)">Invoices</div></div>' +
    '<div style="flex:1;text-align:center"><div style="font-size:22px">ğŸ”§</div><div style="font-size:18px;font-weight:800;color:var(--warning)">'+reps.length+'</div><div style="font-size:11px;color:var(--muted)">Repairs</div></div>' +
    '<div style="flex:1;text-align:center"><div style="font-size:22px">ğŸŒ</div><div style="font-size:18px;font-weight:800;color:var(--info)">'+ords.length+'</div><div style="font-size:11px;color:var(--muted)">Orders</div></div>' +
    '<div style="flex:1;text-align:center"><div style="font-size:22px">ğŸ’°</div><div style="font-size:18px;font-weight:800;color:var(--success)">Rs.'+totalSpent.toFixed(0)+'</div><div style="font-size:11px;color:var(--muted)">Total Spent</div></div>' +
    '</div>' +
    (invs.length?'<div style="font-size:13px;font-weight:700;margin-bottom:6px;color:var(--primary)">ğŸ§¾ Invoices</div><table style="width:100%;margin-bottom:14px"><thead><tr><th>Invoice #</th><th>Items</th><th>Total</th><th>Payment</th><th>Date</th></tr></thead><tbody>'+
    invs.slice().reverse().map(function(i){ return '<tr><td><b>'+i.invNo+'</b></td><td>'+i.items.length+'</td><td>Rs.'+i.total.toFixed(2)+'</td><td>'+i.payment+'</td><td>'+i.date+'</td></tr>'; }).join('')+'</tbody></table>':'')+
    (reps.length?'<div style="font-size:13px;font-weight:700;margin-bottom:6px;color:var(--warning)">ğŸ”§ Repairs</div><table style="width:100%;margin-bottom:14px"><thead><tr><th>Device</th><th>Issue</th><th>Cost</th><th>Status</th><th>Date</th></tr></thead><tbody>'+
    reps.slice().reverse().map(function(r){ return '<tr><td>'+r.device+'</td><td style="max-width:120px;overflow:hidden">'+r.issue.substring(0,40)+'</td><td>Rs.'+r.cost.toFixed(2)+'</td><td>'+sbadge(r.status)+'</td><td>'+r.date+'</td></tr>'; }).join('')+'</tbody></table>':'')+
    (ords.length?'<div style="font-size:13px;font-weight:700;margin-bottom:6px;color:var(--info)">ğŸŒ Orders</div><table style="width:100%;margin-bottom:14px"><thead><tr><th>Order ID</th><th>Amount</th><th>Status</th><th>Date</th></tr></thead><tbody>'+
    ords.slice().reverse().map(function(o){ return '<tr><td>#'+String(o.id).slice(-5)+'</td><td>Rs.'+(o.amount||0).toFixed(2)+'</td><td>'+sbadge(o.status)+'</td><td>'+o.date+'</td></tr>'; }).join('')+'</tbody></table>':'')+
    (!invs.length&&!reps.length&&!ords.length?'<div class="empty"><div class="ei">ğŸ“‹</div>No transaction history</div>':'');
  openM('m-cust-hist');
}

// =========== INVOICES ===========
function renderInv2(){
  var tb=document.getElementById('inv2-tbl'); if(!tb) return;
  var q=(document.getElementById('inv2-q')?document.getElementById('inv2-q').value:'').toLowerCase();
  var rows=db.invoices.slice().reverse().filter(function(inv){
    return !q || inv.customer.toLowerCase().includes(q) || inv.invNo.toLowerCase().includes(q);
  });
  var cnt=document.getElementById('inv-count');
  if(cnt) cnt.textContent='Total: '+db.invoices.length+' invoice(s)';
  tb.innerHTML=rows.length?rows.map(function(inv){
    return '<tr><td><b>'+inv.invNo+'</b></td><td>'+inv.customer+'</td><td>'+inv.items.length+' item(s)</td><td><b>Rs. '+inv.total.toFixed(2)+'</b></td><td><span class="badge bs">'+inv.payment+'</span></td><td>'+inv.date+'</td><td style="white-space:nowrap"><button class="btn bo bsm" onclick="showInv('+inv.id+')" style="margin-right:3px">ğŸ§¾ View</button><button class="btn bd2 bsm" onclick="delInv('+inv.id+')">ğŸ—‘ï¸</button></td></tr>';
  }).join(''):'<tr><td colspan="7" class="empty"><div class="ei">ğŸ§¾</div>No invoices found</td></tr>';
}
function delInv(id){
  if(!confirm('Delete this invoice? Cannot undo!')) return;
  db.invoices=db.invoices.filter(function(i){ return i.id!==id; });
  saveDB(); renderInv2(); updateDash(); toast('ğŸ—‘ï¸ Invoice deleted','var(--danger)');
}
var currentInvId=null;
function showInv(id){
  currentInvId=id;
  var inv=db.invoices.find(function(i){ return i.id===id; }); if(!inv) return;
  var s=db.settings;
  var el=document.getElementById('inv-content'); if(!el) return;
  el.innerHTML='<h2>'+s.shopName+'</h2><p style="text-align:center;color:#666;font-size:11px">'+[s.phone,s.email,s.address].filter(Boolean).join(' | ')+'</p><div class="inv-line"></div><div class="inv-row"><span><b>Invoice:</b> '+inv.invNo+'</span><span><b>Date:</b> '+inv.date+'</span></div><div class="inv-row"><span><b>Customer:</b> '+inv.customer+'</span><span><b>Payment:</b> '+inv.payment+'</span></div><div class="inv-line"></div><table style="width:100%;font-size:12px"><tr style="background:#f5f5ff"><th style="padding:5px">Item</th><th style="text-align:center">Qty</th><th style="text-align:right">Price</th><th style="text-align:right">Total</th></tr>'+inv.items.map(function(i){ return '<tr><td style="padding:4px">'+i.name+'</td><td style="text-align:center">'+i.qty+'</td><td style="text-align:right">Rs.'+i.price.toFixed(2)+'</td><td style="text-align:right">Rs.'+(i.price*i.qty).toFixed(2)+'</td></tr>'; }).join('')+'</table><div class="inv-line"></div><div class="inv-row"><span>Subtotal</span><span>Rs. '+inv.subtotal.toFixed(2)+'</span></div>'+(inv.discount>0?'<div class="inv-row"><span>Discount</span><span>- Rs. '+inv.discount.toFixed(2)+'</span></div>':'')+(inv.tax>0?'<div class="inv-row"><span>Tax ('+inv.taxPct+'%)</span><span>+ Rs. '+inv.tax.toFixed(2)+'</span></div>':'')+'<div class="inv-row" style="font-size:16px;font-weight:800;color:#6c63ff"><span>TOTAL</span><span>Rs. '+inv.total.toFixed(2)+'</span></div><div class="inv-line"></div><p style="text-align:center;color:#888;font-size:11px">'+s.note+'</p>'+(s.whatsapp?'<p style="text-align:center;color:#888;font-size:11px">ğŸ“± '+s.whatsapp+'</p>':'')+(s.fb?'<p style="text-align:center;color:#888;font-size:11px">ğŸŒ '+s.fb+'</p>':'');
  openM('m-inv');
}

// =========== ORDER BILL & PAYMENT ===========
function showOBill(id, pendingMode){
  var o=db.orders.find(function(x){ return x.id===id; }); if(!o) return;
  var s=db.settings;
  var pays=o.payments||[];
  var paid=pays.reduce(function(sum,p){ return sum+p.amount; },0);
  var bal=(o.amount||0)-paid;
  var ps=pendingMode?'Pending Payment':(o.paymentStatus||'Unpaid');
  var pc=ps==='Paid'?'#00c853':ps==='Partial'?'#ff6d00':'#d50000';

  // Pending bill watermark section
  var pendingSection='';
  if(pendingMode){
    pendingSection='<div style="border:2px dashed #ff6d00;border-radius:8px;padding:10px;text-align:center;margin:10px 0;background:#fff8f0"><div style="font-size:15px;font-weight:800;color:#ff6d00">â³ PENDING PAYMENT</div><div style="font-size:11px;color:#888;margin-top:3px">Please complete payment to confirm order</div></div>';
  }

  var el=document.getElementById('obill-content'); if(!el) return;
  el.innerHTML=
    '<h2>'+(s.shopName||'ST Mobile & Designing')+'</h2>'+
    '<p style="text-align:center;color:#666;font-size:11px">'+[s.phone,s.email,s.address].filter(Boolean).join(' | ')+'</p>'+
    '<div class="inv-line"></div>'+
    '<div class="inv-row"><span><b>Bill No:</b> ORD-'+String(o.id).slice(-5)+'</span><span><b>Date:</b> '+o.date+'</span></div>'+
    '<div class="inv-row"><span><b>Customer:</b> '+o.customer+'</span><span><b>Phone:</b> '+o.phone+'</span></div>'+
    '<div class="inv-row"><span><b>Platform:</b> '+o.platform+'</span><span><b>Order Status:</b> '+o.status+'</span></div>'+
    '<div class="inv-line"></div>'+
    '<table style="width:100%;font-size:12px"><tr style="background:#f5f5ff"><th style="padding:5px;text-align:left">#</th><th style="padding:5px;text-align:left">Service / Item</th><th style="text-align:right;padding:5px">Amount</th></tr>'+
    (o.items&&o.items.length?o.items.map(function(item,i){
      return '<tr><td style="padding:5px;color:#888">'+(i+1)+'</td><td style="padding:5px">'+item.desc+(item.frameSize&&item.frameSize!==''?'<br><small style="color:#666">ğŸ–¼ï¸ '+item.frameSize+'</small>':'')+'</td><td style="text-align:right;padding:5px">Rs. '+(parseFloat(item.amount)||0).toFixed(2)+'</td></tr>';
    }).join(''):('<tr><td colspan="2" style="padding:5px">'+o.service+'</td><td style="text-align:right;padding:5px">Rs. '+(o.amount||0).toFixed(2)+'</td></tr>'))+
    '</table>'+
    '<div class="inv-line"></div>'+
    (o.delivery>0?'<div class="inv-row" style="font-size:12px"><span>Items Subtotal</span><span>Rs. '+(o.subtotal||o.amount-o.delivery||0).toFixed(2)+'</span></div>':'')+ 
    (o.delivery>0?'<div class="inv-row" style="font-size:12px"><span>ğŸšš Delivery Charge</span><span>Rs. '+o.delivery.toFixed(2)+'</span></div>':'')+
    '<div class="inv-row" style="font-size:15px;font-weight:800;color:#6c63ff"><span>ORDER TOTAL</span><span>Rs. '+(o.amount||0).toFixed(2)+'</span></div>'+
    '<div class="inv-line"></div>'+
    pendingSection+
    (pays.length && !pendingMode ?
      '<p style="font-size:11px;font-weight:700;margin-bottom:4px">ğŸ’³ PAYMENT HISTORY</p>'+
      pays.map(function(p){ return '<div class="inv-row" style="font-size:11px"><span>'+p.date+' â€” '+p.method+(p.note?' ('+p.note+')':'')+'</span><span style="color:#00c853">Rs. '+p.amount.toFixed(2)+'</span></div>'; }).join('')+
      '<div class="inv-line"></div>'+
      '<div class="inv-row" style="font-size:13px"><span>Total Paid</span><span style="color:#00c853;font-weight:700">Rs. '+paid.toFixed(2)+'</span></div>'+
      '<div class="inv-row" style="font-size:14px;font-weight:800"><span>Balance Due</span><span style="color:'+(bal<=0?'#00c853':'#ff6d00')+'">Rs. '+Math.max(0,bal).toFixed(2)+'</span></div>'+
      '<div style="text-align:center;margin:8px 0"><span style="background:'+pc+';color:#fff;padding:3px 14px;border-radius:20px;font-size:12px;font-weight:700">'+ps+'</span></div>'
    : !pendingMode ? '<p style="color:#ff6d00;text-align:center;font-size:12px">âš ï¸ No payment received yet</p>' : '')+
    (ps!=='Paid'?
      '<div style="background:#f0f8ff;border:1.5px solid #b3d4f0;border-radius:9px;padding:12px 14px;margin:10px 0;font-size:12px;color:#111;line-height:2">' +
      '<div style="font-weight:800;font-size:13px;color:#1a5fa8;margin-bottom:6px">ğŸ“Œ à¶œà·™à·€à·“à¶¸à·Š à·€à·’à·ƒà·Šà¶­à¶»:</div>' +
      (s.bank?'<div>ğŸ’³ <b>à¶¶à·à¶‚à¶šà·”à·€:</b> '+s.bank+'</div>':'')+
      (s.accNo?'<div>ğŸ“ <b>à¶œà·’à¶«à·”à¶¸à·Š à¶…à¶‚à¶šà¶º:</b> '+s.accNo+'</div>':'')+
      (s.accName?'<div>ğŸ“ <b>à¶±à¶¸:</b> '+s.accName+'</div>':'')+
      (s.branch?'<div>ğŸŒ <b>à·ƒà·Šà¶®à·à¶±à¶º:</b> '+s.branch+'</div>':'')+
      '<div style="margin-top:8px;font-weight:800;color:#1a5fa8">ğŸ’¸ à¶œà·™à·€à·“à¶¸ à¶½à·šà·ƒà·’à¶ºà·™à¶±à·Šà¶¸ à¶šà¶»à¶±à·Šà¶±:</div>' +
      '<div>1. à¶”à¶¶à·š à¶¢à·à¶ºà·à¶»à·–à¶´à¶º à¶‘à¶©à·’à¶§à·Š à¶šà¶»à¶œà¶±à·Šà¶± à¶•à¶± à·€à·’à¶¯à·’à¶º à¶…à¶´à·’à¶§ à¶šà·’à¶ºà¶±à·Šà¶±.</div>' +
      '<div>2. à¶¸à·”à¶¯à¶½ à¶œà·’à¶«à·”à¶¸à¶§ à¶¯à¶¸à¶½à·, à¶œà·™à·€à·“à¶¸à·š à¶»à·’à·ƒà·’à¶§à·Š à¶‘à¶š à¶…à¶´à·’à¶§ à¶‘à·€à¶±à·Šà¶± (WhatsApp/Messenger à·„à¶»à·„à·).</div>' +
      '<div>3. à¶”à¶±à·Šà¶± à¶•à¶©à¶»à·Š à¶‘à¶š à¶½à·‘à·ƒà·Šà¶­à·’! à¶…à¶´à·’ à¶‰à¶šà·Šà¶¸à¶±à¶§ à·€à·à¶©à·š à¶œà·œà¶©à¶¯à·à¶½à· à¶”à¶ºà·à¶§ à¶½à·ƒà·Šà·ƒà¶± à¶¢à·à¶ºà·à¶»à·–à¶´à¶º à¶‘à·€à¶±à·Šà¶±à¶¸à·Š!</div>' +
      '<div style="margin-top:8px;font-size:11px;color:#444">ğŸ’¡ à¶”à¶¶à·š à¶œà·™à·€à·“à¶¸ à·ƒà¶¸à·Šà¶´à·–à¶»à·Šà¶« à·€à·”à¶«à·à¶¸, à¶’ à¶œà·à¶± à¶…à¶´à·’à¶§ à¶¯à·à¶±à·”à¶¸à·Š à¶¯à·™à¶±à·Šà¶±. à¶‘à¶­à¶šà·œà¶§ à¶”à¶ºà·à¶œà·š à¶½à·ƒà·Šà·ƒà¶± à¶¸à¶­à¶šà¶ºà¶±à·Š à¶‘à¶©à·’à¶§à·Š à¶šà¶»à¶½à· à¶‰à¶šà·Šà¶¸à¶±à¶§ à¶”à¶ºà·à¶§ à¶½à¶¶à· à¶¯à·™à¶±à·Šà¶± à¶…à¶´à·’ à¶´à¶§à¶±à·Š à¶œà¶±à·Šà¶±à·€à·!</div>' +
      '<div style="margin-top:6px;font-size:12px;color:#1a5fa8;font-weight:700">ğŸ˜Š à¶”à¶ºà·à¶½à¶œà·š à·€à·’à·à·Šà·€à·à·ƒà¶ºà¶§ à¶œà·œà¶©à¶šà·Š à·ƒà·Šà¶­à·–à¶­à·’.</div>' +
      '</div>'
    :'')+
    '<div class="inv-line"></div>'+
    (o.dueDate?'<p style="font-size:11px;color:#ff6d00"><b>â° Delivery Date:</b> '+o.dueDate+'</p>':'')+
    (o.advance>0?'<p style="font-size:11px;color:#00c853"><b>ğŸ’µ Advance Paid:</b> Rs. '+o.advance.toFixed(2)+'</p>':'')+
    (o.notes?'<p style="font-size:11px;color:#666"><b>Notes:</b> '+o.notes+'</p>':'')+
    '<p style="text-align:center;color:#888;font-size:11px;margin-top:8px">'+s.note+'</p>'+
    (s.whatsapp?'<p style="text-align:center;color:#888;font-size:11px">ğŸ“± '+s.whatsapp+'</p>':'')+
    (s.fb?'<p style="text-align:center;color:#888;font-size:11px">ğŸŒ '+s.fb+'</p>':'');
  openM('m-obill');
}
function openPay(id){
  var o=db.orders.find(function(x){ return x.id===id; }); if(!o) return;
  if(!o.payments) o.payments=[];
  var paid=o.payments.reduce(function(s,p){ return s+p.amount; },0);
  var bal=(o.amount||0)-paid;
  document.getElementById('py-ord-id').value=id;
  document.getElementById('py-id').textContent='#'+String(id).slice(-5);
  document.getElementById('py-stat').innerHTML=sbadge(o.status);
  document.getElementById('py-cust').textContent=o.customer;
  document.getElementById('py-phone').textContent=o.phone;
  document.getElementById('py-svc').textContent=o.service;
  document.getElementById('py-total').textContent='Rs. '+(o.amount||0).toFixed(2);
  document.getElementById('py-amt').value=bal>0?bal.toFixed(2):'';
  document.getElementById('py-date').value=new Date().toISOString().split('T')[0];
  document.getElementById('py-note').value='';
  document.querySelectorAll('#m-pay .paybtn').forEach(function(b){ b.classList.remove('ap'); });
  var first=document.querySelector('#m-pay .paybtn'); if(first) first.classList.add('ap');
  selOPayment='Cash';
  calcPay();
  openM('m-pay');
}
function selOPay(m,el){
  selOPayment=m;
  document.querySelectorAll('#m-pay .paybtn').forEach(function(b){ b.classList.remove('ap'); });
  if(el) el.classList.add('ap');
}
function calcPay(){
  var id=parseInt(document.getElementById('py-ord-id').value);
  var o=db.orders.find(function(x){ return x.id===id; }); if(!o) return;
  if(!o.payments) o.payments=[];
  var tot=o.amount||0;
  var prev=o.payments.reduce(function(s,p){ return s+p.amount; },0);
  var thisA=parseFloat(document.getElementById('py-amt').value)||0;
  var bal=tot-prev-thisA;
  var el;
  el=document.getElementById('pc-tot'); if(el) el.textContent='Rs. '+tot.toFixed(2);
  el=document.getElementById('pc-prev'); if(el) el.textContent='Rs. '+prev.toFixed(2);
  el=document.getElementById('pc-this'); if(el) el.textContent='Rs. '+thisA.toFixed(2);
  el=document.getElementById('pc-bal'); if(el){ el.textContent='Rs. '+Math.max(0,bal).toFixed(2); el.style.color=bal<=0?'var(--success)':'var(--warning)'; }
}
function savePayment(genBill){
  var id=parseInt(document.getElementById('py-ord-id').value);
  var o=db.orders.find(function(x){ return x.id===id; }); if(!o) return;
  var amt=parseFloat(document.getElementById('py-amt').value)||0;
  if(amt<=0){ toast('âŒ Enter amount','var(--danger)'); return; }
  if(!o.payments) o.payments=[];
  o.payments.push({ id:Date.now(), amount:amt, method:selOPayment, date:document.getElementById('py-date').value, note:document.getElementById('py-note').value.trim() });
  var totalPaid=o.payments.reduce(function(s,p){ return s+p.amount; },0);
  o.paymentStatus=totalPaid>=(o.amount||0)?'Paid':'Partial';
  saveDB(); renderOrd(); updateDash();
  closeM('m-pay');
  toast('âœ… Payment saved! '+(o.paymentStatus==='Paid'?'ğŸ‰ Fully Paid!':'âš ï¸ Partial'));
  if(genBill) showOBill(id);
}

// =========== PRINT / PNG / PDF ===========
var INV_CSS='*{box-sizing:border-box;margin:0;padding:0}body{font-family:"Segoe UI",sans-serif;padding:24px;max-width:480px;margin:auto;background:#fff;color:#111}h2{color:#6c63ff;text-align:center;margin-bottom:4px;font-size:19px}table{width:100%;border-collapse:collapse;font-size:12px}th{background:#f0f0ff;padding:6px 8px;text-align:left}td{padding:5px 8px;border-bottom:1px solid #eee}.inv-row{display:flex;justify-content:space-between;margin:4px 0;font-size:13px}.inv-line{border-top:1px dashed #ccc;margin:9px 0}p{margin:2px 0;font-size:12px}';

function doPrint(cid){
  var el=document.getElementById(cid); if(!el) return;
  var html='<!DOCTYPE html><html><head><meta charset="UTF-8"><style>'+INV_CSS+'@media print{body{margin:0;padding:16px}}</style></head><body>'+el.innerHTML+'<script>window.onload=function(){window.print();window.onafterprint=function(){window.close();}}<\/script></body></html>';
  var blob=new Blob([html],{type:'text/html'});
  var url=URL.createObjectURL(blob);
  var iframe=document.createElement('iframe');
  iframe.style.cssText='position:fixed;top:-9999px;left:-9999px;width:0;height:0;border:none;';
  iframe.src=url;
  document.body.appendChild(iframe);
  iframe.onload=function(){
    try{
      iframe.contentWindow.focus();
      iframe.contentWindow.print();
    }catch(e){
      // fallback - open in new tab
      window.open(url,'_blank');
    }
    setTimeout(function(){ document.body.removeChild(iframe); URL.revokeObjectURL(url); },5000);
  };
  toast('ğŸ–¨ï¸ Print dialog opening...','var(--info)');
}

async function doPNG(cid, fname){
  var el=document.getElementById(cid); if(!el){ toast('âŒ Error','var(--danger)'); return; }
  toast('â³ Generating...','var(--warning)');
  var prev={ bg:el.style.background, color:el.style.color, padding:el.style.padding, width:el.style.width };
  el.style.background='#ffffff';
  el.style.color='#111111';
  el.style.padding='24px';
  el.style.width='460px';
  try {
    var canvas=await html2canvas(el,{ scale:2, backgroundColor:'#ffffff', useCORS:true, logging:false });
    var a=document.createElement('a');
    a.href=canvas.toDataURL('image/png');
    a.download=fname+'-'+Date.now()+'.png';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    toast('âœ… PNG Downloaded!');
  } catch(e) {
    toast('âŒ PNG failed: '+e.message,'var(--danger)');
  }
  el.style.background=prev.bg;
  el.style.color=prev.color;
  el.style.padding=prev.padding;
  el.style.width=prev.width;
}

function doPDF(cid, fname){
  var el=document.getElementById(cid); if(!el) return;
  var html='<!DOCTYPE html><html><head><meta charset="UTF-8"><title>'+fname+'</title><style>'+INV_CSS+'@media print{body{margin:0;padding:16px}}</style></head><body>'+el.innerHTML+'<script>window.onload=function(){setTimeout(function(){window.print();},300);window.onafterprint=function(){window.close();};}<\/script></body></html>';
  var blob=new Blob([html],{type:'text/html'});
  var url=URL.createObjectURL(blob);
  var iframe=document.createElement('iframe');
  iframe.style.cssText='position:fixed;top:-9999px;left:-9999px;width:1px;height:1px;border:none;';
  iframe.src=url;
  document.body.appendChild(iframe);
  iframe.onload=function(){
    try{
      iframe.contentWindow.focus();
      iframe.contentWindow.print();
    }catch(e){
      window.open(url,'_blank');
    }
    setTimeout(function(){ if(document.body.contains(iframe)) document.body.removeChild(iframe); URL.revokeObjectURL(url); },8000);
  };
  toast('ğŸ–¨ï¸ Print dialog â€” "Save as PDF" select à¶šà¶»à¶±à·Šà¶±!','var(--info)');
}

// =========== BACKUP / RESTORE ===========
function exportDB(){
  try {
    var data = JSON.stringify(db, null, 2);
    var blob = new Blob([data], {type: 'application/json'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    var now = new Date();
    var stamp = now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0')+'-'+String(now.getDate()).padStart(2,'0')+'_'+String(now.getHours()).padStart(2,'0')+String(now.getMinutes()).padStart(2,'0');
    a.href = url;
    a.download = 'ST-Mobile-Backup-'+stamp+'.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    setTimeout(function(){ URL.revokeObjectURL(url); }, 3000);
    toast('âœ… Backup downloaded! (' + stamp + ')');
  } catch(e) {
    toast('âŒ Export failed: '+e.message, 'var(--danger)');
  }
}

function importDB(input){
  var file = input.files[0]; if(!file) return;
  if(!file.name.endsWith('.json')){ toast('âŒ JSON file à¶‘à¶šà¶šà·Š select à¶šà¶»à¶±à·Šà¶±!','var(--danger)'); return; }
  var reader = new FileReader();
  reader.onload = function(e){
    try {
      var parsed = JSON.parse(e.target.result);
      // Validate - must have at least orders or repairs or products
      if(typeof parsed !== 'object' || (!parsed.orders && !parsed.repairs && !parsed.products)){
        toast('âŒ Invalid backup file!', 'var(--danger)'); return;
      }
      if(!confirm('âš ï¸ à¶¯à·à¶±à¶§ à¶­à·’à¶¶à·™à¶± à·ƒà·’à¶ºà¶½à·” data replace à·€à·™à¶±à·€à·! Continue à¶šà¶»à¶±à·Šà¶±à¶¯?')) return;
      db = Object.assign({}, db, parsed);
      saveDB();
      renderAll();
      toast('âœ… Data restore à·ƒà·à¶»à·Šà¶®à¶šà¶ºà·’! ğŸ‰');
    } catch(ex) {
      toast('âŒ File read error: '+ex.message, 'var(--danger)');
    }
    input.value = '';
  };
  reader.readAsText(file);
}

// =========== SETTINGS ===========
function loadSettingsFrm(){
  var s=db.settings;
  var ids=['s-name','s-phone','s-email','s-addr','s-wa','s-fb','s-prefix','s-note','s-bank','s-accno','s-accname','s-branch'];
  var keys=['shopName','phone','email','address','whatsapp','fb','prefix','note','bank','accNo','accName','branch'];
  ids.forEach(function(id,i){ var el=document.getElementById(id); if(el) el.value=s[keys[i]]||''; });
  var st=document.getElementById('pin-status');
  if(st){ var p=getSQLPin(); st.textContent=p?'âœ… PIN active':'âŒ PIN disabled'; }
}
function saveSettings(){
  var s=db.settings;
  s.shopName=document.getElementById('s-name').value;
  s.phone=document.getElementById('s-phone').value;
  s.email=document.getElementById('s-email').value;
  s.address=document.getElementById('s-addr').value;
  s.whatsapp=document.getElementById('s-wa').value;
  s.fb=document.getElementById('s-fb').value;
  s.prefix=document.getElementById('s-prefix').value||'INV';
  s.note=document.getElementById('s-note').value;
  s.bank=document.getElementById('s-bank').value;
  s.accNo=document.getElementById('s-accno').value;
  s.accName=document.getElementById('s-accname').value;
  s.branch=document.getElementById('s-branch').value;
  saveDB(); toast('âœ… Settings saved!');
}
function setClr(clr,el){
  applyTheme(clr);
  document.querySelectorAll('.cswatch').forEach(function(s){ s.classList.remove('ac'); });
  if(el) el.classList.add('ac');
  db.settings.theme=clr; saveDB();
}
function applyTheme(clr){ document.documentElement.style.setProperty('--primary',clr); }
function clrData(type){
  if(!confirm('Clear '+type+' data? Cannot undo!')) return;
  if(type==='all'){ db.products=[];db.repairs=[];db.orders=[];db.customers=[];db.invoices=[]; }
  else if(type==='invoices') db.invoices=[];
  else if(type==='repairs') db.repairs=[];
  else if(type==='orders') db.orders=[];
  saveDB(); renderAll(); toast('ğŸ—‘ï¸ Cleared','var(--danger)');
}


// =========== PIN LOCK ===========
var pinEntry = '';
var PIN_KEY = 'st-pos-pin';

function initPIN(){
  var savedPin = getSQLPin();
  if(savedPin){
    var ps = document.getElementById('pin-screen');
    if(ps){ ps.style.display='flex'; updatePinDots(); }
    var hint = document.getElementById('pin-hint');
    if(hint) hint.textContent = 'âš™ï¸ Settings > PIN Lock à¶šà·’à¶ºà¶½à· PIN remove à¶šà¶»à¶±à·Šà¶± à¶´à·”à·…à·”à·€à¶±à·Š';
  }
  var st=document.getElementById('pin-status');
  if(st) st.textContent = savedPin ? 'âœ… PIN active â€” '+(savedPin.length)+' digits' : 'âŒ PIN à¶±à·‘ (disabled)';
}

function pinKey(k){
  var err=document.getElementById('pin-err'); if(err) err.textContent='';
  if(k==='clr'){ pinEntry=''; updatePinDots(); return; }
  if(k==='del'){ pinEntry=pinEntry.slice(0,-1); updatePinDots(); return; }
  if(pinEntry.length>=4) return;
  pinEntry+=k;
  updatePinDots();
  if(pinEntry.length===4){
    setTimeout(function(){
      var saved=getSQLPin();
      if(pinEntry===saved){
        var ps=document.getElementById('pin-screen');
        if(ps) ps.style.display='none';
        pinEntry='';
        updatePinDots();
      } else {
        pinEntry='';
        updatePinDots();
        if(err){ err.textContent='âŒ PIN incorrect!'; setTimeout(function(){ err.textContent=''; },2000); }
        // shake animation
        document.querySelectorAll('.pin-dot').forEach(function(d){ d.style.animation='pulse 0.3s'; setTimeout(function(){ d.style.animation=''; },300); });
      }
    }, 150);
  }
}

function updatePinDots(){
  for(var i=0;i<4;i++){
    var d=document.getElementById('pd'+i);
    if(d){ if(i<pinEntry.length) d.classList.add('filled'); else d.classList.remove('filled'); }
  }
}

function savePIN(){
  var p1=document.getElementById('s-pin').value;
  var p2=document.getElementById('s-pin2').value;
  if(!p1){ toast('âŒ PIN enter à¶šà¶»à¶±à·Šà¶±','var(--danger)'); return; }
  if(p1.length!==4){ toast('âŒ 4-digit PIN à¶•à¶±à·š','var(--danger)'); return; }
  if(p1!==p2){ toast('âŒ PIN match à·€à·™à¶±à·Šà¶±à·š à¶±à·‘!','var(--danger)'); return; }
  setSQLPin(p1);
  document.getElementById('s-pin').value='';
  document.getElementById('s-pin2').value='';
  var st=document.getElementById('pin-status');
  if(st) st.textContent='âœ… PIN set à¶šà·…à·! (SQLite ğŸ”)';
  toast('âœ… PIN set à¶šà·…à·! Next time lock à·€à·™à¶±à·€à· ğŸ”');
}

function clearPIN(){
  if(!confirm('PIN remove à¶šà¶»à¶±à·Šà¶±à¶¯?')) return;
  clearSQLPin();
  var st=document.getElementById('pin-status');
  if(st) st.textContent='âŒ PIN disabled';
  toast('ğŸ”“ PIN removed!');
}

// =========== DARK / LIGHT MODE ===========
function toggleDark(){
  document.body.classList.toggle('light');
  var isLight=document.body.classList.contains('light');
  localStorage.setItem('st-pos-theme-mode', isLight?'light':'dark');
  var btn=document.getElementById('dark-btn');
  if(btn) btn.textContent=isLight?'â˜€ï¸':'ğŸŒ™';
}

function initThemeMode(){
  var mode=localStorage.getItem('st-pos-theme-mode');
  if(mode==='light'){
    document.body.classList.add('light');
    var btn=document.getElementById('dark-btn');
    if(btn) btn.textContent='â˜€ï¸';
  }
}

// =========== NOTIFICATIONS ===========
// =========== NOTIFICATION DISMISS HELPERS ===========
function getDismissedNotifs(){
  try { return JSON.parse(localStorage.getItem('st_dismissed_notifs')||'[]'); } catch(e){ return []; }
}
function saveDismissedNotifs(arr){
  try { localStorage.setItem('st_dismissed_notifs', JSON.stringify(arr)); } catch(e){}
}
function dismissNotif(key){
  var d=getDismissedNotifs(); if(d.indexOf(key)===-1) d.push(key);
  saveDismissedNotifs(d); showNotifs(); updateNotifBadge();
}
function clearAllNotifs(){
  var all=getNotifications(false);
  var d=getDismissedNotifs();
  all.forEach(function(n){ if(d.indexOf(n.key)===-1) d.push(n.key); });
  saveDismissedNotifs(d); showNotifs(); updateNotifBadge();
}

function getNotifications(filterDismissed){
  if(filterDismissed===undefined) filterDismissed=true;
  var dismissed=getDismissedNotifs();
  var notifs=[];
  var today=new Date(); today.setHours(0,0,0,0);
  // Overdue repairs
  db.repairs.forEach(function(r){
    if(r.dueDate && r.status!=='Delivered'){
      var due=new Date(r.dueDate); due.setHours(0,0,0,0);
      var diff=Math.round((due-today)/(1000*60*60*24));
      if(diff<0) notifs.push({type:'danger',icon:'ğŸ”§',msg:'Overdue Repair: '+r.customer+' â€” '+r.device+' ('+Math.abs(diff)+' days ago)',id:r.id,page:'repairs',key:'rep-overdue-'+r.id});
      else if(diff===0) notifs.push({type:'warning',icon:'âš ï¸',msg:'Repair due TODAY: '+r.customer+' â€” '+r.device,id:r.id,page:'repairs',key:'rep-today-'+r.id});
      else if(diff<=2) notifs.push({type:'warning',icon:'â°',msg:'Repair due in '+diff+' day(s): '+r.customer+' â€” '+r.device,id:r.id,page:'repairs',key:'rep-soon-'+r.id+'-'+diff});
    }
  });
  // Overdue orders
  db.orders.forEach(function(o){
    if(o.dueDate && o.status!=='Delivered'){
      var due=new Date(o.dueDate); due.setHours(0,0,0,0);
      var diff=Math.round((due-today)/(1000*60*60*24));
      if(diff<0) notifs.push({type:'danger',icon:'ğŸŒ',msg:'Overdue Order: '+o.customer+' ('+Math.abs(diff)+' days ago)',id:o.id,page:'orders',key:'ord-overdue-'+o.id});
      else if(diff===0) notifs.push({type:'warning',icon:'âš ï¸',msg:'Order due TODAY: '+o.customer,id:o.id,page:'orders',key:'ord-today-'+o.id});
      else if(diff<=2) notifs.push({type:'warning',icon:'â°',msg:'Order due in '+diff+' day(s): '+o.customer,id:o.id,page:'orders',key:'ord-soon-'+o.id+'-'+diff});
    }
  });
  // Low stock
  db.products.forEach(function(p){
    if(p.stock<=p.minStock) notifs.push({type:'warning',icon:'ğŸ“¦',msg:'Low Stock: '+p.name+' â€” '+p.stock+' remaining',page:'inventory',key:'stock-'+p.id+'-'+p.stock});
  });
  // Unpaid orders
  var unpaid=db.orders.filter(function(o){ return o.paymentStatus!=='Paid' && o.status!=='Delivered'; });
  if(unpaid.length) notifs.push({type:'info',icon:'ğŸ’³',msg:unpaid.length+' unpaid order(s) pending',page:'orders',key:'unpaid-orders-'+unpaid.length});
  // Overdue credits
  if(db.credits) db.credits.forEach(function(c){
    if(c.status==='Paid') return;
    var today2=new Date(); today2.setHours(0,0,0,0);
    c.schedule.forEach(function(s,si){
      if(!s.paid){ var due=new Date(s.dueDate); due.setHours(0,0,0,0); var diff=Math.round((due-today2)/(1000*60*60*24));
        if(diff<0) notifs.push({type:'danger',icon:'ğŸ’³',msg:'Overdue Credit: '+c.customer+' â€” Rs.'+s.amount.toFixed(0)+' ('+Math.abs(diff)+'d ago)',page:'credits',key:'cr-overdue-'+c.id+'-'+si});
        else if(diff===0) notifs.push({type:'warning',icon:'ğŸ’³',msg:'Credit payment due TODAY: '+c.customer,page:'credits',key:'cr-today-'+c.id+'-'+si});
      }
    });
  });
  if(filterDismissed) return notifs.filter(function(n){ return dismissed.indexOf(n.key)===-1; });
  return notifs;
}

function updateNotifBadge(){
  var notifs=getNotifications();
  var badge=document.getElementById('notif-cnt');
  if(badge){
    if(notifs.length>0){ badge.style.display='flex'; badge.textContent=notifs.length>9?'9+':notifs.length; }
    else badge.style.display='none';
  }
}

function showNotifs(){
  var notifs=getNotifications();
  var body=document.getElementById('notif-body');
  if(!body) return;
  if(notifs.length===0){
    body.innerHTML='<div style="text-align:center;padding:30px;color:var(--muted)"><div style="font-size:36px">âœ…</div><div style="margin-top:8px">All clear! Nothing urgent</div></div>';
  } else {
    body.innerHTML=
      '<div style="display:flex;justify-content:flex-end;margin-bottom:8px">' +
        '<button class="btn bd2 bsm" onclick="clearAllNotifs()">ğŸ—‘ï¸ Clear All</button>' +
      '</div>' +
      notifs.map(function(n){
        var clr=n.type==='danger'?'var(--danger)':n.type==='warning'?'var(--warning)':'var(--info)';
        var key=n.key.replace(/'/g,"\\'");
        return '<div style="display:flex;align-items:flex-start;gap:10px;padding:10px;border-radius:8px;margin-bottom:6px;background:rgba(0,0,0,0.1);border-left:3px solid '+clr+'">'+
          '<span style="font-size:18px;cursor:pointer" onclick="closeM(\'m-notif\');goPage(\''+n.page+'\')">'+n.icon+'</span>'+
          '<span style="font-size:12px;flex:1;color:var(--text);cursor:pointer" onclick="closeM(\'m-notif\');goPage(\''+n.page+'\')">'+n.msg+'</span>'+
          '<button onclick="dismissNotif(\''+key+'\')" title="Dismiss" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:16px;line-height:1;padding:0 2px;flex-shrink:0" onmouseover="this.style.color=\'var(--danger)\'" onmouseout="this.style.color=\'var(--muted)\'">Ã—</button>'+
        '</div>';
      }).join('');
  }
  openM('m-notif');
}

// =========== WHATSAPP ===========
function waShareBill(){
  var el=document.getElementById('obill-content'); if(!el) return;
  var txt=el.innerText||el.textContent;
  // Get customer phone from bill
  var phone='';
  db.orders.forEach(function(o){
    if(el.innerHTML.includes(String(o.id).slice(-5))){ phone=o.phone; }
  });
  var msg=encodeURIComponent(txt.substring(0,1000));
  var url=phone?'https://wa.me/94'+phone.replace(/^0/,'').replace(/[^0-9]/g,'')+'?text='+msg:'https://wa.me/?text='+msg;
  window.open(url,'_blank');
}

function waShareRepBill(){
  var el=document.getElementById('rbill-content'); if(!el) return;
  var txt=el.innerText||el.textContent;
  var phone='';
  db.repairs.forEach(function(r){
    if(el.innerHTML.includes(String(r.id).slice(-4))){ phone=r.phone; }
  });
  var msg=encodeURIComponent(txt.substring(0,1000));
  var url=phone?'https://wa.me/94'+phone.replace(/^0/,'').replace(/[^0-9]/g,'')+'?text='+msg:'https://wa.me/?text='+msg;
  window.open(url,'_blank');
}

function waShareRepCustomer(id){
  var r=db.repairs.find(function(x){ return x.id===id; }); if(!r||!r.phone) { toast('âŒ Phone number à¶±à·‘','var(--danger)'); return; }
  var msg='Hi '+r.customer+', \n\nà¶”à¶¶à·š '+r.device+' repair status: *'+r.status+'*\n'+(r.dueDate?'Due Date: '+r.dueDate+'\n':'')+'Cost: Rs. '+(r.cost||0).toFixed(2)+'\n\n'+db.settings.shopName;
  var url='https://wa.me/94'+r.phone.replace(/^0/,'').replace(/[^0-9]/g,'')+'?text='+encodeURIComponent(msg);
  window.open(url,'_blank');
}

// =========== KEYBOARD SHORTCUTS ===========
document.addEventListener('keydown', function(e){
  // Don't trigger when typing in inputs
  if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA'||e.target.tagName==='SELECT') return;
  if(e.key==='F2'){ e.preventDefault(); goPage('pos'); }
  if(e.key==='F3'){ e.preventDefault(); openOrdModal(); }
  if(e.key==='F4'){ e.preventDefault(); openM('m-rep'); }
  if(e.key==='F5'){ e.preventDefault(); e.stopPropagation(); goPage('dashboard'); }
  if(e.key==='F6'){ e.preventDefault(); goPage('analytics'); }
  if(e.altKey && e.key==='d'){ e.preventDefault(); toggleDark(); }
  if(e.altKey && e.key==='n'){ e.preventDefault(); showNotifs(); }
  if(e.altKey && e.key==='b'){ e.preventDefault(); exportDB(); }
  if(e.key==='Escape'){ document.querySelectorAll('.moverlay.open').forEach(function(m){ m.classList.remove('open'); }); closeSidebar(); }
});

// =========== ENHANCED BG CANVAS ===========
function initBG(){
  var c=document.getElementById('bgc'); if(!c) return;
  var ctx=c.getContext('2d');
  function resize(){ c.width=window.innerWidth; c.height=window.innerHeight; }
  resize();
  window.addEventListener('resize', resize);

  var pts=[];
  for(var i=0;i<80;i++){
    pts.push({
      x:Math.random()*c.width, y:Math.random()*c.height,
      vx:(Math.random()-0.5)*0.5, vy:(Math.random()-0.5)*0.5,
      r:Math.random()*2.5+0.5,
      pulse: Math.random()*Math.PI*2,
      pulseSpeed: 0.02 + Math.random()*0.03
    });
  }

  // Mouse interaction
  var mouse = { x: -999, y: -999 };
  document.addEventListener('mousemove', function(e){ mouse.x=e.clientX; mouse.y=e.clientY; });

  function draw(){
    ctx.clearRect(0,0,c.width,c.height);
    var clr = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim()||'#6c63ff';
    var sec = getComputedStyle(document.documentElement).getPropertyValue('--secondary').trim()||'#f50057';

    pts.forEach(function(p){
      // Mouse repulsion
      var dx=p.x-mouse.x, dy=p.y-mouse.y, dist=Math.hypot(dx,dy);
      if(dist<120){ var force=((120-dist)/120)*0.4; p.vx+=dx/dist*force; p.vy+=dy/dist*force; }
      // Speed limit
      var speed=Math.hypot(p.vx,p.vy);
      if(speed>1.2){ p.vx/=speed*0.8; p.vy/=speed*0.8; }

      p.x+=p.vx; p.y+=p.vy;
      if(p.x<0||p.x>c.width) p.vx*=-1;
      if(p.y<0||p.y>c.height) p.vy*=-1;
      p.pulse+=p.pulseSpeed;
      var r=p.r*(0.7+0.3*Math.sin(p.pulse));

      // Gradient particle
      var grad=ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,r*3);
      grad.addColorStop(0, clr+'cc');
      grad.addColorStop(1, clr+'00');
      ctx.beginPath(); ctx.arc(p.x,p.y,r*3,0,Math.PI*2);
      ctx.fillStyle=grad; ctx.fill();
    });

    // Connections with gradient lines
    for(var i=0;i<pts.length;i++){
      for(var j=i+1;j<pts.length;j++){
        var d=Math.hypot(pts[i].x-pts[j].x,pts[i].y-pts[j].y);
        if(d<110){
          var alpha=(1-d/110)*0.35;
          var grad2=ctx.createLinearGradient(pts[i].x,pts[i].y,pts[j].x,pts[j].y);
          grad2.addColorStop(0, clr+(Math.round(alpha*255).toString(16).padStart(2,'0')));
          grad2.addColorStop(0.5, sec+(Math.round(alpha*128).toString(16).padStart(2,'0')));
          grad2.addColorStop(1, clr+(Math.round(alpha*255).toString(16).padStart(2,'0')));
          ctx.beginPath(); ctx.moveTo(pts[i].x,pts[i].y); ctx.lineTo(pts[j].x,pts[j].y);
          ctx.strokeStyle=grad2; ctx.lineWidth=0.7; ctx.stroke();
        }
      }
    }
    requestAnimationFrame(draw);
  }
  draw();
}

// =========== ANALYTICS ===========
var _anChart = null;
function renderAnalytics(){
  var yrSel=document.getElementById('an-year');
  if(yrSel && !yrSel.options.length){
    var cy=new Date().getFullYear();
    for(var y=cy;y>=cy-4;y--){ var o=document.createElement('option'); o.value=y; o.textContent=y; yrSel.appendChild(o); }
  }
  var yr=parseInt(yrSel?yrSel.value:new Date().getFullYear());
  var months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  var totalRev=db.invoices.reduce(function(s,i){ return s+(i.total||0); },0);
  var totalCost=db.invoices.reduce(function(s,inv){ return s+inv.items.reduce(function(ss,it){ var p=db.products.find(function(x){ return x.id===it.id; }); return ss+(p?(p.cost||0)*it.qty:0); },0); },0);
  var profit=totalRev-totalCost;
  var avg=db.invoices.length?totalRev/db.invoices.length:0;
  var el;
  el=document.getElementById('an-rev'); if(el) el.textContent='Rs. '+totalRev.toFixed(0);
  el=document.getElementById('an-profit'); if(el) el.textContent='Rs. '+profit.toFixed(0);
  el=document.getElementById('an-sales'); if(el) el.textContent=db.invoices.length;
  el=document.getElementById('an-avg'); if(el) el.textContent='Rs. '+avg.toFixed(0);
  // Monthly chart with Chart.js
  var monthly=months.map(function(_,mi){ return db.invoices.filter(function(inv){ var d=new Date(inv.date.split('/').reverse().join('-')); return d.getFullYear()===yr && d.getMonth()===mi; }).reduce(function(s,i){ return s+(i.total||0); },0); });
  var canvas=document.getElementById('an-chart');
  if(canvas && typeof Chart !== 'undefined'){
    if(_anChart){ _anChart.destroy(); }
    var clr = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim()||'#6c63ff';
    _anChart = new Chart(canvas.getContext('2d'), {
      type:'bar', data:{
        labels:months,
        datasets:[{
          label:'Revenue '+yr, data:monthly,
          backgroundColor: months.map(function(_,i){ return clr+(i%2===0?'cc':'88'); }),
          borderRadius:8, borderSkipped:false
        }]
      },
      options:{
        responsive:true, maintainAspectRatio:false,
        animation:{duration:800, easing:'easeOutQuart'},
        plugins:{
          legend:{labels:{color:'#e0e0ff',font:{size:11}}},
          tooltip:{backgroundColor:'#12122a',borderColor:clr,borderWidth:1,titleColor:'#e0e0ff',bodyColor:'#a0a0c0',
            callbacks:{label:function(c){ return ' Rs. '+c.raw.toFixed(0); }}}
        },
        scales:{
          x:{ticks:{color:'#7070a0',font:{size:10}},grid:{display:false}},
          y:{ticks:{color:'#7070a0',font:{size:10},callback:function(v){ return v>=1000?'Rs.'+(v/1000).toFixed(0)+'k':'Rs.'+v; }},grid:{color:'#2a2a4a'}}
        }
      }
    });
  }
  // Best sellers
  var itemMap={};
  db.invoices.forEach(function(inv){ inv.items.forEach(function(it){ if(!itemMap[it.name]) itemMap[it.name]={qty:0,rev:0}; itemMap[it.name].qty+=it.qty; itemMap[it.name].rev+=it.price*it.qty; }); });
  var sellers=Object.keys(itemMap).map(function(n){ return {name:n,qty:itemMap[n].qty,rev:itemMap[n].rev}; }).sort(function(a,b){ return b.rev-a.rev; }).slice(0,5);
  var bsEl=document.getElementById('an-bestsellers');
  if(bsEl) bsEl.innerHTML=sellers.length?sellers.map(function(s,i){ var pct=Math.round((s.rev/totalRev)*100)||0; return '<div style="margin-bottom:10px"><div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:3px"><span>'+(i+1)+'. '+s.name+'</span><span style="color:var(--primary)">Rs.'+s.rev.toFixed(0)+'</span></div><div class="pbar"><div class="pfill" style="width:'+pct+'%;background:var(--primary);transition:width 0.8s ease"></div></div></div>'; }).join(''):'<div class="empty">No sales yet</div>';
  var pmMap={};
  db.invoices.forEach(function(inv){ pmMap[inv.payment]=(pmMap[inv.payment]||0)+inv.total; });
  var pmEl=document.getElementById('an-payments');
  if(pmEl) pmEl.innerHTML=Object.keys(pmMap).length?Object.keys(pmMap).map(function(m){ var pct=Math.round((pmMap[m]/totalRev)*100)||0; return '<div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:8px;align-items:center"><span>'+m+'</span><div style="flex:1;margin:0 8px"><div class="pbar"><div class="pfill" style="width:'+pct+'%;background:var(--success);transition:width 0.8s ease"></div></div></div><span style="color:var(--success)">'+pct+'%</span></div>'; }).join(''):'<div class="empty">No data</div>';
  var catMap={};
  db.invoices.forEach(function(inv){ inv.items.forEach(function(it){ var p=db.products.find(function(x){ return x.id===it.id; }); var cat=p?p.category:'Other'; catMap[cat]=(catMap[cat]||0)+it.price*it.qty; }); });
  var catEl=document.getElementById('an-categories');
  if(catEl) catEl.innerHTML=Object.keys(catMap).length?Object.keys(catMap).map(function(c){ var pct=totalRev?Math.round((catMap[c]/totalRev)*100):0; return '<div style="margin-bottom:8px"><div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:3px"><span>'+c+'</span><span style="color:var(--warning)">'+pct+'%</span></div><div class="pbar"><div class="pfill" style="width:'+pct+'%;background:var(--warning);transition:width 0.8s ease"></div></div></div>'; }).join(''):'<div class="empty">No data</div>';
}

// =========== STOCK LOG ===========
function logStock(prodId, prodName, type, change, stockAfter, ref){
  if(!db.stockLog) db.stockLog=[];
  db.stockLog.push({ id:Date.now(), prodId:prodId, prodName:prodName, type:type, change:change, stockAfter:stockAfter, ref:ref||'', date:new Date().toLocaleString('en-GB') });
  saveDB();
}
function refreshStockLogFilter(){
  var sel=document.getElementById('sl-prod-filter'); if(!sel) return;
  sel.innerHTML='<option value="">All Products</option>'+db.products.map(function(p){ return '<option value="'+p.id+'">'+p.name+'</option>'; }).join('');
}
function renderStockLog(){
  if(!db.stockLog) db.stockLog=[];
  var filter=document.getElementById('sl-prod-filter')?document.getElementById('sl-prod-filter').value:'';
  var rows=db.stockLog.filter(function(l){ return filter?String(l.prodId)===filter:true; }).slice().reverse();
  var tb=document.getElementById('sl-tbl'); if(!tb) return;
  tb.innerHTML=rows.length?rows.map(function(l){
    var clr=l.change<0?'var(--danger)':'var(--success)';
    var icon=l.type==='Sale'?'ğŸ›’':l.type==='Purchase'?'ğŸ“¦':l.type==='Adjustment'?'âœï¸':'ğŸ”„';
    return '<tr><td style="font-size:11px;color:var(--muted)">'+l.date+'</td><td>'+l.prodName+'</td><td>'+icon+' '+l.type+'</td><td style="color:'+clr+';font-weight:700">'+(l.change>0?'+':'')+l.change+'</td><td>'+l.stockAfter+'</td><td style="font-size:11px;color:var(--muted)">'+l.ref+'</td></tr>';
  }).join(''):'<tr><td colspan="6" class="empty"><div class="ei">ğŸ“‹</div>No stock movements</td></tr>';
}

// =========== CREDIT SALES ===========
var crF='';
function setCrF(f,btn){
  crF=f;
  document.querySelectorAll('.cr-fb').forEach(function(b){ b.classList.remove('bp2'); b.classList.add('bo'); });
  if(btn){ btn.classList.remove('bo'); btn.classList.add('bp2'); }
  renderCredits();
}
function updateCrBadge(){
  var b=document.getElementById('crbadge');
  if(b){ var active=(db.credits||[]).filter(function(c){ return c.status!=='Paid'; }).length; b.textContent=active; }
}
function openCreditModal(){
  document.getElementById('cr-id').value='';
  document.getElementById('cr-cust').value='';
  document.getElementById('cr-phone').value='';
  document.getElementById('cr-nic').value='';
  document.getElementById('cr-item').value='';
  document.getElementById('cr-total').value='';
  document.getElementById('cr-down').value='0';
  document.getElementById('cr-inst').value='3';
  document.getElementById('cr-notes').value='';
  document.getElementById('cr-freq').value='monthly';
  var d=new Date(); d.setMonth(d.getMonth()+1);
  document.getElementById('cr-due').value=d.toISOString().split('T')[0];
  document.getElementById('cr-calc').innerHTML='â€”';
  openM('m-credit');
}
function calcCreditInstall(){
  var total=parseFloat(document.getElementById('cr-total').value)||0;
  var down=parseFloat(document.getElementById('cr-down').value)||0;
  var inst=parseInt(document.getElementById('cr-inst').value)||1;
  var balance=total-down;
  var perInst=balance>0?balance/inst:0;
  document.getElementById('cr-calc').innerHTML=
    '<b>Total:</b> Rs.'+total.toFixed(2)+' | <b>Down:</b> Rs.'+down.toFixed(2)+'<br>'+
    '<b>Balance:</b> Rs.'+balance.toFixed(2)+' | <b>Per Installment:</b> <span style="color:var(--primary);font-weight:700">Rs.'+perInst.toFixed(2)+'</span> Ã— '+inst;
}
function saveCredit(){
  if(!db.credits) db.credits=[];
  var id=document.getElementById('cr-id').value;
  var cust=document.getElementById('cr-cust').value.trim();
  var phone=document.getElementById('cr-phone').value.trim();
  var item=document.getElementById('cr-item').value.trim();
  var total=parseFloat(document.getElementById('cr-total').value)||0;
  if(!cust||!phone||!item||!total){ toast('âŒ Required fields fill à¶šà¶»à¶±à·Šà¶±','var(--danger)'); return; }
  var down=parseFloat(document.getElementById('cr-down').value)||0;
  var inst=parseInt(document.getElementById('cr-inst').value)||1;
  var freq=document.getElementById('cr-freq').value;
  var dueDate=document.getElementById('cr-due').value;
  var balance=total-down;
  var perInst=balance/inst;
  // Generate installment schedule
  var schedule=[];
  var d=new Date(dueDate);
  for(var i=0;i<inst;i++){
    schedule.push({ num:i+1, amount:perInst, dueDate:d.toISOString().split('T')[0], paid:false, paidDate:'', paidAmt:0 });
    if(freq==='monthly') d.setMonth(d.getMonth()+1); else d.setDate(d.getDate()+7);
  }
  var cr={ id:id?parseInt(id):Date.now(), customer:cust, phone:phone, nic:document.getElementById('cr-nic').value.trim(), item:item, total:total, down:down, balance:balance, perInst:perInst, instCount:inst, freq:freq, schedule:schedule, payments:[], status:'Active', date:new Date().toLocaleDateString('en-GB'), notes:document.getElementById('cr-notes').value.trim() };
  if(down>0) cr.payments.push({ id:Date.now(), amount:down, method:'Cash', date:cr.date, note:'Down Payment' });
  if(id){ var idx=db.credits.findIndex(function(x){ return x.id===cr.id; }); if(idx>=0) db.credits[idx]=cr; } else db.credits.push(cr);
  saveDB(); renderCredits(); updateCrBadge(); closeM('m-credit'); toast('âœ… Credit sale saved!');
}
function getCreditStatus(cr){
  var paid=(cr.payments||[]).reduce(function(s,p){ return s+p.amount; },0);
  if(paid>=cr.total) return 'Paid';
  // Check overdue
  var today=new Date(); today.setHours(0,0,0,0);
  var overdue=cr.schedule.some(function(s){ return !s.paid && new Date(s.dueDate)<today; });
  return overdue?'Overdue':'Active';
}
function renderCredits(){
  if(!db.credits) db.credits=[];
  var q=(document.getElementById('cr-q')?document.getElementById('cr-q').value:'').toLowerCase();
  var rows=db.credits.filter(function(c){
    var matchQ=q?(c.customer.toLowerCase().includes(q)||c.phone.includes(q)):true;
    if(!matchQ) return false;
    if(!crF) return true;
    return getCreditStatus(c)===crF;
  });
  var tb=document.getElementById('cr-tbl'); if(!tb) return;
  tb.innerHTML=rows.length?rows.slice().reverse().map(function(c){
    var paid=(c.payments||[]).reduce(function(s,p){ return s+p.amount; },0);
    var bal=c.total-paid;
    var st=getCreditStatus(c);
    var stClr=st==='Paid'?'bs':st==='Overdue'?'bd':'bw';
    var nextDue=c.schedule.find(function(s){ return !s.paid; });
    var nextStr=nextDue?nextDue.dueDate:'â€”';
    var pct=c.total>0?Math.min(100,paid/c.total*100):0;
    return '<tr><td><b>#'+String(c.id).slice(-4)+'</b></td><td>'+c.customer+'<br><small style="color:var(--muted)">'+c.phone+'</small></td><td>'+c.item+'</td><td>Rs.'+c.total.toFixed(2)+'</td><td style="color:var(--success)">Rs.'+paid.toFixed(2)+'<div class="pbar"><div class="pfill" style="width:'+pct+'%;background:'+(pct>=100?'var(--success)':'var(--primary)')+'"></div></div><small style="color:var(--muted)">'+pct.toFixed(0)+'%</small></td><td style="color:'+(bal>0?'var(--warning)':'var(--success)')+'">Rs.'+Math.max(0,bal).toFixed(2)+'</td><td style="font-size:11px">'+nextStr+'</td><td><span class="badge '+stClr+'">'+st+'</span></td><td style="white-space:nowrap"><button class="btn bs2 bsm" onclick="openCrPay('+c.id+')" style="margin-right:3px">ğŸ’µ Pay</button><button class="btn bd2 bsm" onclick="delCredit('+c.id+')">ğŸ—‘ï¸</button></td></tr>';
  }).join(''):'<tr><td colspan="9" class="empty"><div class="ei">ğŸ’³</div>No credit sales</td></tr>';
}
function openCrPay(id){
  var c=db.credits.find(function(x){ return x.id===id; }); if(!c) return;
  var paid=(c.payments||[]).reduce(function(s,p){ return s+p.amount; },0);
  var bal=c.total-paid;
  document.getElementById('crpay-id').value=id;
  document.getElementById('crpay-amt').value='';
  document.getElementById('crpay-date').value=new Date().toISOString().split('T')[0];
  document.getElementById('crpay-note').value='';
  document.getElementById('crpay-summary').innerHTML=
    '<b>'+c.customer+'</b> â€” '+c.item+'<br>Total: Rs.'+c.total.toFixed(2)+' | Paid: Rs.'+paid.toFixed(2)+' | <b style="color:var(--warning)">Balance: Rs.'+Math.max(0,bal).toFixed(2)+'</b><br>Per Installment: Rs.'+c.perInst.toFixed(2);
  openM('m-crpay');
}
function saveCrPayment(){
  var id=parseInt(document.getElementById('crpay-id').value);
  var c=db.credits.find(function(x){ return x.id===id; }); if(!c) return;
  var amt=parseFloat(document.getElementById('crpay-amt').value)||0;
  if(amt<=0){ toast('âŒ Amount enter à¶šà¶»à¶±à·Šà¶±','var(--danger)'); return; }
  if(!c.payments) c.payments=[];
  c.payments.push({ id:Date.now(), amount:amt, method:document.getElementById('crpay-method').value, date:document.getElementById('crpay-date').value, note:document.getElementById('crpay-note').value });
  // Mark installments as paid
  var paidTotal=(c.payments||[]).reduce(function(s,p){ return s+p.amount; },0);
  c.status=paidTotal>=c.total?'Paid':'Active';
  var remaining=paidTotal-c.down;
  c.schedule.forEach(function(s){ if(!s.paid && remaining>=s.amount){ s.paid=true; s.paidDate=new Date().toLocaleDateString('en-GB'); remaining-=s.amount; } });
  saveDB(); renderCredits(); updateCrBadge(); closeM('m-crpay');
  toast('âœ… Payment saved! '+(c.status==='Paid'?'ğŸ‰ Fully Paid!':''));
}
function delCredit(id){
  if(!confirm('Delete credit sale?')) return;
  db.credits=db.credits.filter(function(c){ return c.id!==id; });
  saveDB(); renderCredits(); updateCrBadge(); toast('ğŸ—‘ï¸ Deleted','var(--danger)');
}

// =========== SUPPLIERS ===========
function renderSuppliers(){
  if(!db.suppliers) db.suppliers=[];
  var q=(document.getElementById('sup-q')?document.getElementById('sup-q').value:'').toLowerCase();
  var rows=db.suppliers.filter(function(s){ return s.name.toLowerCase().includes(q)||(s.phone&&s.phone.includes(q)); });
  var tb=document.getElementById('sup-tbl'); if(!tb) return;
  tb.innerHTML=rows.length?rows.map(function(s){
    return '<tr><td><b>'+s.name+'</b></td><td>'+s.phone+'</td><td><span class="badge bp">'+s.category+'</span></td><td style="font-size:11px;color:var(--muted)">'+( s.notes||'â€”')+'</td><td><button class="btn bo bsm" onclick="editSupplier('+s.id+')" style="margin-right:3px">âœï¸</button><button class="btn bwa bsm" onclick="window.open(\'https://wa.me/94\'+\''+s.phone.replace(/^0/,'')+'\')">ğŸ’¬</button><button class="btn bd2 bsm" onclick="delSupplier('+s.id+')" style="margin-left:3px">ğŸ—‘ï¸</button></td></tr>';
  }).join(''):'<tr><td colspan="5" class="empty"><div class="ei">ğŸ­</div>No suppliers</td></tr>';
  renderPurchases();
}
function saveSupplier(){
  if(!db.suppliers) db.suppliers=[];
  var id=document.getElementById('sup-id').value;
  var s={ id:id?parseInt(id):Date.now(), name:document.getElementById('sup-name').value.trim(), phone:document.getElementById('sup-phone').value.trim(), email:document.getElementById('sup-email').value.trim(), category:document.getElementById('sup-cat').value, address:document.getElementById('sup-addr').value.trim(), notes:document.getElementById('sup-notes').value.trim() };
  if(!s.name||!s.phone){ toast('âŒ Name & Phone required','var(--danger)'); return; }
  if(id){ var i=db.suppliers.findIndex(function(x){ return x.id===s.id; }); if(i>=0) db.suppliers[i]=s; } else db.suppliers.push(s);
  saveDB(); renderSuppliers(); closeM('m-supplier'); toast('âœ… Supplier saved!');
}
function editSupplier(id){
  var s=db.suppliers.find(function(x){ return x.id===id; }); if(!s) return;
  document.getElementById('sup-id').value=s.id;
  document.getElementById('sup-name').value=s.name;
  document.getElementById('sup-phone').value=s.phone;
  document.getElementById('sup-email').value=s.email||'';
  document.getElementById('sup-cat').value=s.category;
  document.getElementById('sup-addr').value=s.address||'';
  document.getElementById('sup-notes').value=s.notes||'';
  openM('m-supplier');
}
function delSupplier(id){
  if(!confirm('Delete supplier?')) return;
  db.suppliers=db.suppliers.filter(function(s){ return s.id!==id; });
  saveDB(); renderSuppliers(); toast('ğŸ—‘ï¸ Deleted','var(--danger)');
}
function refreshPurchaseSupSel(){
  if(!db.suppliers) db.suppliers=[];
  var sel=document.getElementById('po-sup'); if(!sel) return;
  sel.innerHTML='<option value="">Select Supplier</option>'+db.suppliers.map(function(s){ return '<option value="'+s.id+'">'+s.name+'</option>'; }).join('');
}
function refreshPurchaseProdSel(){
  var sel=document.getElementById('po-prod'); if(!sel) return;
  sel.innerHTML='<option value="">Select Product</option>'+db.products.map(function(p){ return '<option value="'+p.id+'">'+p.name+'</option>'; }).join('');
}
function renderPurchases(){
  if(!db.purchases) db.purchases=[];
  var tb=document.getElementById('po-tbl'); if(!tb) return;
  tb.innerHTML=db.purchases.length?db.purchases.slice().reverse().map(function(p){
    var sup=db.suppliers?db.suppliers.find(function(s){ return s.id===p.supId; }):null;
    var stBadge=p.status==='Received'?'bs':p.status==='Cancelled'?'bd':'bi';
    return '<tr><td><b>#'+String(p.id).slice(-4)+'</b></td><td>'+(sup?sup.name:'â€”')+'</td><td>'+p.prodName+'</td><td>'+p.qty+'</td><td>Rs.'+(p.cost||0).toFixed(2)+'</td><td>'+p.date+'</td><td><span class="badge '+stBadge+'">'+p.status+'</span>'+(p.status==='Ordered'?'<button class="btn bs2 bsm" onclick="receivePurchase('+p.id+')" style="margin-left:4px">âœ… Receive</button>':'')+'</td></tr>';
  }).join(''):'<tr><td colspan="7" class="empty"><div class="ei">ğŸ“¦</div>No purchase orders</td></tr>';
}
function savePurchase(){
  if(!db.purchases) db.purchases=[];
  var supId=parseInt(document.getElementById('po-sup').value);
  var prodId=parseInt(document.getElementById('po-prod').value);
  var qty=parseInt(document.getElementById('po-qty').value)||0;
  if(!supId||!prodId||!qty){ toast('âŒ Supplier, Product, Qty required','var(--danger)'); return; }
  var prod=db.products.find(function(x){ return x.id===prodId; });
  var sup=db.suppliers?db.suppliers.find(function(x){ return x.id===supId; }):null;
  var po={ id:Date.now(), supId:supId, supName:sup?sup.name:'', prodId:prodId, prodName:prod?prod.name:'', qty:qty, cost:parseFloat(document.getElementById('po-cost').value)||0, date:document.getElementById('po-date').value||new Date().toLocaleDateString('en-GB'), status:document.getElementById('po-stat').value, notes:document.getElementById('po-notes').value.trim() };
  db.purchases.push(po);
  if(po.status==='Received' && prod){ prod.stock+=qty; logStock(prod.id, prod.name, 'Purchase', qty, prod.stock, 'PO-'+String(po.id).slice(-4)); }
  saveDB(); renderPurchases(); renderSuppliers(); closeM('m-purchase'); toast('âœ… Purchase order saved!');
}
function receivePurchase(id){
  if(!confirm('Stock receive à¶šà¶»à¶±à·Šà¶±à¶¯?')) return;
  var po=db.purchases.find(function(x){ return x.id===id; }); if(!po) return;
  po.status='Received';
  var prod=db.products.find(function(x){ return x.id===po.prodId; });
  if(prod){ prod.stock+=po.qty; logStock(prod.id, prod.name, 'Purchase', po.qty, prod.stock, 'PO-'+String(po.id).slice(-4)); }
  saveDB(); renderPurchases(); renderInv(); toast('âœ… Stock updated! +'+po.qty+' units');
}

// =========== CANVAS POLYFILL ===========
if(!CanvasRenderingContext2D.prototype.roundRect){
  CanvasRenderingContext2D.prototype.roundRect=function(x,y,w,h,r){
    this.beginPath(); this.moveTo(x+r,y); this.lineTo(x+w-r,y); this.arcTo(x+w,y,x+w,y+r,r); this.lineTo(x+w,y+h-r); this.arcTo(x+w,y+h,x+w-r,y+h,r); this.lineTo(x+r,y+h); this.arcTo(x,y+h,x,y+h-r,r); this.lineTo(x,y+r); this.arcTo(x,y,x+r,y,r); this.closePath(); return this;
  };
}

// =========== BARCODE SCANNER ===========
// =========== BARCODE SCANNER ENGINE ===========
var scanMode = 'pos';
var scanLastCode = '';
var scanLastTime = 0;
var _scanStream = null;
var _scanAnimFrame = null;
var _scanPhysicalTimer = null;

function openBarcodeScanner(){
  scanMode = 'pos';
  _startScanner('ğŸ›’ POS Mode â€” Cart add à¶šà¶»à¶±à·Šà¶± scan à¶šà¶»à¶±à·Šà¶±');
}
function openScannerForInventory(){
  scanMode = 'inventory';
  _startScanner('ğŸ“¦ Inventory Mode â€” Barcode fill à¶šà¶»à¶±à·Šà¶±');
}

function _startScanner(modeLabel){
  document.getElementById('scan-overlay').classList.add('open');
  document.getElementById('scan-result').textContent = '';
  document.getElementById('scan-result').style.color = 'var(--success)';
  document.getElementById('scan-manual').value = '';
  document.getElementById('scan-mode-label').textContent = modeLabel;
  scanLastCode = ''; scanLastTime = 0;

  // Focus manual input â€” physical scanner will type here
  setTimeout(function(){ var inp=document.getElementById('scan-manual'); if(inp) inp.focus(); }, 200);

  // Try camera
  if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia){
    navigator.mediaDevices.getUserMedia({
      video:{ facingMode:'environment', width:{ideal:1280}, height:{ideal:720} }
    }).then(function(stream){
      _scanStream = stream;
      var v = document.getElementById('scan-video');
      v.srcObject = stream;
      v.play();
      document.getElementById('scan-box-wrap').style.display = '';
      document.getElementById('scan-no-cam').style.display = 'none';
      // Use BarcodeDetector if available (Chrome Android/Desktop)
      if(typeof BarcodeDetector !== 'undefined'){
        _startBarcodeDetector(v);
      }
    }).catch(function(){
      _showNoCam();
    });
  } else {
    _showNoCam();
  }
}

function _showNoCam(){
  document.getElementById('scan-box-wrap').style.display = 'none';
  document.getElementById('scan-no-cam').style.display = 'block';
  setTimeout(function(){ var inp=document.getElementById('scan-manual'); if(inp) inp.focus(); }, 100);
}

function _startBarcodeDetector(video){
  var tryFormats = ['ean_13','ean_8','code_128','code_39','upc_a','upc_e','qr_code','codabar','code_93','itf'];
  BarcodeDetector.getSupportedFormats().then(function(supported){
    var use = tryFormats.filter(function(f){ return supported.indexOf(f)>=0; });
    var detector = new BarcodeDetector({ formats: use.length ? use : ['ean_13','code_128'] });
    function detect(){
      if(!_scanStream) return;
      detector.detect(video).then(function(codes){
        if(codes.length > 0) _handleScannedCode(codes[0].rawValue);
      }).catch(function(){});
      _scanAnimFrame = requestAnimationFrame(detect);
    }
    _scanAnimFrame = requestAnimationFrame(detect);
  }).catch(function(){
    // BarcodeDetector not working â€” physical scanner + manual only
  });
}

function _handleScannedCode(code){
  if(!code || !code.trim()) return;
  code = code.trim();
  var now = Date.now();
  if(code === scanLastCode && now - scanLastTime < 2000) return;
  scanLastCode = code; scanLastTime = now;

  var res = document.getElementById('scan-result');
  var box = document.getElementById('scan-box-wrap');

  function flash(color){
    if(box){ box.style.outline='3px solid '+(color||'var(--success)'); setTimeout(function(){ box.style.outline=''; },700); }
  }

  if(scanMode === 'inventory'){
    var existing = db.products.find(function(x){ return x.barcode === code; });
    if(existing){
      _fillProductForm(existing.name, existing.category, existing.price, existing.cost, existing.desc||'', code);
      res.style.color = 'var(--success)';
      res.textContent = 'âœ… Found: ' + existing.name;
      flash('var(--success)');
      setTimeout(function(){ closeBarcodeScanner(); }, 900);
      return;
    }
    _fillProductForm('', 'Other', '', '', '', code);
    res.style.color = 'var(--success)';
    res.textContent = 'âœ… Barcode set: ' + code;
    flash('var(--success)');
    setTimeout(function(){ closeBarcodeScanner(); }, 800);

  } else {
    // POS mode â€” match by barcode then name
    var p = db.products.find(function(x){ return x.barcode && x.barcode === code; });
    if(!p) p = db.products.find(function(x){ return x.name.toLowerCase() === code.toLowerCase() && x.stock > 0; });

    if(p && p.stock > 0){
      addToCart(p.id);
      res.style.color = 'var(--success)';
      res.textContent = 'âœ… ' + p.name + ' cart add à¶šà·…à·!';
      flash('var(--success)');
      document.getElementById('scan-manual').value = '';
    } else if(p){
      res.style.color = 'var(--danger)';
      res.textContent = 'âŒ Stock à¶±à·‘: ' + p.name;
      flash('var(--danger)');
    } else {
      res.style.color = 'var(--warning)';
      res.textContent = 'âš ï¸ Product à¶±à·‘ â€” ' + code;
    }
  }
}

// Physical barcode scanner auto-submit (types fast then Enter)
function onScanInput(inp){
  clearTimeout(_scanPhysicalTimer);
  _scanPhysicalTimer = setTimeout(function(){
    var val = inp.value.trim();
    // Auto-submit if looks like barcode: 6+ chars, no spaces
    if(val.length >= 6 && val.indexOf(' ') === -1){
      doManualScan();
    }
  }, 120);
}

function _fillProductForm(name, category, price, cost, desc, barcode){
  var el;
  el = document.getElementById('p-name'); if(el && name) el.value = name;
  el = document.getElementById('p-barcode'); if(el) el.value = barcode || '';
  el = document.getElementById('p-desc'); if(el && desc) el.value = desc;
  if(price){ el = document.getElementById('p-price'); if(el) el.value = price; }
  if(cost){ el = document.getElementById('p-cost'); if(el) el.value = cost; }
  if(category){
    el = document.getElementById('p-cat');
    if(el){
      var opts = ['Phone','Accessories','Repair Part','Design Service','Other'];
      var match = opts.find(function(o){ return o.toLowerCase() === category.toLowerCase(); });
      if(match) el.value = match;
    }
  }
  var modal = document.getElementById('m-prod');
  if(modal && !modal.classList.contains('open')) openM('m-prod');
}

function closeBarcodeScanner(){
  document.getElementById('scan-overlay').classList.remove('open');
  if(_scanStream){ _scanStream.getTracks().forEach(function(t){ t.stop(); }); _scanStream = null; }
  if(_scanAnimFrame){ cancelAnimationFrame(_scanAnimFrame); _scanAnimFrame = null; }
  clearTimeout(_scanPhysicalTimer);
}

function doManualScan(){
  var q = document.getElementById('scan-manual').value.trim();
  if(!q) return;
  document.getElementById('scan-manual').value = '';
  _handleScannedCode(q);
}



// =========== THERMAL RECEIPT ===========
function showThermalReceipt(invId){
  var inv=db.invoices.find(function(i){ return i.id===invId; }); if(!inv) return;
  var s=db.settings;
  var lines=inv.items.map(function(it){ var nm=it.name.length>16?it.name.slice(0,14)+'..':it.name; var tot=(it.price*it.qty).toFixed(2); var sp=20-nm.length-tot.length; return nm+(sp>0?' '.repeat(sp):' ')+tot; }).join('<br>');
  document.getElementById('thermal-content').innerHTML=
    '<h2>'+s.shopName+'</h2>'+
    '<div style="text-align:center;font-size:10px">'+(s.phone||'')+'</div>'+
    '<div class="tline"></div>'+
    '<div class="trow"><span>'+inv.invNo+'</span><span>'+inv.date+'</span></div>'+
    '<div class="trow"><span>Customer:</span><span>'+inv.customer+'</span></div>'+
    '<div class="tline"></div>'+
    '<div style="font-size:10px">ITEM                 AMT<br><span style="border-top:1px solid #000;display:block"></span></div>'+
    '<div style="font-size:10px;white-space:pre;font-family:monospace">'+lines+'</div>'+
    '<div class="tline"></div>'+
    '<div class="trow"><span>Subtotal:</span><span>Rs.'+inv.subtotal.toFixed(2)+'</span></div>'+
    (inv.discount?'<div class="trow"><span>Discount:</span><span>-Rs.'+inv.discount.toFixed(2)+'</span></div>':'')+
    (inv.tax?'<div class="trow"><span>Tax:</span><span>Rs.'+inv.tax.toFixed(2)+'</span></div>':'')+
    '<div class="tline"></div>'+
    '<div class="trow" style="font-size:14px;font-weight:700"><span>TOTAL</span><span>Rs.'+inv.total.toFixed(2)+'</span></div>'+
    '<div class="trow"><span>Payment:</span><span>'+inv.payment+'</span></div>'+
    '<div class="tline"></div>'+
    '<div style="text-align:center;font-size:10px">'+s.note+'</div>';
  openM('m-thermal');
}

init();
</script>
</body>
</html>
